<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
    <a href="14.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="16.html">下一页</a>
      <br><a href='cat.html'>购物车简化</a>
<title>Django-4.0-Day15</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="d1ej" id="django-40-day15">Django-4.0-Day15</h1><div class="md-section-divider"></div><h2 data-anchor-id="tdtz" id="django"><code>django</code></h2><div class="md-section-divider"></div><h2 data-anchor-id="b7bw" id="01保存到购物车接口编写">01_保存到购物车接口编写</h2><ul data-anchor-id="yten">
<li><p>序列化器</p>

<ol><li>基本校验：数据类型和值</li>
<li>校验商品是否存在</li>
<li>校验库存是否充足</li></ol>

<p>cart.serializers.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CartSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">Serializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="str">"""</span></code></li><li class="L2"><code><span class="str">购物车参数</span></code></li><li class="L3"><code><span class="str">"""</span></code></li><li class="L4"><code><span class="pln">sku_id </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">IntegerField</span><span class="pun">(</span><span class="pln">min_value</span><span class="pun">=</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">count </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">IntegerField</span><span class="pun">(</span><span class="pln">min_value</span><span class="pun">=</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">selected </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">BooleanField</span><span class="pun">(</span><span class="kwd">default</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="kwd">def</span><span class="pln"> validate</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> attrs</span><span class="pun">):</span></code></li><li class="L9"><code><span class="pln">    sku_id </span><span class="pun">=</span><span class="pln"> attrs</span><span class="pun">[</span><span class="str">'sku_id'</span><span class="pun">]</span></code></li><li class="L0"><code><span class="pln">    </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">        sku </span><span class="pun">=</span><span class="pln"> SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">id</span><span class="pun">=</span><span class="pln">sku_id</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">except</span><span class="pln"> SKU</span><span class="pun">.</span><span class="typ">DoesNotExist</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'商品不存在'</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">    </span><span class="com"># 判断库存</span></code></li><li class="L6"><code><span class="pln">    count </span><span class="pun">=</span><span class="pln"> attrs</span><span class="pun">[</span><span class="str">'count'</span><span class="pun">]</span></code></li><li class="L7"><code><span class="pln">    </span><span class="kwd">if</span><span class="pln"> sku</span><span class="pun">.</span><span class="pln">stock </span><span class="pun">&lt;</span><span class="pln"> count</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'商品库存不足'</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> attrs</span></code></li></ol></pre></li>
<li><p>视图</p>

<ol><li>使用序列化器校验数据</li>
<li>判断用户是否登录</li>
<li>进行redis操作或者cookie操作 <br>
<ol><li>获取整个购物车信息(cookie需要，redis直接通过命令操作)</li>
<li>增加sku_id对应的数量</li>
<li>处理勾选状态</li></ol></li>
<li>返回响应(如果是cookie，还需要把cookie添加到响应中) (sku_id,count,selected)</li></ol>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CartView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> post</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        </span><span class="str">"""保存购物车数据"""</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 检查前端发送的数据是否正确</span></code></li><li class="L5"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CartSerializer</span><span class="pun">(</span><span class="pln">data</span><span class="pun">=</span><span class="pln">request</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        serializer</span><span class="pun">.</span><span class="pln">is_valid</span><span class="pun">(</span><span class="pln">raise_exception</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        sku_id </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">validated_data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'sku_id'</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        count </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">validated_data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'count'</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        selected </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">validated_data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'selected'</span><span class="pun">)</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 判断用户是否登录</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">user</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">Exception</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">            </span><span class="com"># 前端携带了错误的 JWT  用户未登录</span></code></li><li class="L7"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">None</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 保存购物车数据</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> user </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> </span><span class="kwd">None</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">is_authenticated</span><span class="pun">():</span></code></li><li class="L1"><code><span class="pln">            </span><span class="com"># 用户已登录 保存到redis中</span></code></li><li class="L2"><code><span class="pln">            redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">            pl </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">pipeline</span><span class="pun">()</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">            </span><span class="com"># 购物车数据  hash</span></code></li><li class="L6"><code><span class="pln">            pl</span><span class="pun">.</span><span class="pln">hincrby</span><span class="pun">(</span><span class="str">'cart_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> sku_id</span><span class="pun">,</span><span class="pln"> count</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">            </span><span class="com"># 勾选</span></code></li><li class="L9"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> selected</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">                pl</span><span class="pun">.</span><span class="pln">sadd</span><span class="pun">(</span><span class="str">'cart_selected_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln">  sku_id</span><span class="pun">)</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">            pl</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">()</span></code></li><li class="L3"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">serializer</span><span class="pun">.</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_201_CREATED</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">            </span><span class="com"># 用户未登录，保存到cookie中</span></code></li><li class="L6"><code><span class="pln">            </span><span class="com"># 尝试从cookie中读取购物车数据</span></code></li><li class="L7"><code><span class="pln">            cart_str </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">COOKIES</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> cart_str</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">                cart_dict </span><span class="pun">=</span><span class="pln"> pickle</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">base64</span><span class="pun">.</span><span class="pln">b64decode</span><span class="pun">(</span><span class="pln">cart_str</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">()))</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">                cart_dict </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">            </span><span class="com"># 如果有相同商品，求和</span></code></li><li class="L5"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> sku_id </span><span class="kwd">in</span><span class="pln"> cart_dict</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">                origin_count </span><span class="pun">=</span><span class="pln"> cart_dict</span><span class="pun">[</span><span class="pln">sku_id</span><span class="pun">][</span><span class="str">'count'</span><span class="pun">]</span></code></li><li class="L7"><code><span class="pln">                count </span><span class="pun">+=</span><span class="pln"> origin_count</span></code></li><li class="L8"><code><span class="pln">            cart_dict</span><span class="pun">[</span><span class="pln">sku_id</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">                </span><span class="str">'count'</span><span class="pun">:</span><span class="pln"> count</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">                </span><span class="str">'selected'</span><span class="pun">:</span><span class="pln"> selected</span></code></li><li class="L1"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">            cookie_cart </span><span class="pun">=</span><span class="pln"> base64</span><span class="pun">.</span><span class="pln">b64encode</span><span class="pun">(</span><span class="pln">pickle</span><span class="pun">.</span><span class="pln">dumps</span><span class="pun">(</span><span class="pln">cart_dict</span><span class="pun">)).</span><span class="pln">decode</span><span class="pun">()</span></code></li><li class="L4"><code><span class="pln">            </span><span class="com"># 返回</span></code></li><li class="L5"><code><span class="pln">            response </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">serializer</span><span class="pun">.</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_201_CREATED</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">            response</span><span class="pun">.</span><span class="pln">set_cookie</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">,</span><span class="pln"> cookie_cart</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> response</span></code></li></ol></pre></li>
<li><p>注意 <br>
cookie 中存储的结构是 {id:{"count":count,"selected":selected}}</p></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="dn2a" id="02查询购物车数据">02_查询购物车数据</h2><p data-anchor-id="4f2m">这个接口需要用于显示购物车，包含商品信息，所以还需要返回相应的商品信息</p><ul data-anchor-id="5feb">
<li><p>设计</p>

<ul><li>请求:GET /cart/</li>
<li>响应  <br>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">{</span><span class="str">"id"</span><span class="pun">:</span><span class="pln">id</span><span class="pun">,</span><span class="str">"count"</span><span class="pun">:</span><span class="pln">count</span><span class="pun">,</span><span class="str">"selected"</span><span class="pun">:</span><span class="pln">selected</span><span class="pun">,</span><span class="str">"name"</span><span class="pun">:</span><span class="pln">name</span><span class="pun">,</span><span class="str">"default_image_url"</span><span class="pun">:</span><span class="pln">default_image_url</span><span class="pun">,</span><span class="str">"price"</span><span class="pun">:</span><span class="pln">price</span><span class="pun">}</span><span class="pln"> </span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">    </span><span class="pun">{</span><span class="str">"id"</span><span class="pun">:</span><span class="pln">id</span><span class="pun">,</span><span class="str">"count"</span><span class="pun">:</span><span class="pln">count</span><span class="pun">,</span><span class="str">"selected"</span><span class="pun">:</span><span class="pln">selected</span><span class="pun">,</span><span class="str">"name"</span><span class="pun">:</span><span class="pln">name</span><span class="pun">,</span><span class="str">"default_image_url"</span><span class="pun">:</span><span class="pln">default_image_url</span><span class="pun">,</span><span class="str">"price"</span><span class="pun">:</span><span class="pln">price</span><span class="pun">}</span><span class="pln"> </span><span class="pun">,</span></code></li><li class="L3"><code><span class="pun">]</span></code></li></ol></pre></li></ul></li>
<li><p>实现 </p>

<ul><li><p>cart.serializers.py <br>
用来返回响应，不需要校验 <br>
get请求只是获取信息，没有需要校验的 <br>
而且之前保存数据的时候已经校验过了</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CartSKUSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">ModelSerializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    count </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">IntegerField</span><span class="pun">()</span></code></li><li class="L2"><code><span class="pln">    selected </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">BooleanField</span><span class="pun">()</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">        model </span><span class="pun">=</span><span class="pln"> SKU</span></code></li><li class="L6"><code><span class="pln">        fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'name'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'default_image_url'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'price'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'count'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'selected'</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>cart.view.py</p>

<ol><li>通过redis 或者cookie，拿到原始数据</li>
<li>组成 如下形式的字典 <br>
<code>{id:{"count":count,"selected":selected} ,id:{"count":count,"selected":selected}}</code></li>
<li>模型类查询出所有对应的商品 (in  keys )</li>
<li>把 数量和选中信息附加到对象上</li>
<li>使用序列化器返回响应</li></ol>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CartView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">        </span><span class="str">"""查询购物车数据"""</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 判断用户是否登录</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">user</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">Exception</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">            </span><span class="com"># 前端携带了错误的 JWT  用户未登录</span></code></li><li class="L8"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">None</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> user </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> </span><span class="kwd">None</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">is_authenticated</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            </span><span class="com"># 如果用户登录，从redis查询</span></code></li><li class="L2"><code><span class="pln">            redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">            redis_cart </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">hgetall</span><span class="pun">(</span><span class="str">"cart_%s"</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">            cart_selected </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">smembers</span><span class="pun">(</span><span class="str">'cart_selected_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">            </span><span class="com"># 将redis中的数据进行整合，形成一个字典，与cookie中解读的一致，方便数据库查询</span></code></li><li class="L7"><code><span class="pln">            cart_dict </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">for</span><span class="pln"> sku_id</span><span class="pun">,</span><span class="pln"> count </span><span class="kwd">in</span><span class="pln"> redis_cart</span><span class="pun">.</span><span class="pln">items</span><span class="pun">():</span></code></li><li class="L9"><code><span class="pln">                cart_dict</span><span class="pun">[</span><span class="kwd">int</span><span class="pun">(</span><span class="pln">sku_id</span><span class="pun">)]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">                    </span><span class="str">'count'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">(</span><span class="pln">count</span><span class="pun">),</span></code></li><li class="L1"><code><span class="pln">                    </span><span class="str">'selected'</span><span class="pun">:</span><span class="pln"> sku_id </span><span class="kwd">in</span><span class="pln"> cart_selected</span></code></li><li class="L2"><code><span class="pln">                </span><span class="pun">}</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            </span><span class="com"># 如果用户未登录，从cookie中查询</span></code></li><li class="L5"><code><span class="pln">            cart_str </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">COOKIES</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> cart_str</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">                cart_dict </span><span class="pun">=</span><span class="pln"> pickle</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">base64</span><span class="pun">.</span><span class="pln">b64decode</span><span class="pun">(</span><span class="pln">cart_str</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">()))</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">                cart_dict </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></code></li><li class="L0"><code><span class="pln">        sku_id_list </span><span class="pun">=</span><span class="pln"> cart_dict</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">()</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 数据库查询sku对象</span></code></li><li class="L3"><code><span class="pln">        sku_obj_list </span><span class="pun">=</span><span class="pln"> SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">id__in</span><span class="pun">=</span><span class="pln">sku_id_list</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 向结果集中补充count 和 selected</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">for</span><span class="pln"> sku </span><span class="kwd">in</span><span class="pln"> sku_obj_list</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">            sku</span><span class="pun">.</span><span class="pln">count </span><span class="pun">=</span><span class="pln"> cart_dict</span><span class="pun">[</span><span class="pln">sku</span><span class="pun">.</span><span class="pln">id</span><span class="pun">][</span><span class="str">'count'</span><span class="pun">]</span></code></li><li class="L7"><code><span class="pln">            sku</span><span class="pun">.</span><span class="pln">selected </span><span class="pun">=</span><span class="pln"> cart_dict</span><span class="pun">[</span><span class="pln">sku</span><span class="pun">.</span><span class="pln">id</span><span class="pun">][</span><span class="str">'selected'</span><span class="pun">]</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 序列化返回</span></code></li><li class="L0"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CartSKUSerializer</span><span class="pun">(</span><span class="pln">sku_obj_list</span><span class="pun">,</span><span class="pln"> many</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">serializer</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li></ol></pre></li></ul></li>
<li>注意 <br>
<ol><li>redis中存的数据是bytes，需要通过int转为整数</li>
<li>在drf自带的页面测试的时候因为没有添加 Authorization头，所以测不到 <br>
需要通过postman进行测试</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="vufs" id="03修改数据幂等性说明">03_修改数据幂等性说明</h2><ul data-anchor-id="g68y">
<li><p>幂等性 <br>
多次执行所产生的影响均与一次执行的影响相同，称为幂等</p></li>
<li><p>rest风格中</p>

<ul><li>幂等的 <br>
get <br>
put <br>
patch</li>
<li>非幂等的 <br>
post <br>
delete</li></ul></li>
<li>对应项目概念 <br>
修改：是修改整个数量，而不是数量的加减</li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="0thw" id="04ubuntu中使用定时任务的解决">04_ubuntu中使用定时任务的解决</h2><ul data-anchor-id="gkbd">
<li>问题 <br>
通过定时任务生成首页，没有内容</li>
<li><p>原因</p>

<ol><li>定时任务执行失败</li>
<li>根本原因是 ubuntu的语言支持</li></ol></li>
<li><p>解决</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com"># mac没问题，但ubuntu可能有问题</span></code></li><li class="L1"><code><span class="pln"> </span><span class="com"># CRONTAB_COMMAND_PREFIX = 'LANG_ALL=zh_cn.UTF-8'</span></code></li><li class="L2"><code><span class="pln"> </span><span class="com"># mac和ubuntu都没有问题</span></code></li><li class="L3"><code><span class="pln">CRONTAB_COMMAND_PREFIX </span><span class="pun">=</span><span class="pln"> </span><span class="str">'LANG_ALL=zh_cn.UTF-8'</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="ulvw" id="05购物车修改">05_购物车修改</h2><ul data-anchor-id="8woh">
<li><p>后端</p>

<ul><li>设计 <br>
<ul><li>请求方式: PUT /cart/   请求体 {"sku_id":,"count":,"selected":} selected为可选字段</li>
<li>响应 数据: {"sku_id":,"count":,"selected":}</li></ul></li>
<li><p>实现</p>

<ol><li>校验数据，判断登录 (同上)</li>
<li>更新数量，处理勾选</li>
<li>返回响应(未登录还需要添加cookie)</li></ol>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CartView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> put</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">            </span><span class="com"># 检查前端发送的数据是否正确</span></code></li><li class="L3"><code><span class="pln">            serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CartSerializer</span><span class="pun">(</span><span class="pln">data</span><span class="pun">=</span><span class="pln">request</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">            serializer</span><span class="pun">.</span><span class="pln">is_valid</span><span class="pun">(</span><span class="pln">raise_exception</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">            sku_id </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">validated_data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'sku_id'</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">            count </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">validated_data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'count'</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">            selected </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">validated_data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'selected'</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">            </span><span class="com"># 判断用户是否登录</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">                user </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">user</span></code></li><li class="L3"><code><span class="pln">            </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">Exception</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">                </span><span class="com"># 前端携带了错误的 JWT  用户未登录</span></code></li><li class="L5"><code><span class="pln">                user </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">None</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> user </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> </span><span class="kwd">None</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">is_authenticated</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">                </span><span class="com"># 如果用户登录，修改redis数据</span></code></li><li class="L9"><code><span class="pln">                redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">                pl </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">pipeline</span><span class="pun">()</span></code></li><li class="L1"><code><span class="pln">                pl</span><span class="pun">.</span><span class="pln">hset</span><span class="pun">(</span><span class="str">'cart_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> sku_id</span><span class="pun">,</span><span class="pln"> count</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">                </span><span class="kwd">if</span><span class="pln"> selected</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">                    </span><span class="com"># 勾选增加记录</span></code></li><li class="L4"><code><span class="pln">                    pl</span><span class="pun">.</span><span class="pln">sadd</span><span class="pun">(</span><span class="str">'cart_selected_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> sku_id</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">                </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">                    </span><span class="com"># 未勾选 删除记录</span></code></li><li class="L7"><code><span class="pln">                    pl</span><span class="pun">.</span><span class="pln">srem</span><span class="pun">(</span><span class="str">'cart_selected_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> sku_id</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">                pl</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">()</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">                </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">serializer</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">                </span><span class="com"># 如果用户未登录，修改cookie数据</span></code></li><li class="L4"><code><span class="pln">                cart_str </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">COOKIES</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">                </span><span class="kwd">if</span><span class="pln"> cart_str</span><span class="pun">:</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">                    cart_dict </span><span class="pun">=</span><span class="pln"> pickle</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">base64</span><span class="pun">.</span><span class="pln">b64decode</span><span class="pun">(</span><span class="pln">cart_str</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">()))</span></code></li><li class="L9"><code><span class="pln">                </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">                    cart_dict </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">                </span><span class="kwd">if</span><span class="pln"> sku_id </span><span class="kwd">in</span><span class="pln"> cart_dict</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">                    cart_dict</span><span class="pun">[</span><span class="pln">sku_id</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">                        </span><span class="str">'count'</span><span class="pun">:</span><span class="pln"> count</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">                        </span><span class="str">'selected'</span><span class="pun">:</span><span class="pln"> selected</span></code></li><li class="L6"><code><span class="pln">                    </span><span class="pun">}</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">                cookie_cart </span><span class="pun">=</span><span class="pln"> base64</span><span class="pun">.</span><span class="pln">b64encode</span><span class="pun">(</span><span class="pln">pickle</span><span class="pun">.</span><span class="pln">dumps</span><span class="pun">(</span><span class="pln">cart_dict</span><span class="pun">)).</span><span class="pln">decode</span><span class="pun">()</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">                </span><span class="com"># 返回</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">                response </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">serializer</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">                response</span><span class="pun">.</span><span class="pln">set_cookie</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">,</span><span class="pln"> cookie_cart</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">                </span><span class="kwd">return</span><span class="pln"> response</span></code></li></ol></pre></li></ul></li>
<li><p>前端实现</p>

<ol><li>修改数量，发送商品id和数量</li>
<li>修改勾选，发送商品id、数量和勾选状态</li></ol></li>
<li><p>注意 <br>
使用redis管道 记得进行执行</p></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="bzpx" id="06购物车删除">06_购物车删除</h2><ul data-anchor-id="vaxh">
<li><p>后端</p>

<ul><li>设计 <br>
<ul><li>请求 DELETE /cart/    请求体中包含 sku—_id</li>
<li>响应 成功无响应体</li></ul></li>
<li><p>实现</p>

<ul><li><p>cart.serializers.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CartDeleteSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">Serializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    sku_id </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">IntegerField</span><span class="pun">(</span><span class="pln">min_value</span><span class="pun">=</span><span class="lit">1</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate_sku_id</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">            sku </span><span class="pun">=</span><span class="pln"> SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">id</span><span class="pun">=</span><span class="pln">value</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> SKU</span><span class="pun">.</span><span class="typ">DoesNotExist</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'商品不存在'</span><span class="pun">)</span></code></li><li class="L8"><code></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> value</span></code></li></ol></pre></li>
<li><p>cart/views.py</p>

<ol><li>校验商品id是否存在</li>
<li>判断用户是否登录</li>
<li>拿到cookie或者是redis</li>
<li>根据id删除记录</li>
<li>返回响应，无响应体 (未登录还需要添加cookie)</li></ol>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CartView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">   </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">delete</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">        </span><span class="str">"""删除"""</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 检查参数sku_id</span></code></li><li class="L4"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CartDeleteSerializer</span><span class="pun">(</span><span class="pln">data</span><span class="pun">=</span><span class="pln">request</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">        serializer</span><span class="pun">.</span><span class="pln">is_valid</span><span class="pun">(</span><span class="pln">raise_exception</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        sku_id </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">validated_data</span><span class="pun">[</span><span class="str">'sku_id'</span><span class="pun">]</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 判断用户是否登录</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">user</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">Exception</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">            </span><span class="com"># 前端携带了错误的 JWT  用户未登录</span></code></li><li class="L3"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">None</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> user </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> </span><span class="kwd">None</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">is_authenticated</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">            </span><span class="com"># 如果用户登录，修改redis数据</span></code></li><li class="L7"><code><span class="pln">            redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">            pl </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">pipeline</span><span class="pun">()</span></code></li><li class="L9"><code><span class="pln">            pl</span><span class="pun">.</span><span class="pln">hdel</span><span class="pun">(</span><span class="str">'cart_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> sku_id</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">            pl</span><span class="pun">.</span><span class="pln">srem</span><span class="pun">(</span><span class="str">'cart_selected_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> sku_id</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">            pl</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">()</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_204_NO_CONTENT</span><span class="pun">)</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">            </span><span class="com"># cookie</span></code></li><li class="L6"><code><span class="pln">            cart_str </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">COOKIES</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> cart_str</span><span class="pun">:</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">                cart_dict </span><span class="pun">=</span><span class="pln"> pickle</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">base64</span><span class="pun">.</span><span class="pln">b64decode</span><span class="pun">(</span><span class="pln">cart_str</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">()))</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">                cart_dict </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">            response </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">serializer</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> sku_id </span><span class="kwd">in</span><span class="pln"> cart_dict</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">                </span><span class="com"># 删除字典的键值对</span></code></li><li class="L8"><code><span class="pln">                </span><span class="kwd">del</span><span class="pln"> cart_dict</span><span class="pun">[</span><span class="pln">sku_id</span><span class="pun">]</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">                cookie_cart </span><span class="pun">=</span><span class="pln"> base64</span><span class="pun">.</span><span class="pln">b64encode</span><span class="pun">(</span><span class="pln">pickle</span><span class="pun">.</span><span class="pln">dumps</span><span class="pun">(</span><span class="pln">cart_dict</span><span class="pun">)).</span><span class="pln">decode</span><span class="pun">()</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">                response</span><span class="pun">.</span><span class="pln">set_cookie</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">,</span><span class="pln"> cookie_cart</span><span class="pun">)</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> response</span></code></li></ol></pre></li></ul></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="544g" id="07合并购物车逻辑1">07_合并购物车逻辑_1</h2><div class="md-section-divider"></div><h2 data-anchor-id="keak" id="08合并购物车逻辑2">08_合并购物车逻辑_2</h2><p data-anchor-id="8yxt">我们允许未登录用户添加购物车，用户自身也有购物车。 <br>
那么登录的时候，需要把购物车进行合并。</p><ul data-anchor-id="8jd2">
<li><p>合并有三种情况</p>

<ol><li>cookie中的商品id和 redis中的商品idid完全不一样</li>
<li>cookie中的商品id和 redis中的商品id完全一样</li>
<li>cookie中的商品id和 redis中的商品id有一样的，也有不一样的</li></ol></li>
<li><p>对于重复商品合并的两种策略</p>

<ol><li>数量累加</li>
<li>数量覆盖</li></ol></li>
</ul><p data-anchor-id="efs7">我们选取了数量的覆盖，因为以新覆盖旧的。而且大多数时候，用户一般会买一件商品。</p><ul data-anchor-id="ebbr">
<li><p>代码实现 <br>
购物车数据如何存储的是有cart应用维护的，而合并是发生在登录的时候(user应用)。 <br>
所以最好在cart应用中定义一个公共函数，让其他应用在使用的时候调用</p>

<ul><li><p>要处理的逻辑</p>

<ol><li>拿到cookie中的数据 </li>
<li>拿到redis中的数据(需要bytes转int)</li>
<li>合并 (数量 和 勾选)</li>
<li>保存到redis中</li>
<li>删除cookie</li></ol></li>
<li><p>代码实现 <br>
以上步骤的实现 需要</p>

<ol><li>request <br>
获得cookie</li>
<li>user <br>
获得user.id 才能从redis中拿数据</li>
<li>response <br>
删除cookie</li></ol>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">def</span><span class="pln"> merge_cart_cookie_to_redis</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> response</span><span class="pun">,</span><span class="pln"> user</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    合并购物车，cookie保存到redis中</span></code></li><li class="L3"><code><span class="str">    :return: </span></code></li><li class="L4"><code><span class="str">    """</span></code></li><li class="L5"><code><span class="pln">    </span><span class="com">#1 从cookie中取出购物车数据</span></code></li><li class="L6"><code><span class="pln">    cart_str </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">COOKIES</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com"># 如果cookie中没有购物车，无需合并，直接返回</span></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> cart_str</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> response</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">    cookie_cart </span><span class="pun">=</span><span class="pln"> pickle</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">base64</span><span class="pun">.</span><span class="pln">b64decode</span><span class="pun">(</span><span class="pln">cart_str</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">()))</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    </span><span class="com">#2 从redis中取出购物车数据</span></code></li><li class="L4"><code><span class="pln">    redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    cart_redis </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">hgetall</span><span class="pun">(</span><span class="str">'cart_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">    </span><span class="com"># 把redis取出的字典的键值对数据类型 转换为int</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    </span><span class="com">#3 合并</span></code></li><li class="L9"><code><span class="pln">    cart </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></code></li><li class="L0"><code><span class="pln">    </span><span class="kwd">for</span><span class="pln"> sku_id</span><span class="pun">,</span><span class="pln"> count </span><span class="kwd">in</span><span class="pln"> cart_redis</span><span class="pun">.</span><span class="pln">items</span><span class="pun">():</span></code></li><li class="L1"><code><span class="pln">        cart</span><span class="pun">[</span><span class="kwd">int</span><span class="pun">(</span><span class="pln">sku_id</span><span class="pun">)]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">(</span><span class="pln">count</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    selected_sku_id_list </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[]</span></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">for</span><span class="pln"> sku_id</span><span class="pun">,</span><span class="pln"> selected_count_dict </span><span class="kwd">in</span><span class="pln"> cookie_cart</span><span class="pun">.</span><span class="pln">items</span><span class="pun">():</span></code></li><li class="L5"><code><span class="pln">        </span><span class="com"># 如果redis购物车中原有商品数据，数量覆盖，如果没有，新添记录</span></code></li><li class="L6"><code><span class="pln">        cart</span><span class="pun">[</span><span class="pln">sku_id</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> selected_count_dict</span><span class="pun">[</span><span class="str">'count'</span><span class="pun">]</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 处理勾选状态，</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> selected_count_dict</span><span class="pun">[</span><span class="str">'selected'</span><span class="pun">]:</span></code></li><li class="L0"><code><span class="pln">            selected_sku_id_list</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="pln">sku_id</span><span class="pun">)</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">    </span><span class="com">#4 将cookie的购物车合并到redis中</span></code></li><li class="L3"><code><span class="pln">    pl </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">pipeline</span><span class="pun">()</span></code></li><li class="L4"><code><span class="pln">    pl</span><span class="pun">.</span><span class="pln">hmset</span><span class="pun">(</span><span class="str">'cart_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> cart</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">    pl</span><span class="pun">.</span><span class="pln">sadd</span><span class="pun">(</span><span class="str">'cart_selected_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">selected_sku_id_list</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    pl</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">()</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">    </span><span class="com">#5 清除cookie中的购物车数据</span></code></li><li class="L1"><code><span class="pln">    response</span><span class="pun">.</span><span class="pln">delete_cookie</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> response</span></code></li></ol></pre></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="doyo" id="09修改登录逻辑增加合并购物车">09_修改登录逻辑增加合并购物车</h2><ul data-anchor-id="vj4l">
<li><p>思路 <br>
之前的登录校验是交给 处理的，现在我们要进行<strong>额外</strong>的处理了 <br>
发现我们用的也是视图 <br>
就可以通过继承，重写方法实现</p></li>
<li><p>代码实现</p>

<ul><li><p>users.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">UserAuthorizationView</span><span class="pun">(</span><span class="typ">ObtainJSONWebToken</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> post</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 调用jwt扩展的方法，对用户登录的数据进行验证</span></code></li><li class="L3"><code><span class="pln">        response </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">super</span><span class="pun">().</span><span class="pln">post</span><span class="pun">(</span><span class="pln">request</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">        </span><span class="com"># 如果用户登录成功，进行购物车数据合并</span></code></li><li class="L6"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">get_serializer</span><span class="pun">(</span><span class="pln">data</span><span class="pun">=</span><span class="pln">request</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">is_valid</span><span class="pun">():</span></code></li><li class="L8"><code><span class="pln">            </span><span class="com"># 表示用户登录成功</span></code></li><li class="L9"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">validated_data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">"user"</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">            </span><span class="com"># 合并购物车</span></code></li><li class="L1"><code><span class="pln">            response </span><span class="pun">=</span><span class="pln"> merge_cart_cookie_to_redis</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> response</span><span class="pun">,</span><span class="pln"> user</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> response</span></code></li></ol></pre></li>
<li><p>users.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># url(r'^authorizations/$', obtain_jwt_token),  # 登录，获取JWT token</span></code></li><li class="L2"><code><span class="pln">            url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^authorizations/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">UserAuthorizationView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span><span class="pln">  </span><span class="com"># 登录，获取JWT token</span></code></li><li class="L3"><code><span class="pun">]</span></code></li></ol></pre></li></ul></li>
<li><p>注意 <br>
前端在发起请求的时候 要添加<code>withCredentials: true</code>选项，跨域的时候发送cookie</p></li>
</ul></div>
<a href="14.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="16.html">下一页</a>
</body>
</html>