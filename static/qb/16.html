<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
 <a href="15.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="17.html">下一页</a>
<title>Django-4.0-Day16</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="od80" id="django-40-day16">Django-4.0-Day16</h1><p data-anchor-id="w0nd"><code>django</code></p><hr><div class="md-section-divider"></div><h2 data-anchor-id="3vlc" id="01订单数据库表设计">01_订单数据库表设计</h2><p data-anchor-id="inat"><img src="http://static.zybuluo.com/jsutqb/z6ww1vat17kirhxdlstkowse/image_1cifapavq1l2o1ft41cag12s73ma9.png" alt="image_1cifapavq1l2o1ft41cag12s73ma9.png-116.4kB" title="点击查看大图"></p><ol data-anchor-id="wgb6">
<li>创建order应用</li>
<li>注册应用</li>
<li><p>完成模型代码</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">db </span><span class="kwd">import</span><span class="pln"> models</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> meiduo_mall</span><span class="pun">.</span><span class="pln">utils</span><span class="pun">.</span><span class="pln">models </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">BaseModel</span></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> users</span><span class="pun">.</span><span class="pln">models </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">User</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Address</span></code></li><li class="L3"><code><span class="kwd">from</span><span class="pln"> goods</span><span class="pun">.</span><span class="pln">models </span><span class="kwd">import</span><span class="pln"> SKU</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OrderInfo</span><span class="pun">(</span><span class="typ">BaseModel</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L7"><code><span class="str">    订单信息</span></code></li><li class="L8"><code><span class="str">    """</span></code></li><li class="L9"><code><span class="pln">    PAY_METHODS_ENUM </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">        </span><span class="str">"CASH"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">        </span><span class="str">"ALIPAY"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2</span></code></li><li class="L2"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    PAY_METHOD_CHOICES </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">"货到付款"</span><span class="pun">),</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="str">"支付宝"</span><span class="pun">),</span></code></li><li class="L7"><code><span class="pln">    </span><span class="pun">)</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">    ORDER_STATUS_ENUM </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">        </span><span class="str">"UNPAID"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">        </span><span class="str">"UNSEND"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">2</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">        </span><span class="str">"UNRECEIVED"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">3</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">        </span><span class="str">"UNCOMMENT"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">4</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">        </span><span class="str">"FINISHED"</span><span class="pun">:</span><span class="pln"> </span><span class="lit">5</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">    ORDER_STATUS_CHOICES </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">"待支付"</span><span class="pun">),</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="str">"待发货"</span><span class="pun">),</span></code></li><li class="L0"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="str">"待收货"</span><span class="pun">),</span></code></li><li class="L1"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="str">"待评价"</span><span class="pun">),</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="str">"已完成"</span><span class="pun">),</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="str">"已取消"</span><span class="pun">),</span></code></li><li class="L4"><code><span class="pln">    </span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">    order_id </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">64</span><span class="pun">,</span><span class="pln"> primary_key</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"订单号"</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">    user </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="typ">User</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">PROTECT</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"下单用户"</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">    address </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="typ">Address</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">PROTECT</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"收获地址"</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">    total_count </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">IntegerField</span><span class="pun">(</span><span class="kwd">default</span><span class="pun">=</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"商品总数"</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">    total_amount </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">DecimalField</span><span class="pun">(</span><span class="pln">max_digits</span><span class="pun">=</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> decimal_places</span><span class="pun">=</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"商品总金额"</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">    freight </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">DecimalField</span><span class="pun">(</span><span class="pln">max_digits</span><span class="pun">=</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> decimal_places</span><span class="pun">=</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"运费"</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">    pay_method </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">SmallIntegerField</span><span class="pun">(</span><span class="pln">choices</span><span class="pun">=</span><span class="pln">PAY_METHOD_CHOICES</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">default</span><span class="pun">=</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"支付方式"</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">    status </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">SmallIntegerField</span><span class="pun">(</span><span class="pln">choices</span><span class="pun">=</span><span class="pln">ORDER_STATUS_CHOICES</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">default</span><span class="pun">=</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"订单状态"</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">        db_table </span><span class="pun">=</span><span class="pln"> </span><span class="str">"tb_order_info"</span></code></li><li class="L7"><code><span class="pln">        verbose_name </span><span class="pun">=</span><span class="pln"> </span><span class="str">'订单基本信息'</span></code></li><li class="L8"><code><span class="pln">        verbose_name_plural </span><span class="pun">=</span><span class="pln"> verbose_name</span></code></li><li class="L9"><code></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OrderGoods</span><span class="pun">(</span><span class="typ">BaseModel</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L3"><code><span class="str">    订单商品</span></code></li><li class="L4"><code><span class="str">    """</span></code></li><li class="L5"><code><span class="pln">    SCORE_CHOICES </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="str">'0分'</span><span class="pun">),</span></code></li><li class="L7"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">'20分'</span><span class="pun">),</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="str">'40分'</span><span class="pun">),</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> </span><span class="str">'60分'</span><span class="pun">),</span></code></li><li class="L0"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> </span><span class="str">'80分'</span><span class="pun">),</span></code></li><li class="L1"><code><span class="pln">        </span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="str">'100分'</span><span class="pun">),</span></code></li><li class="L2"><code><span class="pln">    </span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">    order </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="typ">OrderInfo</span><span class="pun">,</span><span class="pln"> related_name</span><span class="pun">=</span><span class="str">'skus'</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">CASCADE</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"订单"</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">    sku </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="pln">SKU</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">PROTECT</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"订单商品"</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    count </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">IntegerField</span><span class="pun">(</span><span class="kwd">default</span><span class="pun">=</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"数量"</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">    price </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">DecimalField</span><span class="pun">(</span><span class="pln">max_digits</span><span class="pun">=</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> decimal_places</span><span class="pun">=</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"单价"</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">    comment </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">TextField</span><span class="pun">(</span><span class="kwd">default</span><span class="pun">=</span><span class="str">""</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"评价信息"</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">    score </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">SmallIntegerField</span><span class="pun">(</span><span class="pln">choices</span><span class="pun">=</span><span class="pln">SCORE_CHOICES</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">default</span><span class="pun">=</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'满意度评分'</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">    is_anonymous </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">BooleanField</span><span class="pun">(</span><span class="kwd">default</span><span class="pun">=</span><span class="kwd">False</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'是否匿名评价'</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">    is_commented </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">BooleanField</span><span class="pun">(</span><span class="kwd">default</span><span class="pun">=</span><span class="kwd">False</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'是否评价了'</span><span class="pun">)</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">        db_table </span><span class="pun">=</span><span class="pln"> </span><span class="str">"tb_order_goods"</span></code></li><li class="L4"><code><span class="pln">        verbose_name </span><span class="pun">=</span><span class="pln"> </span><span class="str">'订单商品'</span></code></li><li class="L5"><code><span class="pln">        verbose_name_plural </span><span class="pun">=</span><span class="pln"> verbose_name</span></code></li></ol></pre></li>
</ol><div class="md-section-divider"></div><h2 data-anchor-id="n1x9" id="02订单结算实现">02_订单结算实现</h2><ul data-anchor-id="9yhv">
<li><p>后端</p>

<ul><li><p>设计</p>

<ul><li>请求 GET /orders/settlement/ 无参数 ,但需要登录</li>
<li><p>响应 运费 + 勾选的商品信息和数量</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pun">{</span></code></li><li class="L1"><code><span class="str">"freight"</span><span class="pun">:</span><span class="pln">freight</span><span class="pun">,</span></code></li><li class="L2"><code><span class="str">"skus"</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">  </span><span class="pun">[</span></code></li><li class="L4"><code><span class="pln">    </span><span class="pun">{</span><span class="str">"id"</span><span class="pun">:</span><span class="pln">id</span><span class="pun">,</span><span class="str">"name"</span><span class="pun">:</span><span class="pln">name</span><span class="pun">,</span><span class="pln"> </span><span class="str">"default_image_url"</span><span class="pun">:</span><span class="pln">default_image_url</span><span class="pun">,</span><span class="str">"price"</span><span class="pun">:</span><span class="pln">price</span><span class="pun">,</span><span class="str">"count"</span><span class="pun">:</span><span class="pln">count</span><span class="pun">,},</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L6"><code><span class="pln">  </span><span class="pun">]</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pun">}</span></code></li></ol></pre></li></ul></li>
<li><p>实现</p>

<ul><li><p>order.serializers.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> rest_framework </span><span class="kwd">import</span><span class="pln"> serializers</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> carts</span><span class="pun">.</span><span class="pln">serializers </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">CartSKUSerializer</span></code></li><li class="L3"><code></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OrderSettlementSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">Serializer</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">    </span><span class="com"># max_digits 包含小数的最多位数，decimal_places 几位小数</span></code></li><li class="L7"><code><span class="pln">    freight </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">DecimalField</span><span class="pun">(</span><span class="pln">max_digits</span><span class="pun">=</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> decimal_places</span><span class="pun">=</span><span class="lit">2</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">    skus </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CartSKUSerializer</span><span class="pun">(</span><span class="pln">many</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> read_only</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>order.views.py</p>

<ol><li>登录才能访问，配置permission_classes</li>
<li>组装出来接口中需要的信息 <br>
<ol><li>获取购物车原始信息 商品id和数量 勾选状态</li>
<li>根据商品id查询出商品信息</li>
<li>使用默认的运费</li>
<li>组装数据</li>
<li>交给序列化器</li>
<li>返回响应</li></ol></li></ol>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> </span><span class="kwd">decimal</span><span class="pln"> </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Decimal</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> django_redis </span><span class="kwd">import</span><span class="pln"> get_redis_connection</span></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> rest_framework</span><span class="pun">.</span><span class="pln">response </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Response</span></code></li><li class="L3"><code><span class="kwd">from</span><span class="pln"> rest_framework</span><span class="pun">.</span><span class="pln">views </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">APIView</span></code></li><li class="L4"><code><span class="kwd">from</span><span class="pln"> rest_framework</span><span class="pun">.</span><span class="pln">permissions </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">IsAuthenticated</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="kwd">from</span><span class="pln"> goods</span><span class="pun">.</span><span class="pln">models </span><span class="kwd">import</span><span class="pln"> SKU</span></code></li><li class="L7"><code><span class="kwd">from</span><span class="pln"> </span><span class="pun">.</span><span class="pln">serializers </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">OrderSettlementSerializer</span><span class="pun">,</span><span class="pln"> </span><span class="typ">SaveOrderSerializer</span></code></li><li class="L8"><code></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OrderSettlementView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    订单结算</span></code></li><li class="L3"><code><span class="str">    """</span></code></li><li class="L4"><code><span class="pln">    permission_classes </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">IsAuthenticated</span><span class="pun">,)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L7"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L8"><code><span class="str">        获取</span></code></li><li class="L9"><code><span class="str">        """</span></code></li><li class="L0"><code><span class="pln">        user </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">user</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 从购物车中获取用户勾选要结算的商品信息</span></code></li><li class="L3"><code><span class="pln">        redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        redis_cart </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">hgetall</span><span class="pun">(</span><span class="str">'cart_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">        cart_selected </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">smembers</span><span class="pun">(</span><span class="str">'cart_selected_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        cart </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">for</span><span class="pln"> sku_id </span><span class="kwd">in</span><span class="pln"> cart_selected</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">            cart</span><span class="pun">[</span><span class="kwd">int</span><span class="pun">(</span><span class="pln">sku_id</span><span class="pun">)]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">(</span><span class="pln">redis_cart</span><span class="pun">[</span><span class="pln">sku_id</span><span class="pun">])</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="com"># 查询商品信息</span></code></li><li class="L2"><code><span class="pln">        skus </span><span class="pun">=</span><span class="pln"> SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">id__in</span><span class="pun">=</span><span class="pln">cart</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">())</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">for</span><span class="pln"> sku </span><span class="kwd">in</span><span class="pln"> skus</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            sku</span><span class="pun">.</span><span class="pln">count </span><span class="pun">=</span><span class="pln"> cart</span><span class="pun">[</span><span class="pln">sku</span><span class="pun">.</span><span class="pln">id</span><span class="pun">]</span></code></li><li class="L5"><code><span class="pln">            sku</span><span class="pun">.</span><span class="pln">selected </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">True</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 运费</span></code></li><li class="L8"><code><span class="pln">        freight </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Decimal</span><span class="pun">(</span><span class="str">'10.00'</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OrderSettlementSerializer</span><span class="pun">({</span><span class="str">'freight'</span><span class="pun">:</span><span class="pln"> freight</span><span class="pun">,</span><span class="pln"> </span><span class="str">'skus'</span><span class="pun">:</span><span class="pln"> skus</span><span class="pun">})</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">serializer</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>order.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'orders/settlement/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">OrderSettlementView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li></ul></li></ul></li>
<li><p>前端 <br>
请求后端，获得数据并展示</p>

<ol><li>获取地址信息</li>
<li>获取上述接口中的信息</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="bwr7" id="03关于decimal的说明">03_关于decimal的说明</h2><p data-anchor-id="0tsp">python内置类(from decimal import Decimal)，可以进行各种数学计算 <br>
底层使用十进制存储的小数，不会因为二进制存储导致的的精度问题 <br>
一般用于进行金钱的计算</p><p data-anchor-id="l7m1"><strong>注意</strong> <br>
序列化器中需要指定 总位数和 小数位数 <br>
<code>freight = serializers.DecimalField(max_digits=10, decimal_places=2)</code></p><div class="md-section-divider"></div><h2 data-anchor-id="ekir" id="04保存订单的序列化器与视图定义">04_保存订单的序列化器与视图定义</h2><ul data-anchor-id="hvxp">
<li><p>后面的两个重点</p>

<ul><li>事务</li>
<li>并发</li></ul></li>
<li><p>订单id格式 <br>
<code>年月日时分秒+用户id</code></p></li>
<li><p>后端</p>

<ul><li>设计 <br>
<ul><li>请求</li>
<li>响应</li></ul></li>
<li><p>实现</p>

<ul><li><p>orders.views.py</p>

<ol><li>需要登录 配permission_classes</li>
<li>校验数据 保存数据操作交给序列化器实现</li></ol>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> rest_framework</span><span class="pun">.</span><span class="pln">permissions </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">IsAuthenticated</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> </span><span class="pun">.</span><span class="pln">serializers </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">OrderSettlementSerializer</span><span class="pun">,</span><span class="pln"> </span><span class="typ">SaveOrderSerializer</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">SaveOrderView</span><span class="pun">(</span><span class="typ">CreateAPIView</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">    </span><span class="str">"""保存订单"""</span></code></li><li class="L5"><code><span class="pln">    permission_classes </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">IsAuthenticated</span><span class="pun">]</span></code></li><li class="L6"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> </span><span class="typ">SaveOrderSerializer</span></code></li></ol></pre></li>
<li><p>orders.serializers.py</p>

<ol><li>三个字段，两个字段()是只写，一个字段是只读</li>
<li>使用ModelSerializer 可以简化验证 <br>
pay_method 在范围内 <br>
address 存在对应的id</li></ol>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code></code></li><li class="L1"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">SaveOrderSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">ModelSerializer</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">    </span><span class="str">"""保存订单的序列化器"""</span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">        model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OrderInfo</span></code></li><li class="L5"><code><span class="pln">        fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'order_id'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'address'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'pay_method'</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 'write_only':   向后端写数据  向后端传数据</span></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 'read_only':  前端要从后端读取数据，后端返回数据使用</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 前端并没有提交order_id ，所以这是只读字段</span></code></li><li class="L0"><code><span class="pln">        read_only_fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'order_id'</span><span class="pun">,)</span></code></li><li class="L1"><code><span class="pln">        extra_kwargs </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">            </span><span class="str">'address'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">                </span><span class="str">'write_only'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">True</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">                </span><span class="str">'required'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">True</span></code></li><li class="L5"><code><span class="pln">            </span><span class="pun">},</span></code></li><li class="L6"><code><span class="pln">            </span><span class="str">'pay_method'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">                </span><span class="str">'write_only'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">True</span><span class="pun">,</span></code></li><li class="L8"><code><span class="pln">                </span><span class="str">'required'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">True</span></code></li><li class="L9"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L0"><code><span class="pln">        </span><span class="pun">}</span></code></li></ol></pre></li></ul></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="9atz" id="05保存订单数据逻辑分析与django使用事务">05_保存订单数据逻辑分析与Django使用事务</h2><ul data-anchor-id="jh2y">
<li>整体思路 <br>
<ol><li>订单表 <br>
生成订单编号，新增记录，更新记录</li>
<li>订单商品表 <br>
获取购物车勾选，新增记录</li>
<li>商品表 <br>
增加销量，减少库存</li>
<li>购物车redis <br>
清空已结算的商品相关记录</li></ol></li>
<li><p>步骤</p>

<ol><li>获取登录用户</li>
<li>准备基础数据，创建订单模型对象，保存</li>
<li>创建key，获得redis中购物车记录</li>
<li>遍历 <br>
<ol><li>校验库存</li>
<li>增加销量、减少库存</li>
<li>创建订单商品模型对象，并保存</li></ol></li>
<li>更新订单模型对象，保存</li>
<li>处理redis中相关 记录</li></ol></li>
<li><p>事务 <br>
多条sql语句要么都成功、要么都不成功</p>

<ul><li><p>django中的事务</p>

<ul><li><p>开启事务 <br>
django.db.transaction.atomic <br>
两种用法</p>

<ul><li>使用装饰器的形式 <br>
atomic 装饰函数 <br>
配合 django.utils.decorators.method_decorator 装饰方法</li>
<li><p>使用with</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">with</span><span class="pln"> transaction</span><span class="pun">.</span><span class="pln">atomic</span><span class="pun">():</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># 要在同一事务中执行的代码 </span></code></li></ol></pre></li></ul></li>
<li><p>回滚事务</p>

<ol><li>创建保存点 <br>
<code>save_id = transaction.savepoint()</code></li>
<li>提交保存点 <br>
<code>transaction.savepoint_commit(save_id)</code></li>
<li>回滚保存点 <br>
<code>transaction.savepoint_rollback(save_id)</code></li></ol></li></ul></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="7siy" id="06保存订单数据实现">06_保存订单数据实现</h2><ul data-anchor-id="4ol9">
<li><p>实现思路</p>

<ol><li>根据步骤实现相应代码、 <br>
数据库中需要什么数据，就凑出什么数据</li>
<li>添加事务</li>
<li>创建保存点</li>
<li>根据情况提交或者回滚保存点</li>
<li>添加异常处理</li></ol></li>
<li><p>代码实现</p></li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="tna5"><ol class="linenums"><li class="L0"><code><span class="kwd">def</span><span class="pln"> create</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> validated_data</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""保存订单"""</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com"># 获取当前下单用户</span></code></li><li class="L3"><code><span class="pln">    user </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">context</span><span class="pun">[</span><span class="str">'request'</span><span class="pun">].</span><span class="pln">user</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">    </span><span class="com"># 保存订单的基本信息数据 OrderInfo</span></code></li><li class="L6"><code><span class="pln">    </span><span class="com"># 创建订单编号</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com"># 20180523160505+ user_id  100</span></code></li><li class="L8"><code><span class="pln">    </span><span class="com"># timezone.now() -&gt; datetime</span></code></li><li class="L9"><code><span class="pln">    order_id </span><span class="pun">=</span><span class="pln"> timezone</span><span class="pun">.</span><span class="pln">now</span><span class="pun">().</span><span class="pln">strftime</span><span class="pun">(</span><span class="str">'%Y%m%d%H%M%S'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="str">'%09d'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">)</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">    address </span><span class="pun">=</span><span class="pln"> validated_data</span><span class="pun">[</span><span class="str">'address'</span><span class="pun">]</span></code></li><li class="L2"><code><span class="pln">    pay_method </span><span class="pun">=</span><span class="pln"> validated_data</span><span class="pun">[</span><span class="str">'pay_method'</span><span class="pun">]</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    </span><span class="com"># 开启事务</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">with</span><span class="pln"> transaction</span><span class="pun">.</span><span class="pln">atomic</span><span class="pun">():</span></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 创建保存点，记录当前数据状态</span></code></li><li class="L7"><code><span class="pln">        save_id </span><span class="pun">=</span><span class="pln"> transaction</span><span class="pun">.</span><span class="pln">savepoint</span><span class="pun">()</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">            order </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OrderInfo</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span></code></li><li class="L1"><code><span class="pln">                order_id</span><span class="pun">=</span><span class="pln">order_id</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">                user</span><span class="pun">=</span><span class="pln">user</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">                address</span><span class="pun">=</span><span class="pln">address</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">                total_count</span><span class="pun">=</span><span class="lit">0</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">                total_amount</span><span class="pun">=</span><span class="typ">Decimal</span><span class="pun">(</span><span class="str">'0'</span><span class="pun">),</span></code></li><li class="L6"><code><span class="pln">                freight</span><span class="pun">=</span><span class="typ">Decimal</span><span class="pun">(</span><span class="str">'10.0'</span><span class="pun">),</span></code></li><li class="L7"><code><span class="pln">                pay_method</span><span class="pun">=</span><span class="pln">pay_method</span><span class="pun">,</span></code></li><li class="L8"><code><span class="pln">                status</span><span class="pun">=</span><span class="typ">OrderInfo</span><span class="pun">.</span><span class="pln">ORDER_STATUS_ENUM</span><span class="pun">[</span><span class="str">'UNSEND'</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> pay_method</span><span class="pun">==</span><span class="typ">OrderInfo</span><span class="pun">.</span><span class="pln">PAY_METHODS_ENUM</span><span class="pun">[</span><span class="str">'CASH'</span><span class="pun">]</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="typ">OrderInfo</span><span class="pun">.</span><span class="pln">ORDER_STATUS_ENUM</span><span class="pun">[</span><span class="str">'UNPAID'</span><span class="pun">]</span></code></li><li class="L9"><code><span class="pln">            </span><span class="pun">)</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">            </span><span class="com"># 从redis中获取购物车数据</span></code></li><li class="L2"><code><span class="pln">            redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'cart'</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">            cart_redis </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">hgetall</span><span class="pun">(</span><span class="str">'cart_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">            cart_selected </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">smembers</span><span class="pun">(</span><span class="str">'cart_selected_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">            cart </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{}</span></code></li><li class="L7"><code><span class="pln">            </span><span class="kwd">for</span><span class="pln"> sku_id </span><span class="kwd">in</span><span class="pln"> cart_selected</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">                cart</span><span class="pun">[</span><span class="kwd">int</span><span class="pun">(</span><span class="pln">sku_id</span><span class="pun">)]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">(</span><span class="pln">cart_redis</span><span class="pun">[</span><span class="pln">sku_id</span><span class="pun">])</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">            sku_obj_list </span><span class="pun">=</span><span class="pln"> SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">id__in</span><span class="pun">=</span><span class="pln">cart</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">())</span></code></li><li class="L1"><code><span class="pln">            </span><span class="com"># 遍历勾选要下单的商品数据，</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">for</span><span class="pln"> sku_id </span><span class="kwd">in</span><span class="pln"> sku_id_list</span><span class="pun">:</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">                </span><span class="com"># 判断商品库存是否充足</span></code></li><li class="L5"><code><span class="pln">                count </span><span class="pun">=</span><span class="pln"> cart</span><span class="pun">[</span><span class="pln">sku</span><span class="pun">.</span><span class="pln">id</span><span class="pun">]</span></code></li><li class="L6"><code><span class="pln">                </span><span class="kwd">if</span><span class="pln"> sku</span><span class="pun">.</span><span class="pln">stock </span><span class="pun">&lt;</span><span class="pln"> count</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">                    </span><span class="com"># 事务回滚</span></code></li><li class="L8"><code><span class="pln">                    transaction</span><span class="pun">.</span><span class="pln">savepoint_rollback</span><span class="pun">(</span><span class="pln">save_id</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">                    </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'商品库存不足'</span><span class="pun">)</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">                </span><span class="com"># 减少商品的库存 SKU</span></code></li><li class="L2"><code><span class="pln">                sku</span><span class="pun">.</span><span class="pln">stock </span><span class="pun">-=</span><span class="pln"> count</span></code></li><li class="L3"><code><span class="pln">                sku</span><span class="pun">.</span><span class="pln">sales </span><span class="pun">+=</span><span class="pln"> count</span></code></li><li class="L4"><code><span class="pln">                sku</span><span class="pun">.</span><span class="pln">save</span><span class="pun">()</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">                order</span><span class="pun">.</span><span class="pln">total_count </span><span class="pun">+=</span><span class="pln"> count</span></code></li><li class="L7"><code><span class="pln">                order</span><span class="pun">.</span><span class="pln">total_amount </span><span class="pun">+=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sku</span><span class="pun">.</span><span class="pln">price </span><span class="pun">*</span><span class="pln"> count</span><span class="pun">)</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">                </span><span class="com"># 保存到OrderGoods</span></code></li><li class="L0"><code><span class="pln">                </span><span class="typ">OrderGoods</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span></code></li><li class="L1"><code><span class="pln">                    order</span><span class="pun">=</span><span class="pln">order</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">                    sku</span><span class="pun">=</span><span class="pln">sku</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">                    count</span><span class="pun">=</span><span class="pln">count</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">                    price</span><span class="pun">=</span><span class="pln">sku</span><span class="pun">.</span><span class="pln">price</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">                </span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">            </span><span class="com"># 更新订单的数量与金额信息</span></code></li><li class="L7"><code><span class="pln">            order</span><span class="pun">.</span><span class="pln">save</span><span class="pun">()</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">            </span><span class="kwd">raise</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">Exception</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            transaction</span><span class="pun">.</span><span class="pln">savepoint_rollback</span><span class="pun">(</span><span class="pln">save_id</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">raise</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 提交事务</span></code></li><li class="L5"><code><span class="pln">        transaction</span><span class="pun">.</span><span class="pln">savepoint_commit</span><span class="pun">(</span><span class="pln">save_id</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 清除购物车中已经结算的商品</span></code></li><li class="L8"><code><span class="pln">        pl </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="pln">pipeline</span><span class="pun">()</span></code></li><li class="L9"><code><span class="pln">        pl</span><span class="pun">.</span><span class="pln">hdel</span><span class="pun">(</span><span class="str">'cart_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">cart_selected</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        pl</span><span class="pun">.</span><span class="pln">srem</span><span class="pun">(</span><span class="str">'cart_selected_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">cart_selected</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        pl</span><span class="pun">.</span><span class="pln">execute</span><span class="pun">()</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> order</span></code></li></ol></pre><ul data-anchor-id="39xw">
<li>注意： <br>
<ol><li>订单状态要根据支付方式设置</li>
<li>对于事务中的代码，应该添加总的异常处理，出现任何异常都回滚</li>
<li>异常的捕获和抛出 <br>
<ol><li>一个try 可以对应多个except，前面写小的异常，后面写大的异常</li>
<li>要继续抛出异常，可以直接raise</li></ol></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="yl9i" id="07保存订单测试">07_保存订单测试</h2><ul data-anchor-id="u35v">
<li><p>前端代码</p>

<ol><li>点击</li>
<li>发送请求</li>
<li>成功后重定向至成功页面，注意携带订单id</li></ol></li>
<li><p>测试</p>

<ol><li>界面操作</li>
<li>查看数据库</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="g439" id="08并发下单演示与解决办法说明">08_并发下单演示与解决办法说明</h2><ul data-anchor-id="e2ov">
<li>问题 <br>
超卖</li>
<li>原因 <br>
多线程，代码可能短暂停止在任意位置</li>
<li><p>解决办法</p>

<ol><li><p>悲观锁 <br>
对行记录进行加锁，直到事务结束，其他的事务碰到被锁的记录，只有等待 <br>
mysql</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">select</span><span class="pln"> stock </span><span class="kwd">from</span><span class="pln"> tb_sku </span><span class="kwd">where</span><span class="pln"> id</span><span class="pun">=</span><span class="lit">1</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> update</span><span class="pun">;</span></code></li></ol></pre>

<p>django</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">select_for_update</span><span class="pun">().</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">id</span><span class="pun">=</span><span class="lit">1</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>乐观锁 <br>
在更新的时候判断有无变化 <br>
mysql</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">update tb_sku </span><span class="kwd">set</span><span class="pln"> stock</span><span class="pun">=</span><span class="lit">2</span><span class="pln"> </span><span class="kwd">where</span><span class="pln"> id</span><span class="pun">=</span><span class="lit">1</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> stock</span><span class="pun">=</span><span class="lit">7</span><span class="pun">;</span></code></li></ol></pre>

<p>django</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">id</span><span class="pun">=</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> stock</span><span class="pun">=</span><span class="lit">7</span><span class="pun">).</span><span class="pln">update</span><span class="pun">(</span><span class="pln">stock</span><span class="pun">=</span><span class="lit">2</span><span class="pun">)</span></code></li></ol></pre></li>
<li>异步任务转为顺序执行</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="yioa" id="09使用乐观锁解决并发">09_使用乐观锁解决并发</h2><div class="md-section-divider"></div><h2 data-anchor-id="3ao1" id="10修改数据库不从新查询库存的bug">10_修改数据库不从新查询库存的bug</h2><ul data-anchor-id="fqeb">
<li><p>课程中的思路：</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">for</span><span class="pln"> sku_id </span><span class="kwd">in</span><span class="pln"> sku_id_list</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># 使用死循环不断重试</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">while</span><span class="pln"> </span><span class="kwd">True</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">        sku </span><span class="pun">=</span><span class="pln"> SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">id</span><span class="pun">=</span><span class="pln">sku_id</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">...</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 乐观锁</span></code></li><li class="L7"><code><span class="pln">        new_stock </span><span class="pun">=</span><span class="pln"> origin_stock </span><span class="pun">-</span><span class="pln"> count</span></code></li><li class="L8"><code><span class="pln">        new_sales </span><span class="pun">=</span><span class="pln"> origin_sales </span><span class="pun">+</span><span class="pln"> count</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">        </span><span class="com"># 返回受影响的行数</span></code></li><li class="L1"><code><span class="pln">        ret </span><span class="pun">=</span><span class="pln"> SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">id</span><span class="pun">=</span><span class="pln">sku</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> stock</span><span class="pun">=</span><span class="pln">origin_stock</span><span class="pun">).</span><span class="pln">update</span><span class="pun">(</span><span class="pln">stock</span><span class="pun">=</span><span class="pln">new_stock</span><span class="pun">,</span><span class="pln"> sales</span><span class="pun">=</span><span class="pln">new_sales</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 如果影响行数为0，表示没有更新，则充实</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> ret </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">continue</span></code></li><li class="L5"><code><span class="pln">        </span><span class="com"># 保存到OrderGoods</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">...</span></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 到这里就可以结束死循环了</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">break</span></code></li></ol></pre></li>
<li><p>注意</p>

<ol><li>要在死循环中重新查询商品，因为QuerySet中有缓存特性，数据并不与数据库同步</li>
<li>记得break</li></ol></li>
<li><p>简化的思路</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">SKU</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">id</span><span class="pun">=</span><span class="pln">sku</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> stock__gte</span><span class="pun">=</span><span class="pln">count</span><span class="pun">).</span><span class="pln">update</span><span class="pun">(</span><span class="pln">stock</span><span class="pun">=</span><span class="pln">F</span><span class="pun">(</span><span class="str">"stock"</span><span class="pun">)-</span><span class="pln">count</span><span class="pun">,</span><span class="pln"> sales</span><span class="pun">=</span><span class="pln">F</span><span class="pun">(</span><span class="str">"sales"</span><span class="pun">)+</span><span class="pln">count</span><span class="pun">)</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="3yja" id="11数据库事务隔离级别说明">11_数据库事务隔离级别说明</h2><ul data-anchor-id="3vt1">
<li><p>隔离级别</p>

<table class="table table-striped-white table-bordered">
<thead>
<tr>
 <th>隔离级别</th>
 <th>脏读（Dirty Read）</th>
 <th>不可重复读（NonRepeatable Read）</th>
 <th>幻读（Phantom Read）</th>
</tr>
</thead>
<tbody><tr>
 <td>未提交读（Read uncommitted）</td>
 <td>可能</td>
 <td>可能</td>
 <td>可能</td>
</tr>
<tr>
 <td>已提交读（Read committed）</td>
 <td>不可能</td>
 <td>可能</td>
 <td>可能</td>
</tr>
<tr>
 <td>可重复读（Repeatable read）</td>
 <td>不可能</td>
 <td>不可能</td>
 <td>可能</td>
</tr>
<tr>
 <td>可串行化（Serializable ）</td>
 <td>不可能</td>
 <td>不可能</td>
 <td>不可能</td>
</tr>
</tbody></table>
</li>
<li><p>mysql中的隔离级别</p>

<ol><li>默认是可重复读</li>
<li><p>通过修改配置文件可以修改</p>

<ol><li>sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf</li>
<li><p>添加到配置中skip开头的那行下面</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">transaction</span><span class="pun">-</span><span class="pln">isolation </span><span class="pun">=</span><span class="pln"> READ</span><span class="pun">-</span><span class="pln">COMMITTED</span></code></li></ol></pre></li>
<li><p>重新启动数据库服务 <br>
<code>sudo service mysql restart</code></p></li></ol></li></ol></li>
<li><p>django中的隔离级别 <br>
django2.0 在连接mysql数据库的时候默认隔离级别为读已提交 <br>
<a href="https://docs.djangoproject.com/en/2.0/releases/2.0/#default-mysql-isolation-level-is-read-committed" target="_blank">https://docs.djangoproject.com/en/2.0/releases/2.0/#default-mysql-isolation-level-is-read-committed</a></p></li>
</ul></div>
<a href="15.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="17.html">下一页</a>
</body>
</html>