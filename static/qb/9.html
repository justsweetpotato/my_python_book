<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
 <a href="8.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="10.html">下一页</a><br>

<title>Django-4.0-Day9</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="p5on" id="django-40-day9">Django-4.0-Day9</h1><p data-anchor-id="88j4"><code>django</code></p><hr><div class="md-section-divider"></div><h2 data-anchor-id="a0ft" id="知识点复习">知识点复习</h2><ul data-anchor-id="4k58">
<li>注册业务 <br>
<ol><li>图片验证码</li>
<li><strong>发送短信验证码</strong> <br>
序列化器和视图的关系 <br>
序列化器的定义</li>
<li>用户名重复校验</li>
<li>电话重复校验</li>
<li><strong>注册</strong> <br>
这里的序列化器要重点体会一下序列化器的作用</li></ol></li>
<li>用到的技术 <br>
<ul><li>celery <br>
<ul><li>作用</li>
<li>构成 <br>
client worker broker backend</li>
<li>步骤 <br>
定义app 定义任务函数  开启worker 发送任务</li></ul></li>
<li>redis管道</li>
<li>异常的选择性捕获</li></ul></li>
<li><p>jwt 认识</p>

<ul><li>三个部分</li>
<li>认证过程</li>
<li>安全的原理</li></ul></li>
<li><p>加密</p>

<ul><li>三种方式</li>
<li>常用应用场景</li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="2mk6" id="每日反馈解答">每日反馈解答</h2><div class="md-section-divider"></div><h2 data-anchor-id="nbu2" id="01-jwt介绍">01-JWT介绍</h2><ul data-anchor-id="0yrw">
<li>需求引出 <br>
登录状态保存，传统上使用session <br>
session是基于cookie的 <br>
但cookie有个特点：为了安全考虑，cookie只在相同的域名起作用。对于跨域，session或者cookie无能为力</li>
<li><p>问题解决 <br>
使用token 内部存储了 用户id，登录后服务器发送给浏览器，浏览在下次请求中携带过来。 <br>
这里的用户id是个例子，也可以是其他信息，是明文的，这里我们要注意，可能会被篡改或者伪造。 <br>
所以需要通过某种加密手段来避免篡改伪造 或者 是发现篡改伪造</p></li>
<li><p>jwt <br>
Json web token (JWT), 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准（(RFC 7519).该token被设计为紧凑且安全的，特别适用于分布式站点的单点登录（SSO）场景。JWT的声明一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密。</p>

<ul><li>概念 <br>
<ul><li>json <br>
跨平台的技术点，各个平台都能实现</li>
<li>token <br>
令牌</li>
<li>单点登录 <br>
一个集团公司，拥有大量不同的域名，但希望用户使用同一套账号密码使用所有的服务，解决这一个问题，就需要使用到单点登录</li></ul></li>
<li><p>三个构成</p>

<ol><li>head      头部 <br>
用于表示这个信息的构成结构</li>
<li>payload  荷载 有效信息 <br>
包含 一些共有数据和私有数据</li>
<li>signature <br>
对前面两个信息，和一个密钥，进行摘要签名后的数据，用来校验数据的完整性</li></ol></li>
<li><p>图示 <br>
![image_1chcthatm1gtibie1de87or1scs19.png-49.8kB][3]</p></li>
<li><p>使用过程 <br>
![image_1chcummc31pphgmk1rli15acc2j9.png-83.5kB][4]</p></li>
<li><p>使用jwt的注意事项</p>

<ul><li>不应该在jwt的payload部分存放敏感信息，因为该部分是客户端可解密的部分。</li>
<li>保护好secret私钥，该私钥非常重要。</li>
<li>如果可以，请使用https协议</li></ul></li>
<li>课外资料 <br>
<a href="https://blog.leapoahead.com/2015/09/06/understanding-jwt/" target="_blank">https://blog.leapoahead.com/2015/09/06/understanding-jwt/</a> <br>
<a href="https://zh.wikipedia.org/wiki/%E9%87%91%E9%91%B0%E9%9B%9C%E6%B9%8A%E8%A8%8A%E6%81%AF%E9%91%91%E5%88%A5%E7%A2%BC" target="_blank">https://zh.wikipedia.org/wiki/%E9%87%91%E9%91%B0%E9%9B%9C%E6%B9%8A%E8%A8%8A%E6%81%AF%E9%91%91%E5%88%A5%E7%A2%BC</a></li></ul></li>
<li><p>关于加密 <br>
解决两方通讯过程中可能经过一些不可控(非信任)的节点，导致的问题(信息泄漏、篡改、伪造等)。 <br>
加密就是通过某种算法(称为加密算法)，把原始内容(称为明文)和一个不为其他人知道的信息(密钥)，进行计算，得到另外一段内容(称为密文)的过程。  <br>
如果把密文和密钥还原为明文的过程称为解密。 <br>
广义上的加密 有加密过程和 解密过程 <br>
在计算机中，加密 就是把 字节转为字节</p>

<ul><li>加密的分类 <br>
<ul><li>对称加密 <br>
加密过程和 解密过程中 使用到的密钥是一样的 <br>
常见的算法:AES、3DES、DES、Blowfish、IDEA</li>
<li>非对称加密 <br>
加密过程和解密过程中，使用到的密钥是不一样的(虽然不一样，但它们是一对) <br>
这一对密钥，一个称为私钥，一个称为公钥。私钥必须妥善保管，不能让他人所知，公钥可以由任何人所知。 <br>
常见的算法:RSA、ECC</li>
<li>摘要算法 <br>
把任意长度的内容，转为比较短的固定长度的内容(称为摘要)。如果原始内容中有任何变化，得到的摘要与原来完全不同，主要用来验证内容是否被篡改 <br>
其实并不能算作加密算法，因为没有密钥，而且也不能解密。 <br>
但它与非对称算法用来进行内容的完整性校验和身份校验</li></ul></li>
<li><p>小总结</p>

<ul><li><p>各种方式的优缺点</p>

<table class="table table-striped-white table-bordered">
<thead>
<tr>
 <th>方式</th>
 <th>优点</th>
 <th>缺点</th>
</tr>
</thead>
<tbody><tr>
 <td>对称加密</td>
 <td>加解密高效，可处理任意长的内容</td>
 <td>密钥协商存在悖论</td>
</tr>
<tr>
 <td>非对称加密</td>
 <td>解决密钥协商问题</td>
 <td>慢，只能处理一段数据</td>
</tr>
<tr>
 <td>摘要</td>
 <td>验证完整性</td>
 <td>多与其他加密手段一起使用</td>
</tr>
</tbody></table>
</li>
<li><p>常见使用场景</p>

<table class="table table-striped-white table-bordered">
<thead>
<tr>
 <th>加密</th>
 <th>解决问题</th>
 <th>缺点</th>
</tr>
</thead>
<tbody><tr>
 <td>对称加解密</td>
 <td>传输内容的保密</td>
 <td>密钥需要事先协商，对于"陌生人"来说是不可能的</td>
</tr>
<tr>
 <td>公钥加密，私钥解密</td>
 <td>密钥交换</td>
 <td>相比对称加密慢很多，所以明文一般是密钥</td>
</tr>
<tr>
 <td>私钥加密，公钥解密</td>
 <td>身份认证</td>
 <td></td>
</tr>
<tr>
 <td>摘要</td>
 <td>验证完整性</td>
 <td>摘要也会被篡改</td>
</tr>
<tr>
 <td>私钥加密摘要，公钥解密得到摘要</td>
 <td>验证完整性+身份认证</td>
 <td></td>
</tr>
</tbody></table>
</li>
<li>大杀器 <br>
证书(融合了对称加密、非对称加密、摘要)的一整套解决方案</li></ul></li>
<li><p>课外资料 </p>

<ul><li>长文慎入 <br>
<a href="https://www.jianshu.com/p/006a8e6e25e7" target="_blank">https://www.jianshu.com/p/006a8e6e25e7</a></li>
<li><p>中等长度 慎入 <br>
<a href="https://www.jianshu.com/p/671ebeddcf60" target="_blank">https://www.jianshu.com/p/671ebeddcf60</a></p></li>
<li><p>短文 <br>
<a href="http://blog.sina.com.cn/s/blog_56d8ea900100bzpr.html" target="_blank">http://blog.sina.com.cn/s/blog_56d8ea900100bzpr.html</a></p></li>
<li><p>https (长) <br>
<a href="https://www.jianshu.com/p/29a90d057510" target="_blank">https://www.jianshu.com/p/29a90d057510</a></p></li>
<li><p>数据库加盐 <br>
<a href="https://www.zhihu.com/question/20299384" target="_blank">https://www.zhihu.com/question/20299384</a></p></li></ul></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="niat" id="02djangorestframework-jwt使用">02_djangorestframework-jwt使用</h2><ul data-anchor-id="7x77">
<li>原理 <br>
<img src="http://static.zybuluo.com/jsutqb/nbmzhl1y8rumadp1r2kstrli/image.png" alt="image.png-90.2kB"></li>
<li>安装 <br>
<code>pip install djangorestframework-jwt</code></li>
<li><p>配置</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">REST_FRAMEWORK </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">'DEFAULT_AUTHENTICATION_CLASSES'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span></code></li><li class="L2"><code><span class="pln">        </span><span class="str">'rest_framework_jwt.authentication.JSONWebTokenAuthentication'</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">        </span><span class="str">'rest_framework.authentication.SessionAuthentication'</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">        </span><span class="str">'rest_framework.authentication.BasicAuthentication'</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">),</span></code></li><li class="L6"><code><span class="pun">}</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">JWT_AUTH </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">    </span><span class="str">'JWT_EXPIRATION_DELTA'</span><span class="pun">:</span><span class="pln"> datetime</span><span class="pun">.</span><span class="pln">timedelta</span><span class="pun">(</span><span class="pln">days</span><span class="pun">=</span><span class="lit">1</span><span class="pun">),</span></code></li><li class="L0"><code><span class="pun">}</span></code></li></ol></pre></li>
<li><p>使用 <br>
在注册成功后，连同返回token，需要在注册视图中创建token。 <br>
修改CreateUserSerializer序列化器，在create方法中增加手动创建token的方法</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> rest_framework_jwt</span><span class="pun">.</span><span class="pln">settings </span><span class="kwd">import</span><span class="pln"> api_settings</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CreateUserSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">ModelSerializer</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L4"><code><span class="str">    创建用户序列化器</span></code></li><li class="L5"><code><span class="str">    """</span></code></li><li class="L6"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L7"><code><span class="pln">    token </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'登录状态token'</span><span class="pun">,</span><span class="pln"> read_only</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span><span class="pln">  </span><span class="com"># 增加token字段</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">：</span></code></li><li class="L0"><code><span class="pln">        </span><span class="pun">...</span></code></li><li class="L1"><code><span class="pln">        fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'username'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'password'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'password2'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'sms_code'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'mobile'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'allow'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'token'</span><span class="pun">)</span><span class="pln">  </span><span class="com"># 增加token</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">...</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> create</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> validated_data</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L6"><code><span class="str">        创建用户</span></code></li><li class="L7"><code><span class="str">        """</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">...</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 补充生成记录登录状态的token</span></code></li><li class="L0"><code><span class="pln">        jwt_payload_handler </span><span class="pun">=</span><span class="pln"> api_settings</span><span class="pun">.</span><span class="pln">JWT_PAYLOAD_HANDLER</span></code></li><li class="L1"><code><span class="pln">        jwt_encode_handler </span><span class="pun">=</span><span class="pln"> api_settings</span><span class="pun">.</span><span class="pln">JWT_ENCODE_HANDLER</span></code></li><li class="L2"><code><span class="pln">        payload </span><span class="pun">=</span><span class="pln"> jwt_payload_handler</span><span class="pun">(</span><span class="pln">user</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">        token </span><span class="pun">=</span><span class="pln"> jwt_encode_handler</span><span class="pun">(</span><span class="pln">payload</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        user</span><span class="pun">.</span><span class="pln">token </span><span class="pun">=</span><span class="pln"> token</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> user</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="v4vx" id="03注册前端保存jwt-token">03_注册前端保存JWT token</h2><ul data-anchor-id="qmbi">
<li><p>前端数据保存 <br>
可以使用以下两个对象去<strong>存储键值</strong>对 <br>
它们都是<strong>域隔离</strong>的</p>

<ul><li>localStorage</li>
<li>sessionStorage</li></ul></li>
<li><p>区别</p>

<ul><li>localStorage <br>
永久有效，除非代码删除或者用户清空浏览记录</li>
<li>sessionStorage <br>
一次会话有效，完全关闭浏览器失效</li></ul></li>
<li><p>api</p>

<ul><li>localStorage <br>
<ul><li>添加键值对 <br>
localStorage.setItem(键, 值); <br>
localStorage[键] = 值; <br>
localStorage.键 = 值;</li>
<li>获取键值对 <br>
值 = localStorage.getItem(键) <br>
值 = localStorage[键]  <br>
值 =  localStorage.键 </li>
<li>查看键值对数量 <br>
localStorage.length</li>
<li>删除键值对 <br>
localStorage.removeItem(键)</li>
<li>删除所有键值对 <br>
localStorage.clear()</li></ul></li>
<li>sessionStorage <br>
同localStorage</li></ul></li>
<li><p>项目代码 <br>
在提交注册信息并成功后 <br>
把这三个信息存到localStorage中</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">token </span><span class="pun">=</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">data</span><span class="pun">.</span><span class="pln">token</span><span class="pun">;</span></code></li><li class="L1"><code><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">username </span><span class="pun">=</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">data</span><span class="pun">.</span><span class="pln">username</span><span class="pun">;</span></code></li><li class="L2"><code><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">user_id </span><span class="pun">=</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">data</span><span class="pun">.</span><span class="pln">user_id</span><span class="pun">;</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="wry1" id="04为jwt视图补充返回userid和username">04_为JWT视图补充返回userid和username</h2><ul data-anchor-id="219t">
<li><p>登录 <br>
rest_framework_jwt已经提供了登录认证视图</p>

<ul><li><p>使用方式</p>

<ol><li><p>添加视图</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">users</span><span class="pun">/</span><span class="pln">urls</span><span class="pun">.</span><span class="pln">py</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> rest_framework_jwt</span><span class="pun">.</span><span class="pln">views </span><span class="kwd">import</span><span class="pln"> obtain_jwt_token</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L4"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'authorizations/'</span><span class="pun">,</span><span class="pln"> obtain_jwt_token</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">=</span><span class="str">'authorizations'</span><span class="pun">),</span></code></li><li class="L5"><code><span class="pun">]</span></code></li></ol></pre></li>
<li><p>添加额外返回user_id和username的功能</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">users</span><span class="pun">/</span><span class="pln">utils</span><span class="pun">.</span><span class="pln">py</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">def</span><span class="pln"> jwt_response_payload_handler</span><span class="pun">(</span><span class="pln">token</span><span class="pun">,</span><span class="pln"> user</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L4"><code><span class="str">    自定义jwt认证成功返回数据</span></code></li><li class="L5"><code><span class="str">    """</span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">        </span><span class="str">'token'</span><span class="pun">:</span><span class="pln"> token</span><span class="pun">,</span></code></li><li class="L8"><code><span class="pln">        </span><span class="str">'user_id'</span><span class="pun">:</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span></code></li><li class="L9"><code><span class="pln">        </span><span class="str">'username'</span><span class="pun">:</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">username</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">}</span></code></li></ol></pre>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">dev</span><span class="pun">.</span><span class="pln">py</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">JWT_AUTH </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L4"><code><span class="pln">    </span><span class="str">'JWT_RESPONSE_PAYLOAD_HANDLER'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'users.utils.jwt_response_payload_handler'</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pun">}</span></code></li></ol></pre></li></ol></li></ul></li>
<li><p>原理(源码)</p>

<ol><li><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">rest_framework_jwt</span><span class="pun">.</span><span class="pln">views</span></code></li><li class="L1"><code><span class="pln"> </span><span class="com"># 原来这是一个视图的 as_view的返回值</span></code></li><li class="L2"><code><span class="pln">obtain_jwt_token </span><span class="pun">=</span><span class="pln"> </span><span class="typ">ObtainJSONWebToken</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()</span></code></li></ol></pre></li>
<li><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">rest_framework_jwt</span><span class="pun">.</span><span class="pln">views</span></code></li><li class="L1"><code></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="com"># 这个类只赔了一个serializer_class</span></code></li><li class="L4"><code></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="com"># 并继承于JSONWebTokenAPIView 然后没有其他代码了</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">ObtainJSONWebToken</span><span class="pun">(</span><span class="typ">JSONWebTokenAPIView</span><span class="pun">):</span></code></li><li class="L9"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> </span><span class="typ">JSONWebTokenSerializer</span></code></li></ol></pre></li>
<li><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">rest_framework_jwt</span><span class="pun">.</span><span class="pln">serializers</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">contrib</span><span class="pun">.</span><span class="pln">auth </span><span class="kwd">import</span><span class="pln"> authenticate</span></code></li><li class="L3"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">JSONWebTokenSerializer</span><span class="pun">(</span><span class="typ">Serializer</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> attrs</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> all</span><span class="pun">(</span><span class="pln">credentials</span><span class="pun">.</span><span class="pln">values</span><span class="pun">()):</span></code></li><li class="L7"><code><span class="pln">            </span><span class="com"># 验证数据的时候调用了 django.contrib.auth 的 authenticate 方法</span></code></li><li class="L8"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> authenticate</span><span class="pun">(**</span><span class="pln">credentials</span><span class="pun">)</span></code></li></ol></pre></li>
<li><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">rest_framework_jwt</span><span class="pun">.</span><span class="pln">views</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">jwt_response_payload_handler </span><span class="pun">=</span><span class="pln"> api_settings</span><span class="pun">.</span><span class="pln">JWT_RESPONSE_PAYLOAD_HANDLER</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">JSONWebTokenAPIView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> post</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">kwargs</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">get_serializer</span><span class="pun">(</span><span class="pln">data</span><span class="pun">=</span><span class="pln">request</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">is_valid</span><span class="pun">():</span></code></li><li class="L8"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="kwd">object</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'user'</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">user</span></code></li><li class="L9"><code><span class="pln">            token </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="kwd">object</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'token'</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">            </span><span class="com"># 验证完数据会后会调用 jwt_response_payload_handler 方法 传入3个参数，得到字典的返回值</span></code></li><li class="L1"><code><span class="pln">            response_data </span><span class="pun">=</span><span class="pln"> jwt_response_payload_handler</span><span class="pun">(</span><span class="pln">token</span><span class="pun">,</span><span class="pln"> user</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">            response </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">response_data</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">            </span><span class="com"># 之前看到的过期时间</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> api_settings</span><span class="pun">.</span><span class="pln">JWT_AUTH_COOKIE</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">                expiration </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">datetime</span><span class="pun">.</span><span class="pln">utcnow</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span></code></li><li class="L6"><code><span class="pln">                              api_settings</span><span class="pun">.</span><span class="pln">JWT_EXPIRATION_DELTA</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">                response</span><span class="pun">.</span><span class="pln">set_cookie</span><span class="pun">(</span><span class="pln">api_settings</span><span class="pun">.</span><span class="pln">JWT_AUTH_COOKIE</span><span class="pun">,</span><span class="pln"> token</span><span class="pun">,</span><span class="pln"> expires</span><span class="pun">=</span><span class="pln">expiration</span><span class="pun">,</span><span class="pln"> httponly</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> response</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">(</span><span class="pln">serializer</span><span class="pun">.</span><span class="pln">errors</span><span class="pun">,</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_400_BAD_REQUEST</span><span class="pun">)</span></code></li></ol></pre></li>
<li><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">rest_framework_jwt</span><span class="pun">.</span><span class="pln">settings</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">conf </span><span class="kwd">import</span><span class="pln"> settings</span></code></li><li class="L3"><code><span class="pln">USER_SETTINGS </span><span class="pun">=</span><span class="pln"> getattr</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">,</span><span class="pln"> </span><span class="str">'JWT_AUTH'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="com"># jwt_response_payload_handler 方法有2个来源 我们配置的 和 默认的</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">api_settings </span><span class="pun">=</span><span class="pln"> </span><span class="typ">APISettings</span><span class="pun">(</span><span class="pln">USER_SETTINGS</span><span class="pun">,</span><span class="pln"> DEFAULTS</span><span class="pun">,</span><span class="pln"> IMPORT_STRINGS</span><span class="pun">)</span></code></li></ol></pre></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="xywu" id="15登录支持手机号码和密码的开发思路">15_登录支持手机号码和密码的开发思路</h2><p data-anchor-id="8m1q">和下面的课一起学完再总结</p><div class="md-section-divider"></div><h2 data-anchor-id="xg9f" id="16修改django认证后端支持手机号和密码">16_修改Django认证后端支持手机号和密码</h2><ul data-anchor-id="gmax">
<li><p>支持手机号码登陆</p>

<ol><li><p>定义认证类</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">users</span><span class="pun">/</span><span class="pln">utils</span><span class="pun">.</span><span class="pln">py</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">def</span><span class="pln"> get_user_by_account</span><span class="pun">(</span><span class="pln">account</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L4"><code><span class="str">    根据帐号获取user对象</span></code></li><li class="L5"><code><span class="str">    """</span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> re</span><span class="pun">.</span><span class="pln">match</span><span class="pun">(</span><span class="str">'^1[345789]\d{9}$'</span><span class="pun">,</span><span class="pln"> account</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">            </span><span class="com"># 帐号为手机号</span></code></li><li class="L9"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">mobile</span><span class="pun">=</span><span class="pln">account</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            </span><span class="com"># 帐号为用户名</span></code></li><li class="L2"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">username</span><span class="pun">=</span><span class="pln">account</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="typ">DoesNotExist</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">None</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> user</span></code></li><li class="L7"><code></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">UsernameMobileAuthBackend</span><span class="pun">(</span><span class="typ">ModelBackend</span><span class="pun">):</span></code></li><li class="L0"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L1"><code><span class="str">    自定义用户名或手机号认证</span></code></li><li class="L2"><code><span class="str">    """</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> authenticate</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> username</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> password</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">kwargs</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">        user </span><span class="pun">=</span><span class="pln"> get_user_by_account</span><span class="pun">(</span><span class="pln">username</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> user </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> </span><span class="kwd">None</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">check_password</span><span class="pun">(</span><span class="pln">password</span><span class="pun">):</span></code></li><li class="L7"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> user</span></code></li></ol></pre></li>
<li><p>配置认证类</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">    AUTHENTICATION_BACKENDS </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">'users.utils.UsernameMobileAuthBackend'</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li></ol></li>
<li><p>原理(源码)</p>

<ol><li><p>同上方的rest_framework_jwt.serializers</p></li>
<li><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">django</span><span class="pun">.</span><span class="pln">contrib</span><span class="pun">.</span><span class="pln">auth</span><span class="pun">.</span><span class="pln">__init__</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">def</span><span class="pln"> authenticate</span><span class="pun">(</span><span class="pln">request</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">credentials</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com"># 会获取校验后端，并依次校验，只要一个通过了，就返回登录用户</span></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">for</span><span class="pln"> backend</span><span class="pun">,</span><span class="pln"> backend_path </span><span class="kwd">in</span><span class="pln"> _get_backends</span><span class="pun">(</span><span class="pln">return_tuples</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> _authenticate_with_backend</span><span class="pun">(</span><span class="pln">backend</span><span class="pun">,</span><span class="pln"> backend_path</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> credentials</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">PermissionDenied</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">break</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> user </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">            </span><span class="kwd">continue</span></code></li><li class="L1"><code><span class="pln">        user</span><span class="pun">.</span><span class="pln">backend </span><span class="pun">=</span><span class="pln"> backend_path</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> user</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    user_login_failed</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">sender</span><span class="pun">=</span><span class="pln">__name__</span><span class="pun">,</span><span class="pln"> credentials</span><span class="pun">=</span><span class="pln">_clean_credentials</span><span class="pun">(</span><span class="pln">credentials</span><span class="pun">),</span><span class="pln"> request</span><span class="pun">=</span><span class="pln">request</span><span class="pun">)</span></code></li></ol></pre></li>
<li><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">django</span><span class="pun">.</span><span class="pln">contrib</span><span class="pun">.</span><span class="pln">auth</span><span class="pun">.</span><span class="pln">__init__</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">conf </span><span class="kwd">import</span><span class="pln"> settings</span></code></li><li class="L3"><code><span class="kwd">def</span><span class="pln"> _get_backends</span><span class="pun">(</span><span class="pln">return_tuples</span><span class="pun">=</span><span class="kwd">False</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">    backends </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[]</span></code></li><li class="L5"><code><span class="pln">    </span><span class="com"># 获取配置的多个认证后端</span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">for</span><span class="pln"> backend_path </span><span class="kwd">in</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">AUTHENTICATION_BACKENDS</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">        backend </span><span class="pun">=</span><span class="pln"> load_backend</span><span class="pun">(</span><span class="pln">backend_path</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        backends</span><span class="pun">.</span><span class="pln">append</span><span class="pun">((</span><span class="pln">backend</span><span class="pun">,</span><span class="pln"> backend_path</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> return_tuples </span><span class="kwd">else</span><span class="pln"> backend</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> backends</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">raise</span><span class="pln"> </span><span class="typ">ImproperlyConfigured</span><span class="pun">(</span></code></li><li class="L1"><code><span class="pln">            </span><span class="str">'No authentication backends have been defined. Does '</span></code></li><li class="L2"><code><span class="pln">            </span><span class="str">'AUTHENTICATION_BACKENDS contain anything?'</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> backends</span></code></li></ol></pre></li>
<li><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">def</span><span class="pln"> _authenticate_with_backend</span><span class="pun">(</span><span class="pln">backend</span><span class="pun">,</span><span class="pln"> backend_path</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> credentials</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    credentials </span><span class="pun">=</span><span class="pln"> credentials</span><span class="pun">.</span><span class="pln">copy</span><span class="pun">()</span><span class="pln">  </span></code></li><li class="L2"><code><span class="pln">    args </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">request</span><span class="pun">,)</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com"># 调用backend的authenticate方法，传递</span></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> backend</span><span class="pun">.</span><span class="pln">authenticate</span><span class="pun">(*</span><span class="pln">args</span><span class="pun">,</span><span class="pln"> </span><span class="pun">**</span><span class="pln">credentials</span><span class="pun">)</span></code></li></ol></pre></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="vgsd" id="07登录前端逻辑">07_登录前端逻辑</h2><ul data-anchor-id="7lz9">
<li><p>省略部分</p>

<ol><li>html</li>
<li>vue的数据校验</li></ol></li>
<li><p>注意点</p>

<ol><li>点击登录对应的js方法 <br>
<ol><li>校验用户名密码</li>
<li>如果校验通过</li>
<li>发起请求，得到结果 <br>
<ol><li>如果登录失败显示登录失败</li>
<li>如果登录成功 <br>
<ol><li>如果记住登录中状态把 token、用户名、用户id添加到localStorage中</li>
<li>如果不登录中状态把 token、用户名、用户id添加到sessionStorage中</li>
<li>获取url中的next对应的值(如果没有就是主页)，跳转到对应页面</li></ol></li></ol></li></ol></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="7xr3" id="08忘记密码的业务逻辑分析">08_忘记密码的业务逻辑分析</h2><ul data-anchor-id="4n3g">
<li>业务流程 <br>
<ol><li>显示账号和验证码的填写框</li>
<li>显示账号对应的手机号 和发送短信验证码按钮 和短信验证码输入框 </li>
<li>输入新的密码和确认密码</li>
<li>完成忘记密码</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="xbch" id="09接口访问凭据accesstoken的引入">09_接口访问凭据access_token的引入</h2><ul data-anchor-id="8hoz">
<li><p>第一步和第二步的过渡</p>

<ul><li><p>简单设计</p>

<ol><li><p>显示账号和验证码的填写框</p>

<div class="mermaid sequence" title="点击查看大图" data-processed="true"><svg id="mermaidChart0" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:500px;" viewBox="-75 -10 500 431"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor0" x1="75" y1="5" x2="75" y2="420" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor1" x1="275" y1="5" x2="275" y2="420" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">image_code_id</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="128" class="messageText" style="text-anchor: middle;">图片</text><line x1="275" y1="135" x2="75" y2="135" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="163" class="messageText" style="text-anchor: middle;">image_code_id + text + username</text><line x1="75" y1="170" x2="275" y2="170" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="198" class="messageText" style="text-anchor: middle;">校验</text><path d="M 275,205 C 335,195 335,235 275,225" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="263" class="messageText" style="text-anchor: middle;">mobile</text><line x1="275" y1="270" x2="75" y2="270" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="298" class="messageText" style="text-anchor: middle;">到第二步</text><path d="M 75,305 C 135,295 135,335 75,325" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><rect x="0" y="355" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="392.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="355" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="392.5" class="actor" style="text-anchor: middle;">后端 </text></g></svg></div></li>
<li><p>显示账号对应的手机号 和发送短信验证码按钮 和短信验证码输入框</p>

<div class="mermaid sequence" title="点击查看大图" data-processed="true"><svg id="mermaidChart1" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:500px;" viewBox="-75 -10 500 626"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor2" x1="75" y1="5" x2="75" y2="615" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor3" x1="275" y1="5" x2="275" y2="615" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="75" y="93" class="messageText" style="text-anchor: middle;">隐藏手机号</text><path d="M 75,100 C 135,90 135,130 75,120" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="158" class="messageText" style="text-anchor: middle;">mobile</text><line x1="75" y1="165" x2="275" y2="165" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="193" class="messageText" style="text-anchor: middle;">校验</text><path d="M 275,200 C 335,190 335,230 275,220" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="258" class="messageText" style="text-anchor: middle;">发送短信验证码</text><path d="M 275,265 C 335,255 335,295 275,285" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="323" class="messageText" style="text-anchor: middle;">ok</text><line x1="275" y1="330" x2="75" y2="330" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="358" class="messageText" style="text-anchor: middle;">手机号 + 用户输入的验证码</text><line x1="75" y1="365" x2="275" y2="365" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="393" class="messageText" style="text-anchor: middle;">校验</text><path d="M 275,400 C 335,390 335,430 275,420" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="458" class="messageText" style="text-anchor: middle;">ok</text><line x1="275" y1="465" x2="75" y2="465" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="493" class="messageText" style="text-anchor: middle;">到第三步</text><path d="M 75,500 C 135,490 135,530 75,520" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><rect x="0" y="550" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="587.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="550" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="587.5" class="actor" style="text-anchor: middle;">后端 </text></g></svg></div></li></ol></li>
<li><p>问题</p>

<ol><li>手机号不能完全显示(后端发送给前端的就是部分隐藏的)</li>
<li>恶意用户可以跳过第一步，直接进入第二步</li></ol></li>
<li><p>问题解决的设计</p>

<ol><li><p>显示账号和验证码的填写框</p>

<div class="mermaid sequence" title="点击查看大图" data-processed="true"><svg id="mermaidChart2" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:500px;" viewBox="-75 -10 500 431"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor4" x1="75" y1="5" x2="75" y2="420" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor5" x1="275" y1="5" x2="275" y2="420" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">image_code_id</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="128" class="messageText" style="text-anchor: middle;">图片</text><line x1="275" y1="135" x2="75" y2="135" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="163" class="messageText" style="text-anchor: middle;">image_code_id + text + username</text><line x1="75" y1="170" x2="275" y2="170" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="198" class="messageText" style="text-anchor: middle;">校验</text><path d="M 275,205 C 335,195 335,235 275,225" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="263" class="messageText" style="text-anchor: middle;">!!部分手机号 + access_token</text><line x1="275" y1="270" x2="75" y2="270" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="298" class="messageText" style="text-anchor: middle;">到第二步</text><path d="M 75,305 C 135,295 135,335 75,325" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><rect x="0" y="355" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="392.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="355" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="392.5" class="actor" style="text-anchor: middle;">后端 </text></g></svg></div></li>
<li><p>显示账号对应的手机号 和发送短信验证码按钮 和短信验证码输入框</p>

<div class="mermaid sequence" title="点击查看大图" data-processed="true"><svg id="mermaidChart3" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:500px;" viewBox="-75 -10 500 691"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor6" x1="75" y1="5" x2="75" y2="680" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor7" x1="275" y1="5" x2="275" y2="680" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="75" y="93" class="messageText" style="text-anchor: middle;">显示部分手机号</text><path d="M 75,100 C 135,90 135,130 75,120" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="158" class="messageText" style="text-anchor: middle;">!! access_token</text><line x1="75" y1="165" x2="275" y2="165" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="193" class="messageText" style="text-anchor: middle;">校验</text><path d="M 275,200 C 335,190 335,230 275,220" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="258" class="messageText" style="text-anchor: middle;">!! 得到手机号</text><path d="M 275,265 C 335,255 335,295 275,285" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="323" class="messageText" style="text-anchor: middle;">发送短信验证码</text><path d="M 275,330 C 335,320 335,360 275,350" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="388" class="messageText" style="text-anchor: middle;">ok</text><line x1="275" y1="395" x2="75" y2="395" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="423" class="messageText" style="text-anchor: middle;">! username + 用户输入的验证码</text><line x1="75" y1="430" x2="275" y2="430" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="458" class="messageText" style="text-anchor: middle;">校验</text><path d="M 275,465 C 335,455 335,495 275,485" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="523" class="messageText" style="text-anchor: middle;">某信息</text><line x1="275" y1="530" x2="75" y2="530" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="558" class="messageText" style="text-anchor: middle;">到第三步</text><path d="M 75,565 C 135,555 135,595 75,585" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><rect x="0" y="615" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="652.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="615" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="652.5" class="actor" style="text-anchor: middle;">后端 </text></g></svg></div></li></ol></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="naf4" id="10itsdangerous模块的使用">10_itsdangerous模块的使用</h2><ul data-anchor-id="u2o0">
<li><p>itsdangerous <br>
一个生成各种jwt的模块</p></li>
<li><p>使用步骤</p>

<ol><li>安装 <br>
<code>pip install itsdangerous</code></li>
<li><p>生成jwt</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> itsdangerous </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">TimedJSONWebSignatureSerializer</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> </span><span class="typ">Serializer</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">conf </span><span class="kwd">import</span><span class="pln"> settings</span></code></li><li class="L2"><code></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="com"># serializer = Serializer(秘钥, 有效期秒)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Serializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> </span><span class="lit">300</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="com"># serializer.dumps(数据), 返回bytes类型</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">token </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">dumps</span><span class="pun">({</span><span class="str">'mobile'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'18512345678'</span><span class="pun">})</span></code></li><li class="L1"><code><span class="pln">token </span><span class="pun">=</span><span class="pln"> token</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">()</span></code></li></ol></pre></li>
<li><p>校验jwt/获取jwt中的载荷</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> itsdangerous </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">TimedJSONWebSignatureSerializer</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> </span><span class="typ">Serializer</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">conf </span><span class="kwd">import</span><span class="pln"> settings</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="com"># 检验token</span></code></li><li class="L4"><code></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="com"># 验证失败，会抛出itsdangerous.BadData异常</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Serializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> </span><span class="lit">300</span><span class="pun">)</span></code></li><li class="L9"><code><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">    data </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">token</span><span class="pun">)</span></code></li><li class="L1"><code><span class="kwd">except</span><span class="pln"> </span><span class="typ">BadData</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">None</span></code></li></ol></pre></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="xefr" id="11忘记密码第一步获取发送短信验证码凭据的后端接口实现">11_忘记密码第一步获取发送短信验证码凭据的后端接口实现</h2><ul data-anchor-id="2ade">
<li>设计 <br>
<ul><li>请求 GET /accounts/{account}/sms/token/?iamge_code_id={iamge_code_id}&amp;text={text}</li>
<li>响应 {'mobile': mobile, 'access_token': access_token}</li></ul></li>
<li><p>实现</p>

<ul><li><p>users.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">import</span><span class="pln"> re</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> rest_framework</span><span class="pun">.</span><span class="pln">generics </span><span class="kwd">import</span><span class="pln">  </span><span class="typ">GenericAPIView</span></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> rest_framework</span><span class="pun">.</span><span class="pln">response </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Response</span></code></li><li class="L3"><code><span class="kwd">from</span><span class="pln"> </span><span class="pun">.</span><span class="pln">utils </span><span class="kwd">import</span><span class="pln"> get_user_by_account</span></code></li><li class="L4"><code><span class="kwd">from</span><span class="pln"> verifications</span><span class="pun">.</span><span class="pln">serializer </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">CheckImageCodeSerialzier</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">SMSCodeTokenView</span><span class="pun">(</span><span class="typ">GenericAPIView</span><span class="pun">):</span></code></li><li class="L7"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CheckImageCodeSerialzier</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> account</span><span class="pun">):</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com"># 校验图片验证码</span></code></li><li class="L1"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">get_serializer</span><span class="pun">(</span><span class="pln">data</span><span class="pun">=</span><span class="pln">request</span><span class="pun">.</span><span class="pln">query_params</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        serializer</span><span class="pun">.</span><span class="pln">is_valid</span><span class="pun">(</span><span class="pln">raise_exception</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">        user </span><span class="pun">=</span><span class="pln"> get_user_by_account</span><span class="pun">(</span><span class="pln">account</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> user </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'message'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'用户不存在'</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_404_NOT_FOUND</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 生成发送短信的access_token</span></code></li><li class="L9"><code><span class="pln">        access_token </span><span class="pun">=</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">generate_send_sms_code_token</span><span class="pun">()</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="com"># 处理手机号</span></code></li><li class="L2"><code><span class="pln">        mobile </span><span class="pun">=</span><span class="pln"> re</span><span class="pun">.</span><span class="kwd">sub</span><span class="pun">(</span><span class="pln">r</span><span class="str">'(\d{3})\d{4}(\d{4})'</span><span class="pun">,</span><span class="pln"> r</span><span class="str">'\1****\2'</span><span class="pun">,</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">mobile</span><span class="pun">)</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'mobile'</span><span class="pun">:</span><span class="pln"> mobile</span><span class="pun">,</span><span class="pln"> </span><span class="str">'access_token'</span><span class="pun">:</span><span class="pln"> access_token</span><span class="pun">})</span></code></li></ol></pre></li>
<li><p>users.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^accounts/(?P&lt;account&gt;\w{4,20})/sms/token/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">SMSCodeTokenView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">())</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li>
<li><p>verifications.serializer.py <br>
修改之前的代码</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CheckImageCodeSerialzier</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">Serializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> attrs</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">...</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># mobile = self.context['view'].kwargs['mobile']</span></code></li><li class="L5"><code><span class="pln">        </span><span class="com"># send_flag = redis_conn.get('send_flag_%s' % mobile)</span></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># if send_flag:</span></code></li><li class="L7"><code><span class="pln">        </span><span class="com">#    raise serializers.ValidationError('发送短信次数过于频繁')</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 使其成为可选的</span></code></li><li class="L0"><code><span class="pln">        mobile </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">context</span><span class="pun">[</span><span class="str">'view'</span><span class="pun">].</span><span class="pln">kwargs</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'mobile'</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> mobile</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">            send_flag </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'send_flag_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> send_flag</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">                </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'发送短信次数过于频繁'</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> attrs</span></code></li></ol></pre></li>
<li><p>users.models.py <br>
添加生成token的方法</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> itsdangerous </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">TimedJSONWebSignatureSerializer</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> </span><span class="typ">Serializer</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">conf </span><span class="kwd">import</span><span class="pln"> settings</span></code></li><li class="L2"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">User</span><span class="pun">(</span><span class="typ">AbstractUser</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> generate_send_sms_code_token</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L6"><code><span class="str">        生成发送短信验证码的token</span></code></li><li class="L7"><code><span class="str">        """</span></code></li><li class="L8"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Serializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> expires_in</span><span class="pun">=</span><span class="lit">300</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        data </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'mobile'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">mobile</span><span class="pun">}</span></code></li><li class="L0"><code><span class="pln">        token </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">dumps</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> token</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">()</span></code></li></ol></pre></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="3ey7" id="12忘记密码第一步的前端实现">12_忘记密码第一步的前端实现</h2><ul data-anchor-id="lbrr">
<li><p>非重点代码 <br>
html + vue 变量</p></li>
<li><p>值得关注的代码 <br>
html中是在一个页面中显示了4步 <br>
通过显示隐藏来区分每一步的</p>

<p>点击下一步对应的事件</p>

<ol><li>校验用户名和验证码的格式</li>
<li>如果不通过则结束</li>
<li>如果通过则使用axios向后端发送请求 <br>
<ol><li>拼接url</li>
<li>成功记录手机后和access_token,并进入下一步</li>
<li>失败显示错误信息</li></ol></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="e9dv" id="13凭借accesstoken发送短信验证码的后端实现">13_凭借access_token发送短信验证码的后端实现</h2><ul data-anchor-id="530r">
<li><p>发送短信验证码 <br>
是业务第二个步骤中的第一个前后端交互</p>

<ul><li>设计 <br>
<ul><li>请求 GET /sms_codes/?access_token={access_token}</li>
<li>响应 {"message":message}</li></ul></li>
<li><p>实现</p>

<ul><li><p>verifications.views.py <br>
注意这里并没有使用序列化器进行操作</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">SMSCodeByTokenView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 验证access_token</span></code></li><li class="L3"><code><span class="pln">        access_token </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">query_params</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'access_token'</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> access_token</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'message'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'缺少access token'</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_400_BAD_REQUEST</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        mobile </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="pln">check_send_sms_code_token</span><span class="pun">(</span><span class="pln">access_token</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> mobile</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'message'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'access token无效'</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_400_BAD_REQUEST</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 判断是否在60s内</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com"># 复制的代码 略</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 生成短信验证码</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 复制的代码 略</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">        </span><span class="com"># 保存短信验证码与发送记录</span></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 复制的代码 略</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 发送短信验证码</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 复制的代码 略</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">"message"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"OK"</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">.</span><span class="pln">HTTP_200_OK</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>verifications.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'sms_codes/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">SMSCodeByTokenView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li>
<li><p>users.models.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">User</span><span class="pun">(</span><span class="typ">AbstractUser</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L2"><code><span class="pln">    </span><span class="lit">@staticmethod</span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> check_send_sms_code_token</span><span class="pun">(</span><span class="pln">token</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L5"><code><span class="str">        检验发送短信验证码的token</span></code></li><li class="L6"><code><span class="str">        """</span></code></li><li class="L7"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Serializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> expires_in</span><span class="pun">=</span><span class="pln">constants</span><span class="pun">.</span><span class="pln">SEND_SMS_TOKEN_EXPIRES</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">            data </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">token</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">BadData</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">None</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'mobile'</span><span class="pun">)</span></code></li></ol></pre></li></ul></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="fmsy" id="14发送短信的前端代码">14_发送短信的前端代码</h2><ul data-anchor-id="8vb8">
<li>略 <br>
与之前的注册类似，url不同</li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="kq5k" id="15获取修改密码调用凭据的后端实现">15_获取修改密码调用凭据的后端实现</h2><ul data-anchor-id="nlo7">
<li><p>获取修改密码的凭据 <br>
是业务第二个步骤中的第二个前后端交互，也是为第三个步骤服务的</p></li>
<li><p>流程图</p>

<div class="mermaid sequence" title="点击查看大图" data-processed="true"><svg id="mermaidChart4" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:480.5px;" viewBox="-50 -10 480.5 491"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor8" x1="75" y1="5" x2="75" y2="480" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor9" x1="275" y1="5" x2="275" y2="480" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">username + text</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="128" class="messageText" style="text-anchor: middle;">username -&gt; User模型</text><path d="M 275,135 C 335,125 335,165 275,155" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="193" class="messageText" style="text-anchor: middle;">User模型 -&gt; mobile</text><path d="M 275,200 C 335,190 335,230 275,220" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="258" class="messageText" style="text-anchor: middle;">mobile + redis 校验text</text><path d="M 275,265 C 335,255 335,295 275,285" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="323" class="messageText" style="text-anchor: middle;">校验通过，生成access_token</text><path d="M 275,330 C 335,320 335,360 275,350" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="388" class="messageText" style="text-anchor: middle;">user_id + access_token</text><line x1="275" y1="395" x2="75" y2="395" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="0" y="415" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="452.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="415" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="452.5" class="actor" style="text-anchor: middle;">后端 </text></g></svg></div>

<p>注意 <br>
    1. username 是步骤一的，讲课的时候老师说是account <br>
    2. 这里的access_token 与之前的是不同的，这个凭据的作用是用于后面有权限修改密码，之前的是发送短信验证码</p></li>
<li><p>设计</p>

<ul><li>请求 GET accounts/(?P\w{5,20})/password/token/?text={text}</li>
<li>响应 {"user_id":user_id ,"access_token":access_token}</li></ul></li>
<li><p>实现</p>

<ul><li><p>users.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">PasswordTokenView</span><span class="pun">(</span><span class="typ">GenericAPIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    用户帐号设置密码的token</span></code></li><li class="L3"><code><span class="str">    """</span></code></li><li class="L4"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CheckSMSCodeSerializer</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> account</span><span class="pun">):</span></code></li><li class="L7"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L8"><code><span class="str">        根据用户帐号获取修改密码的token</span></code></li><li class="L9"><code><span class="str">        """</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com"># 校验短信验证码</span></code></li><li class="L1"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">get_serializer</span><span class="pun">(</span><span class="pln">data</span><span class="pun">=</span><span class="pln">request</span><span class="pun">.</span><span class="pln">query_params</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        serializer</span><span class="pun">.</span><span class="pln">is_valid</span><span class="pun">(</span><span class="pln">raise_exception</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">        user </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">user</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 生成修改用户密码的access token</span></code></li><li class="L7"><code><span class="pln">        access_token </span><span class="pun">=</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">generate_set_password_token</span><span class="pun">()</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'user_id'</span><span class="pun">:</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> </span><span class="str">'access_token'</span><span class="pun">:</span><span class="pln"> access_token</span><span class="pun">})</span></code></li></ol></pre></li>
<li><p>users.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^accounts/(?P&lt;account&gt;\w{4,20})/password/token/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">PasswordTokenView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li>
<li><p>users.serializers.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">CheckSMSCodeSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">Serializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    检查sms code</span></code></li><li class="L3"><code><span class="str">    """</span></code></li><li class="L4"><code><span class="pln">    sms_code </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">min_length</span><span class="pun">=</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> max_length</span><span class="pun">=</span><span class="lit">6</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate_sms_code</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">):</span></code></li><li class="L7"><code><span class="pln">        account </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">context</span><span class="pun">[</span><span class="str">'view'</span><span class="pun">].</span><span class="pln">kwargs</span><span class="pun">[</span><span class="str">'account'</span><span class="pun">]</span></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 获取user</span></code></li><li class="L9"><code><span class="pln">        user </span><span class="pun">=</span><span class="pln"> get_user_by_account</span><span class="pun">(</span><span class="pln">account</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> user </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'用户不存在'</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 把user 对象保存到序列化器对象中</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">user </span><span class="pun">=</span><span class="pln"> user</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 校验短信验证码</span></code></li><li class="L7"><code><span class="pln">        redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'verify_codes'</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        real_sms_code </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'sms_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">mobile</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> real_sms_code </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'无效的短信验证码'</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> value </span><span class="pun">!=</span><span class="pln"> real_sms_code</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">():</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'短信验证码错误'</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> value</span></code></li></ol></pre></li>
<li><p>users.models.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">User</span><span class="pun">(</span><span class="typ">AbstractUser</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> generate_set_password_token</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L3"><code><span class="str">        生成修改密码的token</span></code></li><li class="L4"><code><span class="str">        """</span></code></li><li class="L5"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TJWSSerializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> expires_in</span><span class="pun">=</span><span class="pln">constants</span><span class="pun">.</span><span class="pln">SET_PASSWORD_TOKEN_EXPIRES</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        data </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'user_id'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">id</span><span class="pun">}</span></code></li><li class="L7"><code><span class="pln">        token </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">dumps</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> token</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">()</span></code></li></ol></pre></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="ghrj" id="16获取修改密码调用凭据的前端实现">16_获取修改密码调用凭据的前端实现</h2><ul data-anchor-id="0iea">
<li>略 <br>
如流程图</li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="1d1a" id="17重置密码">17_重置密码</h2><ul data-anchor-id="ukd5">
<li>流程图</li>
</ul><div class="md-section-divider"></div><div class="mermaid sequence" title="点击查看大图" data-anchor-id="b59j" data-processed="true"><svg id="mermaidChart5" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:505.5px;" viewBox="-75 -10 505.5 686"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor10" x1="75" y1="5" x2="75" y2="675" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor11" x1="275" y1="5" x2="275" y2="675" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">password +  password2 + user_id + access_token</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="128" class="messageText" style="text-anchor: middle;">password ? password2</text><path d="M 275,135 C 335,125 335,165 275,155" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="193" class="messageText" style="text-anchor: middle;">access_token -&gt; USER_ID</text><path d="M 275,200 C 335,190 335,230 275,220" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="258" class="messageText" style="text-anchor: middle;">user_id ? USER_ID</text><path d="M 275,265 C 335,255 335,295 275,285" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="323" class="messageText" style="text-anchor: middle;">校验通过</text><path d="M 275,330 C 335,320 335,360 275,350" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="388" class="messageText" style="text-anchor: middle;">user_id-&gt; 模型 User</text><path d="M 275,395 C 335,385 335,425 275,415" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="453" class="messageText" style="text-anchor: middle;">user.set_password  user.save</text><path d="M 275,460 C 335,450 335,490 275,480" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="518" class="messageText" style="text-anchor: middle;">ok</text><line x1="275" y1="525" x2="75" y2="525" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="553" class="messageText" style="text-anchor: middle;">步骤四</text><path d="M 75,560 C 135,550 135,590 75,580" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><rect x="0" y="610" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="647.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="610" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="647.5" class="actor" style="text-anchor: middle;">后端 </text></g></svg></div><ul data-anchor-id="qdnx">
<li><p>设计</p>

<ul><li>请求 POST /users/{user_id}/password?password={password}&amp;password2={password2}&amp;access_token={access_token}</li>
<li>响应 {"message":message}</li></ul></li>
<li><p>实现</p>

<ul><li><p>users.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">PasswordView</span><span class="pun">(</span><span class="pln">mixins</span><span class="pun">.</span><span class="typ">UpdateModelMixin</span><span class="pun">,</span><span class="pln"> </span><span class="typ">GenericAPIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    queryset </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">all</span><span class="pun">()</span></code></li><li class="L2"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ResetPasswordSerializer</span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> post</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">,</span><span class="pln"> pk</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">update</span><span class="pun">(</span><span class="pln">request</span><span class="pun">,</span><span class="pln"> pk</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>users.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'users/(?P&lt;pk&gt;\d+)/password/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">PasswordView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span><span class="pln">  </span><span class="com"># 重置密码</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li>
<li><p>users.serializers.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">ResetPasswordSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">ModelSerializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    password2 </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'确认密码'</span><span class="pun">,</span><span class="pln">  write_only</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">    access_token </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'操作token'</span><span class="pun">,</span><span class="pln">  write_only</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">        model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span></code></li><li class="L5"><code><span class="pln">        fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'password'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'password2'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'access_token'</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        extra_kwargs </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">            </span><span class="str">'password'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">                </span><span class="str">'write_only'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">True</span><span class="pun">,</span></code></li><li class="L9"><code><span class="pln">                </span><span class="str">'min_length'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">8</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">                </span><span class="str">'max_length'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">20</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">                </span><span class="str">'error_messages'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">                    </span><span class="str">'min_length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'仅允许8-20个字符的密码'</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">                    </span><span class="str">'max_length'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'仅允许8-20个字符的密码'</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">                </span><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> attrs</span><span class="pun">):</span></code></li><li class="L9"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L0"><code><span class="str">        校验数据</span></code></li><li class="L1"><code><span class="str">        """</span></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 判断两次密码</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> attrs</span><span class="pun">[</span><span class="str">'password'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> attrs</span><span class="pun">[</span><span class="str">'password2'</span><span class="pun">]:</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'两次密码不一致'</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 判断access token</span></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 需要对比 access token中的userid 与请求用户的id是否一致</span></code></li><li class="L8"><code><span class="pln">        allow </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="pln">check_set_password_token</span><span class="pun">(</span><span class="pln">attrs</span><span class="pun">[</span><span class="str">'access_token'</span><span class="pun">],</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">context</span><span class="pun">[</span><span class="str">'view'</span><span class="pun">].</span><span class="pln">kwargs</span><span class="pun">[</span><span class="str">'pk'</span><span class="pun">])</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> allow</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'无效的access token'</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> attrs</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> update</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> instance</span><span class="pun">,</span><span class="pln"> validated_data</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 调用django 用户模型类的设置密码方法</span></code></li><li class="L5"><code><span class="pln">        instance</span><span class="pun">.</span><span class="pln">set_password</span><span class="pun">(</span><span class="pln">validated_data</span><span class="pun">[</span><span class="str">'password'</span><span class="pun">])</span></code></li><li class="L6"><code><span class="pln">        instance</span><span class="pun">.</span><span class="pln">save</span><span class="pun">()</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> instance</span></code></li></ol></pre></li>
<li><p>users.models.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">User</span><span class="pun">(</span><span class="typ">AbstractUser</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="lit">@staticmethod</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> check_set_password_token</span><span class="pun">(</span><span class="pln">token</span><span class="pun">,</span><span class="pln"> user_id</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L4"><code><span class="str">        检验设置密码的token</span></code></li><li class="L5"><code><span class="str">        """</span></code></li><li class="L6"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TJWSSerializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> expires_in</span><span class="pun">=</span><span class="pln">constants</span><span class="pun">.</span><span class="pln">SET_PASSWORD_TOKEN_EXPIRES</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">            data </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">token</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">BadData</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">False</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> user_id </span><span class="pun">!=</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'user_id'</span><span class="pun">)):</span></code></li><li class="L3"><code><span class="pln">                </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">False</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">                </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">True</span></code></li></ol></pre></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="hknu" id="重置密码的总结">重置密码的总结</h2><ul data-anchor-id="e89m">
<li><p>为什么这么复杂</p>

<ol><li>确保是用户本人 <br>
<ol><li>知道用户名</li>
<li>知道密码 ?</li>
<li>掌握注册的时候的手机</li></ol></li>
<li>节省发送短信的费用 <br>
<ol><li>验证码</li></ol></li>
<li>防止恶意人士捣乱 <br>
<ol><li>jwt</li></ol></li></ol></li>
<li><p>信息换</p>

<ol><li>得到 图形验证码id</li>
<li>图形验证码id + 图形验证码文字 + 用户名  换 手机号 + access_token_phone</li>
<li>access_token_phone + 短信验证码  换 更改密码的 access_token_password + user_id</li>
<li>access_token_password + user_id + password + password2  换 新密码</li></ol></li>
<li><p>整体流程</p>

<div class="mermaid sequence" title="点击查看大图" data-processed="true"><svg id="mermaidChart6" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:545px;" viewBox="-75 -10 545 1681"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor12" x1="75" y1="5" x2="75" y2="1670" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor13" x1="275" y1="5" x2="275" y2="1670" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">image_code_id</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="128" class="messageText" style="text-anchor: middle;">图片</text><line x1="275" y1="135" x2="75" y2="135" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="163" class="messageText" style="text-anchor: middle;">image_code_id + text + username</text><line x1="75" y1="170" x2="275" y2="170" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="198" class="messageText" style="text-anchor: middle;">校验</text><path d="M 275,205 C 335,195 335,235 275,225" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="263" class="messageText" style="text-anchor: middle;">部分手机号 + access_token_phone</text><line x1="275" y1="270" x2="75" y2="270" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="298" class="messageText" style="text-anchor: middle;">到第二步</text><path d="M 75,305 C 135,295 135,335 75,325" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="75" y="363" class="messageText" style="text-anchor: middle;">显示部分手机号</text><path d="M 75,370 C 135,360 135,400 75,390" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="428" class="messageText" style="text-anchor: middle;">access_token_phone</text><line x1="75" y1="435" x2="275" y2="435" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="463" class="messageText" style="text-anchor: middle;">校验</text><path d="M 275,470 C 335,460 335,500 275,490" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="528" class="messageText" style="text-anchor: middle;">得到手机号</text><path d="M 275,535 C 335,525 335,565 275,555" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="593" class="messageText" style="text-anchor: middle;">发送短信验证码</text><path d="M 275,600 C 335,590 335,630 275,620" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="658" class="messageText" style="text-anchor: middle;">ok</text><line x1="275" y1="665" x2="75" y2="665" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="693" class="messageText" style="text-anchor: middle;">username + text</text><line x1="75" y1="700" x2="275" y2="700" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="728" class="messageText" style="text-anchor: middle;">username -&gt; User模型</text><path d="M 275,735 C 335,725 335,765 275,755" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="793" class="messageText" style="text-anchor: middle;">User模型 -&gt; mobile</text><path d="M 275,800 C 335,790 335,830 275,820" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="858" class="messageText" style="text-anchor: middle;">mobile + redis 校验text</text><path d="M 275,865 C 335,855 335,895 275,885" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="923" class="messageText" style="text-anchor: middle;">校验通过，生成access_token_password</text><path d="M 275,930 C 335,920 335,960 275,950" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="988" class="messageText" style="text-anchor: middle;">user_id + access_token_password</text><line x1="275" y1="995" x2="75" y2="995" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="1023" class="messageText" style="text-anchor: middle;">到第三步</text><path d="M 75,1030 C 135,1020 135,1060 75,1050" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="1088" class="messageText" style="text-anchor: middle;">password +  password2 + user_id + access_token_password</text><line x1="75" y1="1095" x2="275" y2="1095" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="1123" class="messageText" style="text-anchor: middle;">password ? password2</text><path d="M 275,1130 C 335,1120 335,1160 275,1150" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="1188" class="messageText" style="text-anchor: middle;">access_token -&gt; USER_ID</text><path d="M 275,1195 C 335,1185 335,1225 275,1215" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="1253" class="messageText" style="text-anchor: middle;">user_id ? USER_ID</text><path d="M 275,1260 C 335,1250 335,1290 275,1280" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="1318" class="messageText" style="text-anchor: middle;">校验通过</text><path d="M 275,1325 C 335,1315 335,1355 275,1345" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="1383" class="messageText" style="text-anchor: middle;">user_id-&gt; 模型 User</text><path d="M 275,1390 C 335,1380 335,1420 275,1410" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="1448" class="messageText" style="text-anchor: middle;">user.set_password  user.save</text><path d="M 275,1455 C 335,1445 335,1485 275,1475" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="1513" class="messageText" style="text-anchor: middle;">ok</text><line x1="275" y1="1520" x2="75" y2="1520" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="1548" class="messageText" style="text-anchor: middle;">到第四步</text><path d="M 75,1555 C 135,1545 135,1585 75,1575" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><rect x="0" y="1605" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="1642.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="1605" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="1642.5" class="actor" style="text-anchor: middle;">后端 </text></g></svg></div></li>
</ul></div>
<a href="8.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="10.html">下一页</a><br>
</body>
</html>