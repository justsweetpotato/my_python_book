<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
    <a href="10.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="12.html">下一页</a>
<title>Django-4.0-Day11</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="gvlc" id="django-40-day11">Django-4.0-Day11</h1><p data-anchor-id="9und"><code>django</code></p><hr><div class="md-section-divider"></div><h2 data-anchor-id="xzlm" id="复习">复习</h2><ul data-anchor-id="bdlw">
<li>第三方登录(QQ登录) <br>
<ul><li>概念</li>
<li>按照流程图开发 <br>
<img src="http://static.zybuluo.com/jsutqb/m5tv1fo9phvcpxo2m49w9th2/image_1chfmm4nc9s02d9prroff1kcn9.png" alt="image_1chfmm4nc9s02d9prroff1kcn9.png-167.9kB"></li>
<li>模型关系</li></ul></li>
<li><p>第三方登录后的绑定</p>

<ul><li>按照流程图开发 <br>
<div class="mermaid sequence" title="点击查看大图" data-processed="true"><svg id="mermaidChart0" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:567.5px;" viewBox="-75 -10 567.5 956"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor0" x1="75" y1="5" x2="75" y2="945" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor1" x1="275" y1="5" x2="275" y2="945" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">image_code_id</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="128" class="messageText" style="text-anchor: middle;">验证码图片</text><line x1="275" y1="135" x2="75" y2="135" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="163" class="messageText" style="text-anchor: middle;">image_code_id + text + mobile</text><line x1="75" y1="170" x2="275" y2="170" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="198" class="messageText" style="text-anchor: middle;">验证，通过发送短信</text><path d="M 275,205 C 335,195 335,235 275,225" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="263" class="messageText" style="text-anchor: middle;">ok</text><line x1="275" y1="270" x2="75" y2="270" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="298" class="messageText" style="text-anchor: middle;">mobile + password + sms_code + access_token_md</text><line x1="75" y1="305" x2="275" y2="305" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="333" class="messageText" style="text-anchor: middle;">校验access_token_md，通过可以拿到open_id</text><path d="M 275,340 C 335,330 335,370 275,360" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="398" class="messageText" style="text-anchor: middle;">校验短信验证码</text><path d="M 275,405 C 335,395 335,435 275,425" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="463" class="messageText" style="text-anchor: middle;">检查是否有此用户</text><path d="M 275,470 C 335,460 335,500 275,490" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="528" class="messageText" style="text-anchor: middle;">1没有:创建User,创建OAuthQQUser(open_id)</text><path d="M 275,535 C 335,525 335,565 275,555" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="593" class="messageText" style="text-anchor: middle;">1有:创建OAuthQQUser (open_id)</text><path d="M 275,600 C 335,590 335,630 275,620" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="658" class="messageText" style="text-anchor: middle;">生成token</text><path d="M 275,665 C 335,655 335,695 275,685" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="723" class="messageText" style="text-anchor: middle;">token + user_id + username</text><line x1="275" y1="730" x2="75" y2="730" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="758" class="messageText" style="text-anchor: middle;">存储登录信息</text><path d="M 75,765 C 135,755 135,795 75,785" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="75" y="823" class="messageText" style="text-anchor: middle;">跳转</text><path d="M 75,830 C 135,820 135,860 75,850" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><rect x="0" y="880" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="917.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="880" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="917.5" class="actor" style="text-anchor: middle;">后端 </text></g></svg></div></li></ul></li>
<li><p>知识</p>

<ul><li>urllib的使用</li>
<li>加强对jwt的认识</li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="a0im" id="今日内容">今日内容</h2><ul data-anchor-id="8ra7">
<li>业务 <br>
<ul><li>用户中心 <br>
<ul><li>电子邮箱验证</li>
<li>收货地址管理</li></ul></li></ul></li>
<li>技能点 <br>
django中 用户体系(扩展) <br>
django 与 发送邮件 <br>
rest 缓存</li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="ahws" id="01用户个人中心业务实现的逻辑分析和接口设计">01_用户个人中心业务实现的逻辑分析和接口设计</h2><ul data-anchor-id="uujg">
<li><p>后端 用户中心-个人信息展示 </p>

<ul><li><p>修改数据库模型</p>

<ul><li>代码 <br>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">User</span><span class="pun">(</span><span class="typ">AbstractUser</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    用户信息</span></code></li><li class="L3"><code><span class="str">    """</span></code></li><li class="L4"><code><span class="pln">    mobile </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> unique</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"手机号"</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    email_active </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">BooleanField</span><span class="pun">(</span><span class="kwd">default</span><span class="pun">=</span><span class="kwd">False</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'邮箱验证状态'</span><span class="pun">)</span></code></li></ol></pre></li></ul></li>
<li><p>进行数据迁移 <br>
<code>python manage.py makemigrations <br>
python manage.py migrate</code></p></li>
<li><p>个人信息展示 </p>

<ul><li>设计 <br>
<ul><li>请求 GET /user/</li>
<li>响应 {"id":id,"username":username,"mobile":mobile,"email":email,"email_active":email_active}</li></ul></li></ul></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="dp3b" id="02用户个人中心业务前后端实现">02_用户个人中心业务前后端实现</h2><ul data-anchor-id="le80">
<li><p>后端实现</p>

<ul><li><p>users.views.py</p>

<ul><li>指定serializer_class </li>
<li>指定permission_classes  <br>
只有登陆用户能够进行访问 <br>
前端如何添加认证信息得后面实现 <br>
关于认证信息的校验我们交给 dev.py中配置的整体校验类去实现</li>
<li>重写get_object 方法获得用户</li></ul>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">UserDetailView</span><span class="pun">(</span><span class="typ">RetrieveAPIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""用户详情信息</span></code></li><li class="L2"><code><span class="str">    """</span></code></li><li class="L3"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">UserDetailSerializer</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com"># 补充通过认证才能访问接口的权限</span></code></li><li class="L5"><code><span class="pln">    permission_classes </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">IsAuthenticated</span><span class="pun">]</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> get_object</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L9"><code><span class="str">        返回请求的用户对象</span></code></li><li class="L0"><code><span class="str">        :return: user</span></code></li><li class="L1"><code><span class="str">        """</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="pln">user</span></code></li></ol></pre></li>
<li><p>users.serializers.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">UserDetailSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">ModelSerializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""用户个人信息序列化器"""</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">        model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 只需要暴露这些字段</span></code></li><li class="L5"><code><span class="pln">        fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'username'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'mobile'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'email'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'email_active'</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>users.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^user/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">UserDetailView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span><span class="pln">  </span><span class="com"># 用户个人中心数据</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li></ul></li>
</ul><ul data-anchor-id="s4gt">
<li>前端实现 <br>
<ul><li>页面加载(vue生命周期) <br>
<ol><li>从sessionStorage或localStorage拿到token</li>
<li>如果能拿到(说明之前登录了) <br>
<ol><li>把token值添加到Authorization头中 ，并需要在前面添加上 "JWT " (不含引号)</li>
<li>访问用户详情后端</li>
<li>成功显示信息</li>
<li>失败跳转到登陆页面(说明伪造、过期等)，携带next</li></ol></li>
<li>如果拿不到(说明之前没登录) <br>
<ol><li>转到登陆页面，携带next</li></ol></li></ol></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="mk9u" id="03保存邮箱发送验证邮件的业务说明">03_保存邮箱发送验证邮件的业务说明</h2><ul data-anchor-id="fcxk">
<li>业务逻辑</li>
</ul><div class="md-section-divider"></div><div class="mermaid sequence" title="点击查看大图" data-anchor-id="bxih" data-processed="true"><svg id="mermaidChart1" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:675px;" viewBox="-75 -10 675 856"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor2" x1="75" y1="5" x2="75" y2="845" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">用户 </text></g><g><line id="actor3" x1="275" y1="5" x2="275" y2="845" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">美多</text></g><g><line id="actor4" x1="475" y1="5" x2="475" y2="845" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="400" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="37.5" class="actor" style="text-anchor: middle;">邮箱服务</text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="75" y="93" class="messageText" style="text-anchor: middle;">点击设置</text><path d="M 75,100 C 135,90 135,130 75,120" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="75" y="158" class="messageText" style="text-anchor: middle;">输入email，点击保存</text><path d="M 75,165 C 135,155 135,195 75,185" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="223" class="messageText" style="text-anchor: middle;">email (验证头必然要携带)</text><line x1="75" y1="230" x2="275" y2="230" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="258" class="messageText" style="text-anchor: middle;">校验数据</text><path d="M 275,265 C 335,255 335,295 275,285" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="375" y="323" class="messageText" style="text-anchor: middle;">发送验证邮件(jwt)</text><line x1="275" y1="330" x2="475" y2="330" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="358" class="messageText" style="text-anchor: middle;">刷新页面 显示待验证</text><path d="M 75,365 C 135,355 135,395 75,385" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="75" y="423" class="messageText" style="text-anchor: middle;">可以点击重新验证</text><path d="M 75,430 C 135,420 135,460 75,450" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="488" class="messageText" style="text-anchor: middle;">打开邮箱</text><line x1="75" y1="495" x2="475" y2="495" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="523" class="messageText" style="text-anchor: middle;">显示链接</text><line x1="475" y1="530" x2="75" y2="530" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="558" class="messageText" style="text-anchor: middle;">点击链接</text><line x1="75" y1="565" x2="275" y2="565" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="593" class="messageText" style="text-anchor: middle;">校验信息</text><path d="M 275,600 C 335,590 335,630 275,620" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="658" class="messageText" style="text-anchor: middle;">修改状态</text><path d="M 275,665 C 335,655 335,695 275,685" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="75" y="723" class="messageText" style="text-anchor: middle;">刷新页面 显示验证通过</text><path d="M 75,730 C 135,720 135,760 75,750" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><rect x="0" y="780" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="817.5" class="actor" style="text-anchor: middle;">用户 </text></g><g><rect x="200" y="780" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="817.5" class="actor" style="text-anchor: middle;">美多</text></g><g><rect x="400" y="780" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="817.5" class="actor" style="text-anchor: middle;">邮箱服务</text></g></svg></div><ul data-anchor-id="qlys">
<li>功能实现 <br>
<ol><li>发送邮件</li>
<li>jwt </li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="2ket" id="04django发送邮件的方法">04_Django发送邮件的方法</h2><ul data-anchor-id="mmhs">
<li><p>三个步骤</p>

<ol><li>准备smtp服务器 <br>
可以使用163/qq，需要经过配置</li>
<li><p>在项目中配置smtp服务器和账号</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">EMAIL_BACKEND </span><span class="pun">=</span><span class="pln"> </span><span class="str">'django.core.mail.backends.smtp.EmailBackend'</span></code></li><li class="L1"><code><span class="pln">EMAIL_HOST </span><span class="pun">=</span><span class="pln"> </span><span class="str">'smtp.163.com'</span></code></li><li class="L2"><code><span class="pln">EMAIL_PORT </span><span class="pun">=</span><span class="pln"> </span><span class="lit">25</span></code></li><li class="L3"><code><span class="pln"> </span><span class="com">#发送邮件的邮箱</span></code></li><li class="L4"><code><span class="pln">EMAIL_HOST_USER </span><span class="pun">=</span><span class="pln"> </span><span class="str">'itcast88@163.com'</span></code></li><li class="L5"><code><span class="pln"> </span><span class="com">#在邮箱中设置的客户端授权密码</span></code></li><li class="L6"><code><span class="pln">EMAIL_HOST_PASSWORD </span><span class="pun">=</span><span class="pln"> </span><span class="str">'python808'</span></code></li><li class="L7"><code><span class="pln"> </span><span class="com">#收件人看到的发件人</span></code></li><li class="L8"><code><span class="pln">EMAIL_FROM </span><span class="pun">=</span><span class="pln"> </span><span class="str">'python&lt;itcast88@163.com&gt;'</span></code></li></ol></pre></li>
<li><p>通过django内置的函数发送邮件 <br>
在django.core.mail模块提供了send_mail来发送邮件</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">send_mail</span><span class="pun">(</span><span class="pln">subject</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">,</span><span class="pln"> from_email</span><span class="pun">,</span><span class="pln"> recipient_list</span><span class="pun">,</span><span class="pln">html_message</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">)</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">subject </span><span class="pun">邮件标题</span></code></li><li class="L3"><code><span class="pln">message </span><span class="pun">普通邮件正文，</span><span class="pln"> </span><span class="pun">普通字符串</span></code></li><li class="L4"><code><span class="pln">from_email </span><span class="pun">发件人</span></code></li><li class="L5"><code><span class="pln">recipient_list </span><span class="pun">收件人列表</span></code></li><li class="L6"><code><span class="pln">html_message </span><span class="pun">多媒体邮件正文，可以是</span><span class="pln">html</span><span class="pun">字符串</span></code></li></ol></pre></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="h4gm" id="05后端保存邮箱的接口实现">05_后端保存邮箱的接口实现</h2><ul data-anchor-id="glq1">
<li>设计 <br>
<ul><li>请求 PUT /emails/  请求体中为{"email":email}</li>
<li>响应 {"id":id,"email":email}</li></ul></li>
<li><p>实现</p>

<ul><li><p>users.views.py</p>

<ul><li>需要登录</li>
<li>可以中request.user取出对象，获得id</li>
<li>校验的逻辑交给Serializer</li></ul>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">EmailView</span><span class="pun">(</span><span class="typ">UpdateAPIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    保存邮箱</span></code></li><li class="L3"><code><span class="str">    /email/</span></code></li><li class="L4"><code><span class="str">    """</span></code></li><li class="L5"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">EmailSerializer</span></code></li><li class="L6"><code><span class="pln">    permission_classes </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">IsAuthenticated</span><span class="pun">]</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> get_object</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="pln">user</span></code></li></ol></pre></li>
<li><p>users.serializers.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">EmailSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">ModelSerializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">        model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span></code></li><li class="L3"><code><span class="pln">        fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'email'</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        extra_kwargs </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">            </span><span class="str">'email'</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code><span class="pln">                </span><span class="str">'required'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">True</span></code></li><li class="L7"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> update</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> instance</span><span class="pun">,</span><span class="pln"> validated_data</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">        </span><span class="str">"""重新更新方法，添加发送邮件</span></code></li><li class="L2"><code><span class="str">        instance  == user</span></code></li><li class="L3"><code><span class="str">        """</span></code></li><li class="L4"><code><span class="pln">        email </span><span class="pun">=</span><span class="pln"> validated_data</span><span class="pun">[</span><span class="str">'email'</span><span class="pun">]</span></code></li><li class="L5"><code><span class="pln">        instance</span><span class="pun">.</span><span class="pln">email </span><span class="pun">=</span><span class="pln"> email</span></code></li><li class="L6"><code><span class="pln">        instance</span><span class="pun">.</span><span class="pln">save</span><span class="pun">()</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 生成激活链接</span></code></li><li class="L9"><code><span class="pln">        verify_url </span><span class="pun">=</span><span class="pln"> instance</span><span class="pun">.</span><span class="pln">generate_email_verify_url</span><span class="pun">()</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com"># 发送验证邮件</span></code></li><li class="L1"><code><span class="pln">        send_verify_email</span><span class="pun">.</span><span class="pln">delay</span><span class="pun">(</span><span class="pln">email</span><span class="pun">,</span><span class="pln"> verify_url</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> instance</span></code></li></ol></pre></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="p305" id="06定义发送邮件的异步任务">06_定义发送邮件的异步任务</h2><p data-anchor-id="fk8j">发送邮件需要联网，可以借助celery进行异步任务</p><ul data-anchor-id="vw2l">
<li><p>实现</p>

<ol><li><p>配置发送邮件相关</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code></code></li><li class="L1"><code><span class="com"># Email</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">EMAIL_BACKEND </span><span class="pun">=</span><span class="pln"> </span><span class="str">'django.core.mail.backends.smtp.EmailBackend'</span></code></li><li class="L4"><code><span class="pln">EMAIL_HOST </span><span class="pun">=</span><span class="pln"> </span><span class="str">'smtp.163.com'</span></code></li><li class="L5"><code><span class="pln">EMAIL_PORT </span><span class="pun">=</span><span class="pln"> </span><span class="lit">25</span></code></li><li class="L6"><code><span class="pln">EMAIL_HOST_USER </span><span class="pun">=</span><span class="pln"> </span><span class="str">'meiduo_admin@163.com'</span></code></li><li class="L7"><code><span class="pln">EMAIL_HOST_PASSWORD </span><span class="pun">=</span><span class="pln"> </span><span class="str">'meiduo123'</span></code></li><li class="L8"><code><span class="pln">EMAIL_FROM </span><span class="pun">=</span><span class="pln"> </span><span class="str">'美多商城&lt;meiduo_admin@163.com&gt;'</span></code></li></ol></pre></li>
<li><p>定义函数发送邮件</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">def</span><span class="pln"> send_verify_email</span><span class="pun">(</span><span class="pln">to_email</span><span class="pun">,</span><span class="pln"> verify_url</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    subject </span><span class="pun">=</span><span class="pln"> </span><span class="str">"美多商城邮箱验证"</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    html_message </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;p&gt;尊敬的用户您好！&lt;/p&gt;'</span><span class="pln"> \</span></code></li><li class="L4"><code><span class="pln">                   </span><span class="str">'&lt;p&gt;感谢您使用美多商城。&lt;/p&gt;'</span><span class="pln"> \</span></code></li><li class="L5"><code><span class="pln">                   </span><span class="str">'&lt;p&gt;您的邮箱为：%s 。请点击此链接激活您的邮箱：&lt;/p&gt;'</span><span class="pln"> \</span></code></li><li class="L6"><code><span class="pln">                   </span><span class="str">'&lt;p&gt;&lt;a href="%s"&gt;%s&lt;a&gt;&lt;/p&gt;'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">to_email</span><span class="pun">,</span><span class="pln"> verify_url</span><span class="pun">,</span><span class="pln"> verify_url</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com"># 发送邮件</span></code></li><li class="L8"><code><span class="pln">    send_mail</span><span class="pun">(</span><span class="pln">subject</span><span class="pun">,</span><span class="pln"> </span><span class="str">""</span><span class="pun">,</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">EMAIL_FROM</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[</span><span class="pln">to_email</span><span class="pun">],</span><span class="pln"> html_message</span><span class="pun">=</span><span class="pln">html_message</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>把函数变为任务函数</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="lit">@celery_app</span><span class="pun">.</span><span class="pln">task</span><span class="pun">(</span><span class="pln">name</span><span class="pun">=</span><span class="str">'send_verify_email'</span><span class="pun">)</span></code></li><li class="L1"><code><span class="kwd">def</span><span class="pln"> send_verify_email</span><span class="pun">(</span><span class="pln">to_email</span><span class="pun">,</span><span class="pln"> verify_url</span><span class="pun">):</span></code></li></ol></pre></li>
<li><p>在main中</p>

<ol><li>加载django环境</li>
<li>注册任务</li></ol>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">import</span><span class="pln"> os</span></code></li><li class="L1"><code><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> os</span><span class="pun">.</span><span class="pln">getenv</span><span class="pun">(</span><span class="str">'DJANGO_SETTINGS_MODULE'</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">    os</span><span class="pun">.</span><span class="pln">environ</span><span class="pun">[</span><span class="str">'DJANGO_SETTINGS_MODULE'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">'meiduo_mall.settings.dev'</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pun">...</span><span class="pln"> </span><span class="com"># 创建并配置 Celery对象</span></code></li><li class="L5"><code></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="com"># 自动注册celery任务</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">celery_app</span><span class="pun">.</span><span class="pln">autodiscover_tasks</span><span class="pun">([</span><span class="str">'celery_tasks.sms'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'celery_tasks.emails'</span><span class="pun">])</span></code></li></ol></pre></li>
<li><p>在序列化器中调用任务函数发送任务 <br>
下节课</p></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="9n3w" id="07生成验证链接并发送邮件及前端编写">07_生成验证链接并发送邮件及前端编写</h2><ul data-anchor-id="wv61">
<li><p>后端</p>

<ol><li><p>在用户模型上添加获取邮箱激活url的方法</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">User</span><span class="pun">(</span><span class="typ">AbstractUser</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> generate_email_verify_url</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">        </span><span class="str">"""生成邮箱验证链接"""</span></code></li><li class="L3"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TJWSSerializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> expires_in</span><span class="pun">=</span><span class="pln">constants</span><span class="pun">.</span><span class="pln">EMAIL_VERIFY_TOKEN_EXPIRES</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        data </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'user_id'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">id</span><span class="pun">,</span><span class="pln"> </span><span class="str">'email'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">email</span><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">        token </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">dumps</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        verify_url </span><span class="pun">=</span><span class="pln"> </span><span class="str">'http://www.meiduo.site:8080/success_verify_email.html?token='</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> token</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">()</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> verify_url</span></code></li></ol></pre></li>
<li><p>在序列化器中获得邮箱激活url 并 调用任务函数发送邮件</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">def</span><span class="pln"> update</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> instance</span><span class="pun">,</span><span class="pln"> validated_data</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">...</span><span class="pln">    </span></code></li><li class="L2"><code><span class="pln">    </span><span class="com"># 生成激活链接</span></code></li><li class="L3"><code><span class="pln">    verify_url </span><span class="pun">=</span><span class="pln"> instance</span><span class="pun">.</span><span class="pln">generate_email_verify_url</span><span class="pun">()</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com"># 发送验证邮件</span></code></li><li class="L5"><code><span class="pln">    send_verify_email</span><span class="pun">.</span><span class="pln">delay</span><span class="pun">(</span><span class="pln">email</span><span class="pun">,</span><span class="pln"> verify_url</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> instance</span></code></li></ol></pre></li></ol></li>
<li><p>前端</p>

<ul><li>点击"保存"、"重新发送" <br>
<ol><li>验证email的格式合法性</li>
<li>通过后 <br>
<ol><li>调用接口发送邮件</li>
<li>得到结果</li></ol></li></ol></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="3cm0" id="08验证邮箱的业务实现">08_验证邮箱的业务实现</h2><ul data-anchor-id="yvpk">
<li><p>后端实现</p>

<ul><li><p>users.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">EmailVerifyView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""邮箱验证"""</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 获取token</span></code></li><li class="L4"><code><span class="pln">        token </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">query_params</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'token'</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> token</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">"message"</span><span class="pun">:</span><span class="str">'缺少token'</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_400_BAD_REQUEST</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 校验  保存</span></code></li><li class="L9"><code><span class="pln">        result </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="pln">check_email_verify_token</span><span class="pun">(</span><span class="pln">token</span><span class="pun">)</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> result</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">"message"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"OK"</span><span class="pun">})</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">"非法的token"</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_400_BAD_REQUEST</span><span class="pun">)</span></code></li></ol></pre></li>
<li><p>users.models.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="lit">@staticmethod</span></code></li><li class="L1"><code><span class="kwd">def</span><span class="pln"> check_email_verify_token</span><span class="pun">(</span><span class="pln">token</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">    </span><span class="str">"""检验token"""</span></code></li><li class="L3"><code><span class="pln">    serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TJWSSerializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> expires_in</span><span class="pun">=</span><span class="pln">constants</span><span class="pun">.</span><span class="pln">EMAIL_VERIFY_TOKEN_EXPIRES</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">        data </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">token</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">    </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">BadData</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">False</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">        email </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'email'</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        user_id </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">"user_id"</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># user = User.objects.get(id=user_id, email=email)</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># user.email_active = True</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># user.save()</span></code></li><li class="L5"><code><span class="pln">        </span><span class="typ">User</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">id</span><span class="pun">=</span><span class="pln">user_id</span><span class="pun">,</span><span class="pln"> email</span><span class="pun">=</span><span class="pln">email</span><span class="pun">).</span><span class="pln">update</span><span class="pun">(</span><span class="pln">email_active</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">True</span></code></li></ol></pre></li>
<li><p>users.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^emails/verification/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">EmailVerifyView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span><span class="pln">  </span><span class="com"># 用户个人中心数据</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li></ul></li>
<li><p>前端实现</p>

<ol><li>获得 token</li>
<li>访问后端接口</li>
<li>根据结果进行页面展示</li></ol></li>
<li><p>测试</p>

<ol><li>前端</li>
<li>看数据库</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="u9ni" id="09创建省市区数据库及编写导入脚本">09_创建省市区数据库及编写导入脚本</h2><ul data-anchor-id="t7j5">
<li><p>收货地址</p>

<ul><li>业务逻辑 <br>
一个用户 多个地址 <br>
默认地址有一个 <br>
增删改查地址</li></ul></li>
<li><p>模型 <br>
先准备省市县数据</p>

<ul><li><p>省市县模型</p>

<ul><li>自关联</li>
<li>单独的areas应用 <br>
<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">Area</span><span class="pun">(</span><span class="pln">models</span><span class="pun">.</span><span class="typ">Model</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    行政区划</span></code></li><li class="L3"><code><span class="str">    """</span></code></li><li class="L4"><code><span class="pln">    name </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'名称'</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    parent </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="str">'self'</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">SET_NULL</span><span class="pun">,</span><span class="pln"> related_name</span><span class="pun">=</span><span class="str">'subs'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> blank</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'上级行政区划'</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">        db_table </span><span class="pun">=</span><span class="pln"> </span><span class="str">'tb_areas'</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> __str__</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">name</span></code></li></ol></pre></li></ul></li>
<li><p>数据迁移</p></li>
<li><p>添加省市县数据</p>

<ul><li>source 导入数据的第一种方式 <br>
先切换到sql脚本所在目录 <br>
进入mysql <br>
source sql脚本名称</li>
<li>shell脚本 导入数据的第二种方式 <br>
命令 <code>mysql -h数据库ip -p数据库端口 -u用户名 -p密码 要插入的库 &lt; 包含sql语句的sql脚本路径</code> <br>
把命令放入.sh文件 <br>
前面加上#!/bin/bash <br>
添加.sh的可执行权限</li></ul></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="tcir" id="10python脚本添加解释器声明的方法">10_python脚本添加解释器声明的方法</h2><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="hes0"><ol class="linenums"><li class="L0"><code><span class="com">#!/usr/bin/evn python</span></code></li><li class="L1"><code><span class="com"># 上面的语句表明这个脚本是用python程序进行</span></code></li><li class="L2"><code><span class="pun">定义</span><span class="pln">python</span><span class="pun">语句</span></code></li><li class="L3"><code><span class="kwd">print</span><span class="pun">(</span><span class="str">"hello"</span><span class="pun">)</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="s9fm" id="11省市区视图集的编写">11_省市区视图集的编写</h2><ul data-anchor-id="1rhs">
<li>设计 <br>
<ol><li>获得所有的省 <br>
<ul><li>请求 GET /areas/</li>
<li>响应 {"id":id,"name":name}</li></ul></li>
<li>获得某个区域及下属的关联区域 <br>
<ul><li>请求 GET /areas/{id}/</li>
<li>响应 {"id":id,"name":name,"sub":[{"id":id,"name":name},{"id":id,"name":name},{"id":id,"name":name}]}</li></ul></li></ol></li>
<li><p>实现</p>

<ul><li><p>ares.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">AreasViewSet</span><span class="pun">(</span><span class="pln"> </span><span class="typ">ReadOnlyModelViewSet</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    list:</span></code></li><li class="L3"><code><span class="str">    返回所有省份的信息</span></code></li><li class="L4"><code><span class="str">    retrieve:</span></code></li><li class="L5"><code><span class="str">    返回特定省或市的下属行政规划区域</span></code></li><li class="L6"><code><span class="str">    """</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    </span><span class="com"># queryset = Area.objects.all()</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> get_queryset</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">action </span><span class="pun">==</span><span class="pln"> </span><span class="str">'list'</span><span class="pun">:</span><span class="pln"> </span><span class="com"># 如果是list请求，返回的是父级区域为空的区域</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Area</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">filter</span><span class="pun">(</span><span class="pln">parent</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span><span class="pln"> </span><span class="com"># 如果是retrieve请求，返回的是所有，由视图集来控制传入的主键，过滤出特定区域</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Area</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">all</span><span class="pun">()</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> get_serializer_class</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">action </span><span class="pun">==</span><span class="pln"> </span><span class="str">'list'</span><span class="pun">:#</span><span class="pln"> </span><span class="pun">如果是</span><span class="pln">list</span><span class="pun">请求，返回的</span><span class="typ">AreaSerialier</span><span class="pun">(没有</span><span class="kwd">sub</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">AreaSerialier</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span><span class="pln"> </span><span class="com"># 如果是retrieve请求，返回的SubAreaSerializer(有sub)</span></code></li><li class="L0"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">SubAreaSerializer</span></code></li><li class="L1"><code></code></li></ol></pre></li>
<li><p>ares.serializers.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">AreaSerialier</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">ModelSerializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""行政区域信息序列化器"""</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">        model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Area</span></code></li><li class="L4"><code><span class="pln">        fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'name'</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">SubAreaSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">ModelSerializer</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L9"><code><span class="str">    子级行政区划信息</span></code></li><li class="L0"><code><span class="str">    """</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># sub怎么来的? 我们在定义外键关联的时候指定了 related_name选项为sub代替了默认的area_set</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com"># 如果不定义，则返回的是主键列表</span></code></li><li class="L3"><code><span class="pln">    subs </span><span class="pun">=</span><span class="pln"> </span><span class="typ">AreaSerialier</span><span class="pun">(</span><span class="pln">many</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> read_only</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">        model </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Area</span></code></li><li class="L7"><code><span class="pln">        fields </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="str">'id'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'name'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'subs'</span><span class="pun">)</span></code></li></ol></pre></li>
<li>ares.urls.py</li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="60qf" id="12省市区添加缓存的方式">12_省市区添加缓存的方式</h2><ul data-anchor-id="mezc">
<li><p>缓存 <br>
以空间换时间的一种方式，来提高系统性能</p></li>
<li><p>缓存省市县数据 <br>
省市县数据频繁访问，但变化很少，所以可以缓存</p></li>
<li><p>drf-extensions <br>
可以很方便的缓存 rest_framework的数据</p>

<ul><li><p>使用步骤</p>

<ol><li>安装 <br>
<code>pip install drf-extensions</code></li>
<li><p>配置</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">REST_FRAMEWORK_EXTENSIONS </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># 缓存时间</span></code></li><li class="L2"><code><span class="pln">    </span><span class="str">'DEFAULT_CACHE_RESPONSE_TIMEOUT'</span><span class="pun">:</span><span class="pln"> </span><span class="lit">60</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">60</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com"># 缓存存储</span></code></li><li class="L4"><code><span class="pln">    </span><span class="str">'DEFAULT_USE_CACHE'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'default'</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pun">}</span></code></li></ol></pre></li>
<li><p>在视图上使用</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> rest_framework_extensions</span><span class="pun">.</span><span class="pln">cache</span><span class="pun">.</span><span class="pln">mixins </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">CacheResponseMixin</span></code></li><li class="L1"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">AreasViewSet</span><span class="pun">(</span><span class="typ">CacheResponseMixin</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ReadOnlyModelViewSet</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">pass</span></code></li></ol></pre></li>
<li><p>效果查看</p></li></ol></li></ul></li>
<li>课外阅读 <br>
原生的django缓存 <br>
<a href="https://yiyibooks.cn/xx/Django_1.11.6/topics/cache.html" target="_blank">https://yiyibooks.cn/xx/Django_1.11.6/topics/cache.html</a></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="kqp7" id="13用户地址模型类说明及省市区三级联动分页重置">13_用户地址模型类说明及省市区三级联动分页重置</h2><ul data-anchor-id="y1sp">
<li><p>地址模型 <br>
users.models.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code></code></li><li class="L1"><code><span class="com"># 继承于BaseModel，添加add_time 和 update_time</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">Address</span><span class="pun">(</span><span class="typ">BaseModel</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L5"><code><span class="str">    用户地址</span></code></li><li class="L6"><code><span class="str">    """</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com"># 一个用户可能有多个地址</span></code></li><li class="L8"><code><span class="pln">    user </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="typ">User</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">CASCADE</span><span class="pun">,</span><span class="pln"> related_name</span><span class="pun">=</span><span class="str">'addresses'</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'用户'</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">    title </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'地址名称'</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">    receiver </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'收货人'</span><span class="pun">)</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">    </span><span class="com"># 省市县关联到 area表</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com"># 外键关联其他应用中的模型，需要指定应用名称</span></code></li><li class="L4"><code><span class="pln">    province </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="str">'areas.Area'</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">PROTECT</span><span class="pun">,</span><span class="pln"> related_name</span><span class="pun">=</span><span class="str">'province_addresses'</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'省'</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    city </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="str">'areas.Area'</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">PROTECT</span><span class="pun">,</span><span class="pln"> related_name</span><span class="pun">=</span><span class="str">'city_addresses'</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'市'</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">    district </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="str">'areas.Area'</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">PROTECT</span><span class="pun">,</span><span class="pln"> related_name</span><span class="pun">=</span><span class="str">'district_addresses'</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'区'</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    place </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">50</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'地址'</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">    mobile </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'手机'</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">    tel </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> blank</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">default</span><span class="pun">=</span><span class="str">''</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'固定电话'</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">    email </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">30</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> blank</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">default</span><span class="pun">=</span><span class="str">''</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'电子邮箱'</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">    is_deleted </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">BooleanField</span><span class="pun">(</span><span class="kwd">default</span><span class="pun">=</span><span class="kwd">False</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'逻辑删除'</span><span class="pun">)</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">        db_table </span><span class="pun">=</span><span class="pln"> </span><span class="str">'tb_address'</span></code></li><li class="L6"><code><span class="pln">        verbose_name </span><span class="pun">=</span><span class="pln"> </span><span class="str">'用户地址'</span></code></li><li class="L7"><code><span class="pln">        verbose_name_plural </span><span class="pun">=</span><span class="pln"> verbose_name</span></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 指明默认的排序依据，按照修改时间排序</span></code></li><li class="L9"><code><span class="pln">        ordering </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="str">'-update_time'</span><span class="pun">]</span></code></li></ol></pre></li>
<li><p>关闭地址查询的分页功能 <br>
GenericAPIView会默认加载项目的分页配置，如果某个视图不想使用分页应该</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">AreasViewSet</span><span class="pun">(</span><span class="pln"> </span><span class="typ">ReadOnlyModelViewSet</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com"># 关闭分页处理</span></code></li><li class="L2"><code><span class="pln">    pagination_class </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">None</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="35uj" id="14用户默认地址补充说明">14_用户默认地址补充说明</h2><ul data-anchor-id="8lac">
<li><p>默认地址</p>

<ul><li>两种方案 <br>
<ol><li>字段在地址上(布尔)</li>
<li>字段在用户上(外键)</li></ol></li>
<li>两种方案比较 <br>
<ol><li>字段在地址上 <br>
因为用户和地址是一对多的，这种结构可能导致一个用户有多个默认地址 <br>
或者 需要在代码中小心维护</li>
<li>字段在用户上 <br>
一个用户最多有一个默认地址(可能没有设置)</li></ol></li>
<li>方案选取 <br>
默认地址字段在用户上(外键)</li>
<li><p>实现</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">User</span><span class="pun">(</span><span class="typ">AbstractUser</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""用户模型类"""</span></code></li><li class="L2"><code><span class="pln">    default_address </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="str">'Address'</span><span class="pun">,</span><span class="pln"> related_name</span><span class="pun">=</span><span class="str">'users'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> blank</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">SET_NULL</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'默认地址'</span><span class="pun">)</span></code></li></ol></pre></li></ul></li>
</ul></div>
<a href="10.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="12.html">下一页</a>
</body>
</html>