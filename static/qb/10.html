<!DOCTYPE html>
<html class="theme theme-white">
<head>
<meta charset="utf-8">
    <a href="9.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="11.html">下一页</a>
<title>Django-4.0-Day10</title>
<link href="https://www.zybuluo.com/static/assets/template-theme-white.css" rel="stylesheet" media="screen">
<style type="text/css">

#wmd-preview h1  {
    color: #0077bb; /* 将标题改为蓝色 */
}</style>
</head>
<body class="theme theme-white">
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="masx" id="django-40-day10">Django-4.0-Day10</h1><p data-anchor-id="f6xq"><code>django</code></p><hr><div class="md-section-divider"></div><h2 data-anchor-id="l4fu" id="知识点复习">知识点复习</h2><ul data-anchor-id="ngk5">
<li><p>业务</p>

<ul><li>登录 <br>
<ul><li>用户名密码登录</li>
<li>支持手机号登录</li></ul></li>
<li>忘记密码业务 <br>
4个大步骤(界面) <br>
5个小步骤(前后端的交互过程) <br>
安全!安全!安全!</li></ul></li>
<li><p>技能点</p>

<ul><li>新 <br>
<ul><li><strong>跨域请求</strong> <br>
<ul><li>概念(域)</li>
<li>原理(HTTP相关请求响应头)</li>
<li>解决(corsheaders)</li></ul></li>
<li><strong>jwt</strong> <br>
<ul><li>概念 <br>
<ul><li>作用 防止凭据被篡改，还可还原</li>
<li>三个部分</li></ul></li>
<li>第三方库 <br>
<ul><li><strong>itsdangerous</strong> <br>
生成和校验各种各样用途的jwt的</li>
<li>rest_framework_jwt <br>
对django的用户模型，返回jwt，并能够进行认证 <br>
<ul><li>三个注意使用场景 <br>
<ol><li>创建登录令牌</li>
<li>登录视图 (还可重写返回信息)</li>
<li>认证(后面会用到)</li></ol></li></ul></li></ul></li></ul></li>
<li>前端存储 <br>
<ul><li>localStorage</li>
<li>sessionStorage</li></ul></li></ul></li>
<li>旧 <br>
<ul><li><strong>序列化器</strong> <br>
<ul><li>校验数据 <br>
<ul><li>单个</li>
<li>多个</li>
<li>元选项 extra_kwargs </li></ul></li>
<li>数据保存</li></ul></li>
<li><strong>视图</strong> <br>
<ul><li>APIView</li>
<li>GenericAPIVIew</li></ul></li></ul></li>
<li>扩展 <br>
<ul><li>django配置 <br>
ALLOWED_HOSTS</li>
<li>django的登录认证机制</li></ul></li>
<li>杂 <br>
<ul><li>hosts/dns</li>
<li>pycharm js提示</li>
<li>git拉取远端分支</li></ul></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="ht1f" id="01qq第三方登录业务说明与申请说明">01_QQ第三方登录业务说明与申请说明</h2><ul data-anchor-id="70gy">
<li><p>第三方登录 <br>
使用一些用户非常广的网站(QQ、微博、google、fb、...)的账号体系，免去用户注册的功能，提升用户体验。 <br>
以QQ登录为例进行操作</p></li>
<li><p>QQ登录在美多商城的关键点</p>

<ol><li>每次用户使用了QQ登录，可以获得一个openid</li>
<li>需要判断openid是否第一次出现，如果第一次就需要绑定账号，登录成功</li>
<li>如果openid已经绑定过了，直接登录成功</li></ol></li>
<li><p>QQ登录的基本步骤</p>

<ol><li>注册成为腾讯开发者账号，并通过审核 <br>
<a href="https://connect.qq.com/" target="_blank">https://connect.qq.com/</a></li>
<li>创建应用，并通过审核，可以得到一个appid 和appkey <br>
<a href="https://connect.qq.com/manage.html" target="_blank">https://connect.qq.com/manage.html</a></li>
<li>下载sdk进行接入 <br>
<a href="http://wiki.connect.qq.com/sdk%E4%B8%8B%E8%BD%BD" target="_blank">http://wiki.connect.qq.com/sdk%E4%B8%8B%E8%BD%BD</a> <br>
如果没有对应语言的官方sdk，就需要第三方开发的开源sdk，或者自己去实现接口调用</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="wqcc" id="02使用qq登录的时序图说明">02_使用QQ登录的时序图说明</h2><p data-anchor-id="aedm">非常重要，后面的代码就是根据这个图来进行的</p><p data-anchor-id="z2bi"><img src="http://static.zybuluo.com/jsutqb/m5tv1fo9phvcpxo2m49w9th2/image_1chfmm4nc9s02d9prroff1kcn9.png" alt="image_1chfmm4nc9s02d9prroff1kcn9.png-167.9kB"></p><ul data-anchor-id="zdpk">
<li>我们要完成的功能 <br>
<ol><li>得到qq登录的网址(后端)</li>
<li>准备一个回调地址(前端)，接受code，并发送给后端</li>
<li>准备一个与qq通讯的后端，传过去code，得到access_token(qq)，并得到openid</li>
<li>准备一个绑定账号的页面</li>
<li>准备一个绑定账号对应的后端</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="nzrb" id="03创建qq登录的模型类">03_创建QQ登录的模型类</h2><ul data-anchor-id="kmlx">
<li><p>需求 <br>
QQ登录，我们可以得到openid，但不应该直接在当前的用户模型类上添加openid字段 <br>
因为后期可能有其他的第三方登录接入进来，就又需要添加字段了 <br>
考虑到扩展性，我们需要定义一个一对一的关联模型 <br>
又因为我们想要知道何时注册的，所以需要一个create_time字段 <br>
又想知道合适更新的，有需要一个update_time字段</p></li>
<li><p>步骤</p>

<ol><li><p>添加抽象模型类 BaseModel <br>
用于给模型添加上create_date、update_date字段 <br>
utils.models.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">BaseModel</span><span class="pun">(</span><span class="pln">models</span><span class="pun">.</span><span class="typ">Model</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""为模型类补充字段"""</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com">#auto_now_add 创建模型的时候自动添加当前时间作为字段的值</span></code></li><li class="L3"><code><span class="pln">    create_time </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">DateTimeField</span><span class="pun">(</span><span class="pln">auto_now_add</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"创建时间"</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com">#auto_now 更新模型的时候自动添加当前时间作为字段的值</span></code></li><li class="L5"><code><span class="pln">    update_time </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">DateTimeField</span><span class="pun">(</span><span class="pln">auto_now</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">"更新时间"</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">abstract</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">True</span><span class="pln">  </span><span class="com"># 说明是抽象模型类, 用于继承使用，数据库迁移时不会创建BaseModel的表</span></code></li></ol></pre></li>
<li><p>添加QQ登录的模型</p>

<ul><li>创建oauth应用</li>
<li>注册oauth应用</li>
<li><p>编写模型代码 <br>
apps.oauth.models.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">db </span><span class="kwd">import</span><span class="pln"> models</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> meiduo_mall</span><span class="pun">.</span><span class="pln">utils</span><span class="pun">.</span><span class="pln">models </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">BaseModel</span></code></li><li class="L2"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQUser</span><span class="pun">(</span><span class="typ">BaseModel</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L4"><code><span class="str">    QQ登录用户数据</span></code></li><li class="L5"><code><span class="str">    """</span></code></li><li class="L6"><code><span class="pln">    </span><span class="com"># 进行外键关联的时候如果不是用一个应用，需要指定模型所在的应用名</span></code></li><li class="L7"><code><span class="pln">    user </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">ForeignKey</span><span class="pun">(</span><span class="str">'users.User'</span><span class="pun">,</span><span class="pln"> on_delete</span><span class="pun">=</span><span class="pln">models</span><span class="pun">.</span><span class="pln">CASCADE</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'用户'</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">    openid </span><span class="pun">=</span><span class="pln"> models</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">max_length</span><span class="pun">=</span><span class="lit">64</span><span class="pun">,</span><span class="pln"> verbose_name</span><span class="pun">=</span><span class="str">'openid'</span><span class="pun">,</span><span class="pln"> db_index</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">Meta</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">        db_table </span><span class="pun">=</span><span class="pln"> </span><span class="str">'tb_oauth_qq'</span></code></li><li class="L1"><code><span class="pln">        verbose_name </span><span class="pun">=</span><span class="pln"> </span><span class="str">'QQ登录用户数据'</span></code></li><li class="L2"><code><span class="pln">        verbose_name_plural </span><span class="pun">=</span><span class="pln"> verbose_name</span></code></li></ol></pre></li>
<li><p>进行数据迁移 <br>
<code>python manage.py makemigrations <br>
python manage.py migrate</code></p></li></ul></li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="kk97" id="04关于程序中细节可能导致的错误说明和urllib模块使用方法">04_关于程序中细节可能导致的错误说明和urllib模块使用方法</h2><ul data-anchor-id="bts3">
<li>urls <br>
注意添加^ 和 $ 是好习惯</li>
<li><p>元组 <br>
元组如果只有一个元素，注意添加额外的逗号</p></li>
<li><p>urllib模块使用 <br>
进行http请求的，后面用于和qq的服务器通讯</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> urllib </span><span class="kwd">import</span><span class="pln"> parse </span><span class="pun">,</span><span class="pln">request</span><span class="pun">,</span><span class="pln">response</span></code></li><li class="L1"><code><span class="pln"> </span><span class="com"># 参数是字段，返回值是用于url中? 后面的内容</span></code></li><li class="L2"><code><span class="pln"> </span><span class="com"># {"a":1,"b":"c"} -&gt; "a=1&amp;b=c"</span></code></li><li class="L3"><code><span class="pln">query_params </span><span class="pun">=</span><span class="pln">parse</span><span class="pun">.</span><span class="pln">urlencode</span><span class="pun">(</span><span class="pln">query</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln"> </span><span class="com"># 与上面的方法正好相反</span></code></li><li class="L5"><code><span class="pln"> </span><span class="com"># a=1&amp;b=c  -&gt;  {"a":["1"],"b":["c"]}</span></code></li><li class="L6"><code><span class="pln"> </span><span class="com"># 注意 1 都当作字符串  2 value是列表</span></code></li><li class="L7"><code><span class="pln">d </span><span class="pun">=</span><span class="pln"> parse</span><span class="pun">.</span><span class="pln">parse_qs</span><span class="pun">(</span><span class="pln">qs</span><span class="pun">)</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln"> </span><span class="com"># 访问指定地址，如果data是None就使用get访问，如果不为空，则使用post访问，并把data当作请求体</span></code></li><li class="L0"><code><span class="pln"> </span><span class="com"># 得到的返回值是响应</span></code></li><li class="L1"><code><span class="pln">resp </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">urlopen</span><span class="pun">(</span><span class="pln">url</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln"> </span><span class="com"># 调用响应的read方法可以的到响应体，注意类型是bytes</span></code></li><li class="L4"><code><span class="pln">b </span><span class="pun">=</span><span class="pln">resp</span><span class="pun">.</span><span class="pln">read</span><span class="pun">()</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="1w0v" id="05实现返回qq登录网址的后端接口说明">05_实现返回QQ登录网址的后端接口说明</h2><div class="md-section-divider"></div><h2 data-anchor-id="w7l5" id="06实现返回qq登录网址的后端接口">06_实现返回QQ登录网址的后端接口</h2><ul data-anchor-id="5heo">
<li><p>需求 <br>
前端点击"QQ登录" 后 向后端进行请求 得到一个 登录qq的网页的是地址</p></li>
<li><p>设计</p>

<ul><li>基本 <br>
<ul><li>请求  GET /oauth/qq/authorization/</li>
<li>响应  {"auth_url":auth_url}</li></ul></li>
<li>优化用户体验 <br>
让用户登录后能跳转到登陆前的地址 <br>
<ul><li>请求  GET /oauth/qq/authorization/?state={登录前的路径}</li>
<li>响应  {"auth_url":auth_url} <br>
需要使用到qq文档中的state参数</li></ul></li></ul></li>
<li><p>实现</p>

<ul><li>参考qq文档 <br>
<a href="http://wiki.connect.qq.com/%E4%BD%BF%E7%94%A8authorization_code%E8%8E%B7%E5%8F%96access_token" target="_blank">http://wiki.connect.qq.com/%E4%BD%BF%E7%94%A8authorization_code%E8%8E%B7%E5%8F%96access_token</a></li>
<li><p>使用urllib 拼接地址</p></li>
<li><p>实现细节</p>

<ul><li><p>oauth.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQURLView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    提供QQ登录的网址</span></code></li><li class="L3"><code><span class="str">    前端请求的接口网址  /oauth/qq/authorization/?state=xxxxxxx</span></code></li><li class="L4"><code><span class="str">    state参数是由前端传递，参数值为在QQ登录成功后，我们后端把用户引导到哪个美多商城页面</span></code></li><li class="L5"><code><span class="str">    """</span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 提取state参数</span></code></li><li class="L8"><code><span class="pln">        state </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">query_params</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'state'</span><span class="pun">,</span><span class="str">'/'</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 如果前端未指明，我们设置用户QQ登录成功后，跳转到主页</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="com"># 我们把QQ登录相关操作都提取到固定的地方</span></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 使用面向对象的方式是处理</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com"># 按照QQ的说明文档，拼接用户QQ登录的链接地址</span></code></li><li class="L4"><code><span class="pln">        oauth_qq </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OAuthQQ</span><span class="pun">(</span><span class="pln">state</span><span class="pun">=</span><span class="pln">state</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">        login_url </span><span class="pun">=</span><span class="pln"> oauth_qq</span><span class="pun">.</span><span class="pln">generate_qq_login_url</span><span class="pun">()</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 返回链接地址</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">"oauth_url"</span><span class="pun">:</span><span class="pln"> login_url</span><span class="pun">})</span></code></li></ol></pre></li>
<li><p>oauth.utils.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQ</span><span class="pun">(</span><span class="kwd">object</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    用户QQ登陆的工具类，</span></code></li><li class="L3"><code><span class="str">    提供了QQ登录可能使用的方法</span></code></li><li class="L4"><code><span class="str">    """</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> __init__</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> app_id</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> app_key</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> redirect_url</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> state</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">app_id </span><span class="pun">=</span><span class="pln"> app_id </span><span class="kwd">or</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">QQ_APP_ID</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">app_key </span><span class="pun">=</span><span class="pln"> app_key </span><span class="kwd">or</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">QQ_APP_KEY</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">redirect_url </span><span class="pun">=</span><span class="pln"> redirect_url </span><span class="kwd">or</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">QQ_REDIRECT_URL</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">state </span><span class="pun">=</span><span class="pln"> state </span><span class="kwd">or</span><span class="pln"> settings</span><span class="pun">.</span><span class="pln">QQ_STATE</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> generate_qq_login_url</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L3"><code><span class="str">        拼接用户QQ登录的链接地址</span></code></li><li class="L4"><code><span class="str">        :return: 链接地址</span></code></li><li class="L5"><code><span class="str">        """</span></code></li><li class="L6"><code><span class="pln">        url </span><span class="pun">=</span><span class="pln"> </span><span class="str">'https://graph.qq.com/oauth2.0/authorize?'</span></code></li><li class="L7"><code><span class="pln">        data </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">            </span><span class="str">'response_type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'code'</span><span class="pun">,</span></code></li><li class="L9"><code><span class="pln">            </span><span class="str">'client_id'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">app_id</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">            </span><span class="str">'redirect_uri'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">redirect_url</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">            </span><span class="str">'state'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">state</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">            </span><span class="str">'scope'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'get_user_info'</span><span class="pln">  </span><span class="com"># 获取用户的qq的openid</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L4"><code><span class="pln">        query_string </span><span class="pun">=</span><span class="pln"> urlencode</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln">  </span><span class="com">#  response_type=code&amp;client_id=xxxx&amp;redirect_uri=xxxxx&amp;....</span></code></li><li class="L5"><code><span class="pln">        url </span><span class="pun">+=</span><span class="pln"> query_string</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">print</span><span class="pun">(</span><span class="pln">url</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> url</span></code></li></ol></pre></li>
<li><p>dev</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com"># 用于QQ登录的配置信息</span></code></li><li class="L1"><code><span class="pln">QQ_APP_ID </span><span class="pun">=</span><span class="pln"> </span><span class="str">'101474184'</span></code></li><li class="L2"><code><span class="pln">QQ_APP_KEY </span><span class="pun">=</span><span class="pln"> </span><span class="str">'c6ce949e04e12ecc909ae6a8b09b637c'</span></code></li><li class="L3"><code><span class="pln">QQ_REDIRECT_URL </span><span class="pun">=</span><span class="pln"> </span><span class="str">'http://www.meiduo.site:8080/oauth_callback.html'</span></code></li><li class="L4"><code><span class="pln">QQ_STATE </span><span class="pun">=</span><span class="pln"> </span><span class="str">'/'</span></code></li></ol></pre></li>
<li><p>oauth.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^qq/authorization/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">OAuthQQURLView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span></code></li><li class="L2"><code><span class="pun">]</span><span class="pln"> </span></code></li></ol></pre></li></ul></li></ul></li>
<li><p>注意 <br>
该复制的地方复制，就算觉得自己能打对，万一错了耽误调试时间。</p></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="27g5" id="07获取qq登录网址的前端实现">07_获取QQ登录网址的前端实现</h2><ul data-anchor-id="481c">
<li>点击事件 <br>
<ol><li>拿到当前页面的next </li>
<li>使用axios 发起请求</li>
<li>成功得到oauth_url后 location.href = oauth_url </li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="ve65" id="08回调地址页面展示及后续处理逻辑分析">08_回调地址页面展示及后续处理逻辑分析</h2><div class="md-section-divider"></div><h2 data-anchor-id="q7xz" id="09凭借code获取accesstoken的实现">09_凭借code获取access_token的实现</h2><ul data-anchor-id="p39q">
<li><p>流程</p></li>
<li><p>准备callback前端页面</p>

<ol><li>默认显示"请稍候"</li>
<li>打开后会发送请求给后端(这节课未实现)</li>
<li>根据后端的响应(这节课未实现) <br>
<ul><li>如果第一次，则显示绑定界面</li>
<li>如果已经绑定过了，则存储登录数据，并跳转</li></ul></li></ol></li>
<li><p>实现后端</p>

<ul><li><p>流程</p>

<div class="mermaid sequence" title="点击查看大图" data-processed="true"><svg id="mermaidChart0" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:650px;" viewBox="-50 -10 650 601"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor0" x1="75" y1="5" x2="75" y2="590" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor1" x1="275" y1="5" x2="275" y2="590" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><g><line id="actor2" x1="475" y1="5" x2="475" y2="590" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="400" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="37.5" class="actor" style="text-anchor: middle;">腾讯 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">code</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="128" class="messageText" style="text-anchor: middle;">检查是否有code</text><path d="M 275,135 C 335,125 335,165 275,155" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="375" y="193" class="messageText" style="text-anchor: middle;">携带必要参数(code和其他)向qq服务器发起请求</text><line x1="275" y1="200" x2="475" y2="200" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="375" y="228" class="messageText" style="text-anchor: middle;">access_token_qq</text><line x1="475" y1="235" x2="275" y2="235" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="375" y="263" class="messageText" style="text-anchor: middle;">access_token_qq</text><line x1="275" y1="270" x2="475" y2="270" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="375" y="298" class="messageText" style="text-anchor: middle;">open_id</text><line x1="275" y1="305" x2="475" y2="305" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="333" class="messageText" style="text-anchor: middle;">(根据open_id查询User模型)</text><path d="M 275,340 C 335,330 335,370 275,360" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="398" class="messageText" style="text-anchor: middle;">检查是否已经绑定</text><path d="M 275,405 C 335,395 335,435 275,425" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="463" class="messageText" style="text-anchor: middle;">1未绑定:access_token_md</text><line x1="275" y1="470" x2="75" y2="470" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="498" class="messageText" style="text-anchor: middle;">2已绑定:token + username +user_id</text><line x1="275" y1="505" x2="75" y2="505" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><rect x="0" y="525" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="562.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="525" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="562.5" class="actor" style="text-anchor: middle;">后端 </text></g><g><rect x="400" y="525" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="562.5" class="actor" style="text-anchor: middle;">腾讯 </text></g></svg></div></li>
<li><p>设计</p>

<ul><li>请求 GET /oauth/qq/user/?code=xxx</li>
<li>响应 <br>
<ul><li>第一次  <br>
{"access_token":access_token} <br>
这个access_token不是qq给美多的，而是用于绑定账号时使用的</li>
<li>已绑定 <br>
{"token":token,"username":username,"user_id":user_id} <br>
这个token是rest_framework_jwt 的token</li></ul></li></ul></li>
<li><p>代码实现  <br>
本节课只实现到了 获取access_token_qq</p>

<ul><li><p>oauth.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> rest_framework</span><span class="pun">.</span><span class="pln">views </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">APIView</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> rest_framework</span><span class="pun">.</span><span class="pln">response </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Response</span></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> rest_framework </span><span class="kwd">import</span><span class="pln"> status</span></code></li><li class="L3"><code><span class="kwd">from</span><span class="pln"> </span><span class="pun">.</span><span class="pln">utils </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">OAuthQQ</span></code></li><li class="L4"><code><span class="kwd">from</span><span class="pln"> </span><span class="pun">.</span><span class="pln">exceptions </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">QQAPIException</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQUserView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L7"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L8"><code><span class="str">    获取QQ用户对应的美多商城用户</span></code></li><li class="L9"><code><span class="str">    """</span></code></li><li class="L0"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">        </span><span class="com"># 提取code参数</span></code></li><li class="L2"><code><span class="pln">        code </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">query_params</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'code'</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> code</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">"message"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"缺少code"</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_400_BAD_REQUEST</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 凭借code向QQ服务器发起请求，获取access_token</span></code></li><li class="L7"><code><span class="pln">        oauth_qq </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OAuthQQ</span><span class="pun">()</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">            access_token </span><span class="pun">=</span><span class="pln"> oauth_qq</span><span class="pun">.</span><span class="pln">get_access_token</span><span class="pun">(</span><span class="pln">code</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">QQAPIException</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'message'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'获取QQ用户数据异常'</span><span class="pun">},</span><span class="pln"> status</span><span class="pun">=</span><span class="pln">status</span><span class="pun">.</span><span class="pln">HTTP_503_SERVICE_UNAVAILABLE</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        </span><span class="com"># 还没写完</span></code></li></ol></pre></li>
<li><p>oauth.utils.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> urllib</span><span class="pun">.</span><span class="pln">parse </span><span class="kwd">import</span><span class="pln"> urlencode</span><span class="pun">,</span><span class="pln"> parse_qs</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> urllib</span><span class="pun">.</span><span class="pln">request </span><span class="kwd">import</span><span class="pln"> urlopen</span></code></li><li class="L2"><code><span class="kwd">import</span><span class="pln"> logging</span></code></li><li class="L3"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQ</span><span class="pun">(</span><span class="kwd">object</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> get_access_token</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> code</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L7"><code><span class="str">        获取qq的access_token</span></code></li><li class="L8"><code><span class="str">        :param code: 调用的凭据</span></code></li><li class="L9"><code><span class="str">        :return: access_token</span></code></li><li class="L0"><code><span class="str">        """</span></code></li><li class="L1"><code><span class="pln">        url </span><span class="pun">=</span><span class="pln"> </span><span class="str">'https://graph.qq.com/oauth2.0/token?'</span></code></li><li class="L2"><code><span class="pln">        req_data </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">            </span><span class="str">'grant_type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'authorization_code'</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">            </span><span class="str">'client_id'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">app_id</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">            </span><span class="str">'client_secret'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">app_key</span><span class="pun">,</span></code></li><li class="L6"><code><span class="pln">            </span><span class="str">'code'</span><span class="pun">:</span><span class="pln"> code</span><span class="pun">,</span></code></li><li class="L7"><code><span class="pln">            </span><span class="str">'redirect_uri'</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">redirect_url</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L9"><code><span class="pln">        url </span><span class="pun">+=</span><span class="pln"> urlencode</span><span class="pun">(</span><span class="pln">req_data</span><span class="pun">)</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">            </span><span class="com"># 发送请求</span></code></li><li class="L3"><code><span class="pln">            response </span><span class="pun">=</span><span class="pln"> urlopen</span><span class="pun">(</span><span class="pln">url</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">            </span><span class="com"># 读取QQ返回的响应体数据</span></code></li><li class="L5"><code><span class="pln">            </span><span class="com"># access_token=FE04************************CCE2&amp;expires_in=7776000&amp;refresh_token=88E4************************BE1</span></code></li><li class="L6"><code><span class="pln">            response </span><span class="pun">=</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">read</span><span class="pun">().</span><span class="pln">decode</span><span class="pun">()</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">            </span><span class="com"># 将返回的数据转换为字典</span></code></li><li class="L9"><code><span class="pln">            resp_dict </span><span class="pun">=</span><span class="pln"> parse_qs</span><span class="pun">(</span><span class="pln">response</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">            access_token </span><span class="pun">=</span><span class="pln"> resp_dict</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">"access_token"</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">Exception</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> e</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">            logger</span><span class="pun">.</span><span class="pln">error</span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> </span><span class="typ">QQAPIException</span><span class="pun">(</span><span class="str">'获取access_token异常'</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> access_token</span></code></li></ol></pre></li>
<li><p>oauth.exceptions.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">QQAPIException</span><span class="pun">(</span><span class="typ">Exception</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""QQAPI调用异常"""</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">pass</span></code></li></ol></pre></li></ul></li></ul></li>
<li><p>细节</p>

<ul><li>异常捕获 <br>
进行联网操作，其他主机可能不可用或者网络连接有问题 <br>
这时我们需要捕获异常</li>
<li>异常定义 <br>
我们有时候需要自定义一些异常来告知调用方出现了什么问题 <br>
最好还在异常对象上添加上错误原因信息 <br>
异常的定义很简单，继承于Exception即可 <br>
但我们要有这个意识</li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="wqzd" id="10凭借accesstoken获取openid的实现">10_凭借access_token获取openid的实现</h2><ul data-anchor-id="40d4">
<li><p>代码实现</p>

<ul><li><p>oauth.utils.py <br>
参见 <a href="http://wiki.connect.qq.com/%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7openid_oauth2-0" target="_blank">http://wiki.connect.qq.com/%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7openid_oauth2-0</a></p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code></code></li><li class="L1"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQ</span><span class="pun">(</span><span class="kwd">object</span><span class="pun">):</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> get_openid</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> access_token</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="str">        获取用户的openid</span></code></li><li class="L6"><code><span class="str">        :param access_token: qq提供的access_token</span></code></li><li class="L7"><code><span class="str">        :return: open_id</span></code></li><li class="L8"><code><span class="str">        """</span></code></li><li class="L9"><code><span class="pln">        url </span><span class="pun">=</span><span class="pln"> </span><span class="str">'https://graph.qq.com/oauth2.0/me?access_token='</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> access_token</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            response </span><span class="pun">=</span><span class="pln"> urlopen</span><span class="pun">(</span><span class="pln">url</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">            response_data </span><span class="pun">=</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">read</span><span class="pun">().</span><span class="pln">decode</span><span class="pun">()</span></code></li><li class="L3"><code><span class="pln">            </span><span class="com"># 返回的数据 callback( {"client_id":"YOUR_APPID","openid":"YOUR_OPENID"} )\n;</span></code></li><li class="L4"><code><span class="pln">            data </span><span class="pun">=</span><span class="pln"> json</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">response_data</span><span class="pun">[</span><span class="lit">10</span><span class="pun">:-</span><span class="lit">4</span><span class="pun">])</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">Exception</span><span class="pun">:</span></code></li><li class="L6"><code><span class="pln">            data </span><span class="pun">=</span><span class="pln"> parse_qs</span><span class="pun">(</span><span class="pln">response_data</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">            logger</span><span class="pun">.</span><span class="pln">error</span><span class="pun">(</span><span class="str">'code=%s msg=%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> </span><span class="pun">(</span><span class="pln">data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'code'</span><span class="pun">),</span><span class="pln"> data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'msg'</span><span class="pun">)))</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> </span><span class="typ">QQAPIException</span><span class="pun">(</span><span class="str">'获取openid异常'</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">        openid </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'openid'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> openid</span></code></li></ol></pre></li>
<li><p>oauth.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQUserView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    获取QQ用户对应的美多商城用户</span></code></li><li class="L3"><code><span class="str">    """</span></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">        </span><span class="com"># 之前的代码</span></code></li><li class="L6"><code><span class="pln">        openid </span><span class="pun">=</span><span class="pln"> oauth_qq</span><span class="pun">.</span><span class="pln">get_openid</span><span class="pun">(</span><span class="pln">access_token</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 根据openid查询此用户是否之前在美多中绑定或用户</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">            oauth_user </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OAuthQQUser</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">openid</span><span class="pun">=</span><span class="pln">openid</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">OAuthQQUser</span><span class="pun">.</span><span class="typ">DoesNotExist</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            </span><span class="com"># 如果未绑定</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">pass</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            </span><span class="com"># 如果已经绑定，</span></code></li><li class="L5"><code><span class="pln">            </span><span class="kwd">pass</span></code></li></ol></pre></li></ul></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="5fci" id="11根据openid判断用户是否绑定过做不同处理">11_根据openid判断用户是否绑定过做不同处理</h2><ul data-anchor-id="cg26">
<li><p>oauth.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQUserView</span><span class="pun">(</span><span class="typ">APIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    获取QQ用户对应的美多商城用户</span></code></li><li class="L3"><code><span class="str">    """</span></code></li><li class="L4"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> </span><span class="kwd">get</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">        </span><span class="com"># 之前的代码</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L7"><code><span class="pln">            oauth_user </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OAuthQQUser</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">openid</span><span class="pun">=</span><span class="pln">openid</span><span class="pun">)</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">OAuthQQUser</span><span class="pun">.</span><span class="typ">DoesNotExist</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">            </span><span class="com"># 如果未绑定，手动创建接下来绑定身份使用的access_token, 并返回</span></code></li><li class="L0"><code><span class="pln">            access_token </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OAuthQQUser</span><span class="pun">.</span><span class="pln">generate_save_user_token</span><span class="pun">(</span><span class="pln">openid</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span><span class="str">'access_token'</span><span class="pun">:</span><span class="pln"> access_token</span><span class="pun">})</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">            </span><span class="com"># 如果已经绑定，直接生成登录凭证 JWT token，并返回</span></code></li><li class="L4"><code><span class="pln">            </span><span class="com"># 手动为用户生成JWT token</span></code></li><li class="L5"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> oauth_user</span><span class="pun">.</span><span class="pln">user</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">            jwt_payload_handler </span><span class="pun">=</span><span class="pln"> api_settings</span><span class="pun">.</span><span class="pln">JWT_PAYLOAD_HANDLER</span></code></li><li class="L8"><code><span class="pln">            jwt_encode_handler </span><span class="pun">=</span><span class="pln"> api_settings</span><span class="pun">.</span><span class="pln">JWT_ENCODE_HANDLER</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">            payload </span><span class="pun">=</span><span class="pln"> jwt_payload_handler</span><span class="pun">(</span><span class="pln">user</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">            token </span><span class="pun">=</span><span class="pln"> jwt_encode_handler</span><span class="pun">(</span><span class="pln">payload</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span></code></li><li class="L3"><code><span class="pln">                </span><span class="str">'token'</span><span class="pun">:</span><span class="pln"> token</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">                </span><span class="str">'username'</span><span class="pun">:</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">username</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">                </span><span class="str">'user_id'</span><span class="pun">:</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span></code></li><li class="L6"><code><span class="pln">            </span><span class="pun">})</span></code></li></ol></pre></li>
<li><p>oauth.models.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">from</span><span class="pln"> itsdangerous </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">TimedJSONWebSignatureSerializer</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> </span><span class="typ">TJWSSerializer</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BadData</span></code></li><li class="L1"><code><span class="kwd">from</span><span class="pln"> django</span><span class="pun">.</span><span class="pln">conf </span><span class="kwd">import</span><span class="pln"> settings</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="kwd">from</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> </span><span class="kwd">import</span><span class="pln"> constants</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="com"># Create your models here.</span></code></li><li class="L6"><code></code></li><li class="L7"><code></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQUser</span><span class="pun">(</span><span class="typ">BaseModel</span><span class="pun">):</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">...</span></code></li><li class="L1"><code><span class="pln">    </span><span class="lit">@staticmethod</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> generate_save_user_token</span><span class="pun">(</span><span class="pln">openid</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TJWSSerializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> expires_in</span><span class="pun">=</span><span class="lit">600</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        data </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'openid'</span><span class="pun">:</span><span class="pln"> openid</span><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">        token </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">dumps</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> token</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">()</span></code></li></ol></pre></li>
<li><p>oauth.urls.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="pln">urlpatterns </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">    url</span><span class="pun">(</span><span class="pln">r</span><span class="str">'^qq/user/$'</span><span class="pun">,</span><span class="pln"> views</span><span class="pun">.</span><span class="typ">OAuthQQUserView</span><span class="pun">.</span><span class="pln">as_view</span><span class="pun">()),</span></code></li><li class="L2"><code><span class="pun">]</span></code></li></ol></pre></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="g5xt" id="12前端向后端传送code请求获取用户身份的编写">12_前端向后端传送code请求获取用户身份的编写</h2><ul data-anchor-id="4tna">
<li><p>整体逻辑</p>

<ul><li>页面加载(生命周期方法) <br>
<ol><li>从url中获取code</li>
<li>向后端发送获取 (access_token_md/user_id)的请求 <br>
<ul><li>判断结果 <br>
<ul><li>如果已绑定(有user_id) <br>
<ul><li>存储登录信息到localStorage</li>
<li>从url中获取state</li>
<li>跳转到state</li></ul></li>
<li>如果没有绑定 <br>
<ul><li>展示绑定界面</li></ul></li></ul></li></ul></li></ol></li></ul></li>
<li><p>两个小问题</p>

<ol><li>urllib.parse的parse_qs方法得到的字典的值是列表</li>
<li>qq登录后换取的code只能使用一次，并且有效期为10min</li></ol></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="hdxq" id="13绑定用户与openid的前后端处理">13_绑定用户与openid的前后端处理</h2><ul data-anchor-id="homw">
<li>流程</li>
</ul><div class="md-section-divider"></div><div class="mermaid sequence" title="点击查看大图" data-anchor-id="43en" data-processed="true"><svg id="mermaidChart1" width="100%" xmlns="http://www.w3.org/2000/svg" height="100%" style="max-width:567.5px;" viewBox="-75 -10 567.5 956"><style type="text/css" title="mermaid-svg-internal-css"> .actor { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} text.actor { fill: black; stroke: none;} .actor-line { stroke: grey;} .messageLine0 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} .messageLine1 { stroke-width: 1.5; stroke: rgb(51, 51, 51);} #arrowhead { fill: rgb(51, 51, 51);} #crosshead path { fill: rgb(51, 51, 51) !important; stroke: rgb(51, 51, 51) !important;} .messageText { fill: rgb(51, 51, 51); stroke: none;} .labelBox { stroke: rgb(204, 204, 255); fill: rgb(236, 236, 255);} .labelText { fill: black; stroke: none;} .loopText { fill: black; stroke: none;} .loopLine { stroke-width: 2; stroke: rgb(204, 204, 255);} .note { stroke: rgb(170, 170, 51); fill: rgb(255, 245, 173);} .noteText { fill: black; stroke: none; font-family: "trebuchet ms", verdana, arial; font-size: 14px;} </style><g></g><g><line id="actor3" x1="75" y1="5" x2="75" y2="945" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="37.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><line id="actor4" x1="275" y1="5" x2="275" y2="945" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="37.5" class="actor" style="text-anchor: middle;">后端 </text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0px, 0px;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0px, 0px;"></path></marker></defs><g><text x="175" y="93" class="messageText" style="text-anchor: middle;">image_code_id</text><line x1="75" y1="100" x2="275" y2="100" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="128" class="messageText" style="text-anchor: middle;">验证码图片</text><line x1="275" y1="135" x2="75" y2="135" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="163" class="messageText" style="text-anchor: middle;">image_code_id + text + mobile</text><line x1="75" y1="170" x2="275" y2="170" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="198" class="messageText" style="text-anchor: middle;">验证，通过发送短信</text><path d="M 275,205 C 335,195 335,235 275,225" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="263" class="messageText" style="text-anchor: middle;">ok</text><line x1="275" y1="270" x2="75" y2="270" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="175" y="298" class="messageText" style="text-anchor: middle;">mobile + password + sms_code + access_token_md</text><line x1="75" y1="305" x2="275" y2="305" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="275" y="333" class="messageText" style="text-anchor: middle;">校验access_token_md，通过可以拿到open_id</text><path d="M 275,340 C 335,330 335,370 275,360" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="398" class="messageText" style="text-anchor: middle;">校验短信验证码</text><path d="M 275,405 C 335,395 335,435 275,425" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="463" class="messageText" style="text-anchor: middle;">检查是否有此用户</text><path d="M 275,470 C 335,460 335,500 275,490" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="528" class="messageText" style="text-anchor: middle;">1没有:创建User,创建OAuthQQUser(open_id)</text><path d="M 275,535 C 335,525 335,565 275,555" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="593" class="messageText" style="text-anchor: middle;">1有:创建OAuthQQUser (open_id)</text><path d="M 275,600 C 335,590 335,630 275,620" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="275" y="658" class="messageText" style="text-anchor: middle;">生成token</text><path d="M 275,665 C 335,655 335,695 275,685" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="175" y="723" class="messageText" style="text-anchor: middle;">token + user_id + username</text><line x1="275" y1="730" x2="75" y2="730" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></line></g><g><text x="75" y="758" class="messageText" style="text-anchor: middle;">存储登录信息</text><path d="M 75,765 C 135,755 135,795 75,785" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><text x="75" y="823" class="messageText" style="text-anchor: middle;">跳转</text><path d="M 75,830 C 135,820 135,860 75,850" class="messageLine0" stroke-width="2" stroke="black" marker-end="url(#arrowhead)" style="fill: none;"></path></g><g><rect x="0" y="880" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="917.5" class="actor" style="text-anchor: middle;">前端 </text></g><g><rect x="200" y="880" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="917.5" class="actor" style="text-anchor: middle;">后端 </text></g></svg></div><ul data-anchor-id="mn0m">
<li><p>后端</p>

<ul><li>设计 <br>
<ul><li>请求 POST /oauth/qq/user/?mobile=<code>&lt;mobile&gt;</code>&amp;password=<code>&lt;password&gt;</code>&amp;sms_code=<code>&lt;sms_code&gt;</code>&amp;access_token=<code>&lt;access_token&gt;</code></li>
<li>响应 {"token":token,"user_id":user_id,"username":username}</li></ul></li>
<li><p>实现 <br>
注意：这里弱化了 mobile 和 username的区别(把手机号也当作用户名)</p>

<ul><li><p>oauth.views.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQUserView</span><span class="pun">(</span><span class="typ">GenericAPIView</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    serializer_class </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OAuthQQUserSerializer</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> post</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> request</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com"># 调用序列化器检查数据， 保存</span></code></li><li class="L5"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">get_serializer</span><span class="pun">(</span><span class="pln">data</span><span class="pun">=</span><span class="pln">request</span><span class="pun">.</span><span class="pln">data</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        serializer</span><span class="pun">.</span><span class="pln">is_valid</span><span class="pun">(</span><span class="pln">raise_exception</span><span class="pun">=</span><span class="kwd">True</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># 保存用户对象与openid的对应关系</span></code></li><li class="L9"><code><span class="pln">        user </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">save</span><span class="pun">()</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="com"># 返回用户登录成功的JWT token</span></code></li><li class="L2"><code><span class="pln">        jwt_payload_handler </span><span class="pun">=</span><span class="pln"> api_settings</span><span class="pun">.</span><span class="pln">JWT_PAYLOAD_HANDLER</span></code></li><li class="L3"><code><span class="pln">        jwt_encode_handler </span><span class="pun">=</span><span class="pln"> api_settings</span><span class="pun">.</span><span class="pln">JWT_ENCODE_HANDLER</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">        payload </span><span class="pun">=</span><span class="pln"> jwt_payload_handler</span><span class="pun">(</span><span class="pln">user</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">        token </span><span class="pun">=</span><span class="pln"> jwt_encode_handler</span><span class="pun">(</span><span class="pln">payload</span><span class="pun">)</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Response</span><span class="pun">({</span></code></li><li class="L9"><code><span class="pln">            </span><span class="str">'token'</span><span class="pun">:</span><span class="pln"> token</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">            </span><span class="str">'username'</span><span class="pun">:</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">username</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">            </span><span class="str">'user_id'</span><span class="pun">:</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">id</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">})</span></code></li></ol></pre></li>
<li><p>oauth.serializers.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQUserSerializer</span><span class="pun">(</span><span class="pln">serializers</span><span class="pun">.</span><span class="typ">Serializer</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    QQ登录创建用户序列化器</span></code></li><li class="L3"><code><span class="str">    """</span></code></li><li class="L4"><code><span class="pln">    access_token </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'操作凭证'</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">    mobile </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">RegexField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'手机号'</span><span class="pun">,</span><span class="pln"> regex</span><span class="pun">=</span><span class="pln">r</span><span class="str">'^1[3-9]\d{9}$'</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">    password </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'密码'</span><span class="pun">,</span><span class="pln"> max_length</span><span class="pun">=</span><span class="lit">20</span><span class="pun">,</span><span class="pln"> min_length</span><span class="pun">=</span><span class="lit">8</span><span class="pun">)</span></code></li><li class="L7"><code><span class="pln">    sms_code </span><span class="pun">=</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">CharField</span><span class="pun">(</span><span class="pln">label</span><span class="pun">=</span><span class="str">'短信验证码'</span><span class="pun">)</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> validate</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">):</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com"># 检验access_token</span></code></li><li class="L1"><code><span class="pln">        access_token </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">[</span><span class="str">'access_token'</span><span class="pun">]</span></code></li><li class="L2"><code><span class="pln">        openid </span><span class="pun">=</span><span class="pln"> </span><span class="typ">OAuthQQUser</span><span class="pun">.</span><span class="pln">check_save_user_token</span><span class="pun">(</span><span class="pln">access_token</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> openid</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'无效的access_token'</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="com"># 将openid保存到校验好的数据中，方便其他方式使用，</span></code></li><li class="L7"><code><span class="pln">        data</span><span class="pun">[</span><span class="str">'openid'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> openid</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">        </span><span class="com"># 检验短信验证码</span></code></li><li class="L0"><code><span class="pln">        mobile </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">[</span><span class="str">'mobile'</span><span class="pun">]</span></code></li><li class="L1"><code><span class="pln">        sms_code </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">[</span><span class="str">'sms_code'</span><span class="pun">]</span></code></li><li class="L2"><code><span class="pln">        redis_conn </span><span class="pun">=</span><span class="pln"> get_redis_connection</span><span class="pun">(</span><span class="str">'verify_codes'</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">        real_sms_code </span><span class="pun">=</span><span class="pln"> redis_conn</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'sms_%s'</span><span class="pln"> </span><span class="pun">%</span><span class="pln"> mobile</span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> real_sms_code</span><span class="pun">.</span><span class="pln">decode</span><span class="pun">()</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> sms_code</span><span class="pun">:</span></code></li><li class="L5"><code><span class="pln">            </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'短信验证码错误'</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="com"># 如果用户存在，检查用户密码</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">mobile</span><span class="pun">=</span><span class="pln">mobile</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="typ">DoesNotExist</span><span class="pun">:</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">pass</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">            password </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">[</span><span class="str">'password'</span><span class="pun">]</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> user</span><span class="pun">.</span><span class="pln">check_password</span><span class="pun">(</span><span class="pln">password</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">                </span><span class="kwd">raise</span><span class="pln"> serializers</span><span class="pun">.</span><span class="typ">ValidationError</span><span class="pun">(</span><span class="str">'密码错误'</span><span class="pun">)</span></code></li><li class="L6"><code><span class="pln">            data</span><span class="pun">[</span><span class="str">'user'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> user</span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> data</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> create</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> validated_data</span><span class="pun">):</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        user </span><span class="pun">=</span><span class="pln"> validated_data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'user'</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> user</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">            </span><span class="com"># 用户不存在</span></code></li><li class="L4"><code><span class="pln">            user </span><span class="pun">=</span><span class="pln"> </span><span class="typ">User</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">create_user</span><span class="pun">(</span></code></li><li class="L5"><code><span class="pln">                username</span><span class="pun">=</span><span class="pln">validated_data</span><span class="pun">[</span><span class="str">'mobile'</span><span class="pun">],</span></code></li><li class="L6"><code><span class="pln">                password</span><span class="pun">=</span><span class="pln">validated_data</span><span class="pun">[</span><span class="str">'password'</span><span class="pun">],</span></code></li><li class="L7"><code><span class="pln">                mobile</span><span class="pun">=</span><span class="pln">validated_data</span><span class="pun">[</span><span class="str">'mobile'</span><span class="pun">],</span></code></li><li class="L8"><code><span class="pln">            </span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com">#  保存用户user与qq openid的对应关系</span></code></li><li class="L0"><code><span class="pln">        </span><span class="typ">OAuthQQUser</span><span class="pun">.</span><span class="pln">objects</span><span class="pun">.</span><span class="pln">create</span><span class="pun">(</span></code></li><li class="L1"><code><span class="pln">            openid</span><span class="pun">=</span><span class="pln">validated_data</span><span class="pun">[</span><span class="str">'openid'</span><span class="pun">],</span></code></li><li class="L2"><code><span class="pln">            user</span><span class="pun">=</span><span class="pln">user</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">)</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> user</span></code></li></ol></pre></li>
<li><p>oauth.models.py</p>

<pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code><span class="kwd">class</span><span class="pln"> </span><span class="typ">OAuthQQUser</span><span class="pun">(</span><span class="typ">BaseModel</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="lit">@staticmethod</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> check_save_user_token</span><span class="pun">(</span><span class="pln">token</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L4"><code><span class="str">        检验保存用户数据的token</span></code></li><li class="L5"><code><span class="str">        :param token: token</span></code></li><li class="L6"><code><span class="str">        :return: openid or None</span></code></li><li class="L7"><code><span class="str">        """</span></code></li><li class="L8"><code><span class="pln">        serializer </span><span class="pun">=</span><span class="pln"> </span><span class="typ">TJWSSerializer</span><span class="pun">(</span><span class="pln">settings</span><span class="pun">.</span><span class="pln">SECRET_KEY</span><span class="pun">,</span><span class="pln"> expires_in</span><span class="pun">=</span><span class="pln">constants</span><span class="pun">.</span><span class="pln">SAVE_QQ_USER_TOKEN_EXPIRES</span><span class="pun">)</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">try</span><span class="pun">:</span></code></li><li class="L0"><code><span class="pln">            data </span><span class="pun">=</span><span class="pln"> serializer</span><span class="pun">.</span><span class="pln">loads</span><span class="pun">(</span><span class="pln">token</span><span class="pun">)</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">except</span><span class="pln"> </span><span class="typ">BadData</span><span class="pun">:</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">None</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">else</span><span class="pun">:</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> data</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'openid'</span><span class="pun">)</span></code></li></ol></pre></li></ul></li></ul></li>
<li><p>前端</p>

<ul><li>点击绑定 <br>
<ol><li>校验数据</li>
<li>发送请求 <br>
<ul><li>成功 <br>
<ol><li>获取登录信息，存储到localStorage</li>
<li>跳转</li></ol></li>
<li>失败 <br>
<ol><li>显示错误信息</li></ol></li></ul></li></ol></li></ul></li>
<li><p>测试 <br>
走界面 <br>
看数据库</p></li>
</ul></div>
<a href="9.html">上一页</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="11.html">下一页</a>
</body>
</html>